<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HEDU ‚Ä¢ C·ªïng th√¥ng tin nh√† tr∆∞·ªùng</title>
  <meta name="theme-color" content="#2563eb"/>

  <!-- Optional config.js: cung c·∫•p SCRIPT_URL, SCHOOL_NAME, APP_NAME... -->
  <script src="assets/config.js"></script>
  <script src="assets/api.js"></script>
  <style>
    :root{
      --bg:#f6f9ff;
      --ink:#0f172a;
      --muted:#475569;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --shadow: 0 18px 55px rgba(15,23,42,.12);
      --shadow2: 0 10px 28px rgba(15,23,42,.10);
      --radius: 24px;
      --max: 1140px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      position:relative;
      overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1100px 500px at 10% 20%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(59,130,246,.12), transparent 55%),
        linear-gradient(180deg, #f8fbff, var(--bg));
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background:url("assets/img/school-bg.jpg") center/cover no-repeat;
      filter:blur(14px);
      transform:scale(1.08);
      opacity:.22;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:linear-gradient(180deg, rgba(246,249,255,.92), rgba(246,249,255,.96));
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 18px 40px}

    .topbar{
      position:sticky; top:0; z-index:20;
      background:rgba(246,249,255,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(15,23,42,.06);
    }
    .topbar .wrap{padding:14px 18px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:14px}
    .brand{display:flex; align-items:center; gap:12px; min-width:260px}

    .logo{
      width:42px; height:42px; border-radius:14px;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .logo img{width:100%; height:100%; object-fit:cover; display:block}
    .btitle{line-height:1.05}
    .btitle .name{font-weight:900; font-size:16px}

    .nav{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      height:42px; padding:0 14px; border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      display:inline-flex; align-items:center; gap:10px;
      font-weight:900;
      cursor:pointer;
      transition:.15s ease;
      box-shadow: 0 8px 22px rgba(15,23,42,.06);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.ghost{ background: rgba(255,255,255,.70); }
    .btn-primary{
      border:none;
      color:#fff;
      background: linear-gradient(135deg, var(--blue), #60a5fa);
      box-shadow: 0 14px 30px rgba(37,99,235,.22);
    }
    .top-actions{ display:flex; gap:10px; align-items:center; }

    .dd{ position:relative; display:inline-flex; }
    .ddBtn{ user-select:none; }
    .ddMenu{
      position:absolute;
      top:calc(100% + 10px);
      right:0;
      min-width:260px;
      padding:8px;
      border-radius:16px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 18px 45px rgba(15,23,42,.14);
      backdrop-filter: blur(10px);
      display:none;
      z-index:50;
    }
    .dd.open .ddMenu{ display:block; }
    .ddItem{
      width:100%;
      border:none;
      background: transparent;
      text-align:left;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      color: var(--ink);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .ddItem:hover{ background: rgba(37,99,235,.08); }

    .hero{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:18px;
      align-items:stretch;
    }
    .panel{
      background: rgba(255,255,255,.78);
      border:1px solid rgba(15,23,42,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .heroLeftCard{ background: rgba(255,255,255,.82); }

    .schoolMedia{
      position:relative;
      height:300px;
      background:#eef2ff;
      overflow:hidden;
      border-bottom:1px solid rgba(15,23,42,.06);
    }
    .schoolImg{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scale(1.02)}
    .schoolOverlay{
      position:absolute; inset:0;
      background:
        radial-gradient(800px 320px at 20% 30%, rgba(37,99,235,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.70) 70%, rgba(255,255,255,.92) 100%);
    }
    .heroCopy{ padding:18px 18px 20px; }
    .heroTitle{
      margin:0;
      font-size:42px;
      line-height:1.06;
      letter-spacing:-.03em;
      background: linear-gradient(135deg, #0f172a 0%, #1d4ed8 55%, #2563eb 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .heroQuote{
      margin-top:12px;
      padding:12px 14px;
      border-radius:16px;
      background: rgba(37,99,235,.06);
      border:1px solid rgba(37,99,235,.14);
      font-weight:900;
      color:#0f172a;
      line-height:1.35;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .heroQuote .qIco{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.16);
      flex:0 0 auto;
    }
    .heroQuote .qText{font-size:14px; letter-spacing:-.01em;}

    .illusPhoto{
      min-height: 420px;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      background:#f1f6ff;
    }
    .illusPhoto::before{
      content:"";
      position:absolute; inset:0;
      background:url("assets/img/school-hero-right.jpg") center/cover no-repeat;
      filter: blur(18px) saturate(1.1);
      transform: scale(1.08);
      opacity:.45;
    }
    .illusPhoto::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(700px 320px at 30% 25%, rgba(37,99,235,.20), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.30));
      pointer-events:none;
    }
    .illusFrame{
      position:relative;
      width:min(520px, 92%);
      border-radius: 26px;
      overflow:hidden;
      border:1px solid rgba(37,99,235,.18);
      box-shadow: 0 18px 45px rgba(15,23,42,.14);
      background: rgba(255,255,255,.65);
    }
    .illusFrame img{width:100%; height:auto; display:block; object-fit:cover;}

    .grid4{
      margin-top:18px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    .card{
      background: rgba(255,255,255,.85);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      padding:16px 16px 14px;
      display:flex; flex-direction:column; gap:10px;
      position:relative;
    }
    .card .rTop{display:flex; align-items:flex-start; gap:10px}
    .ico{
      width:38px; height:38px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.15);
      font-size:18px;
      flex:0 0 auto;
    }
    .card .title{font-weight:900}
    .card .desc{margin-top:6px;color: rgba(71,85,105,.95);font-weight:700;font-size:13px;line-height:1.35;}
    .card .desc p{margin:0}
    .card .desc p + p{margin-top:8px}
    .card.primary{border-color: rgba(37,99,235,.20); background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));}

    .footer{
      margin-top:18px;
      padding:18px 0 0;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      color:rgba(71,85,105,.95);
      font-size:13px;
    }

    /* ===== Modal + Toast ===== */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.35); backdrop-filter: blur(6px); z-index:9998; padding:18px;}
    .modal.open{display:flex}
    .modal-card{
      width:min(720px, 96vw);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.10);
      border-radius:22px;
      box-shadow:0 25px 60px rgba(0,0,0,.22);
      padding:14px 14px 12px;
      max-height: calc(100vh - 36px);
      overflow:auto;
      transition: .15s ease;
    }
    .modal-card.shrink{
      width:min(640px, 96vw);
      padding:12px 12px 10px;
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .modal-title{font-weight:900; font-size:22px; letter-spacing:-.02em;}
    .role-tabs{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 12px}
    .role-tabs .tab{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .role-tabs .tab.active{
      background: linear-gradient(135deg, rgba(37,99,235,.16), rgba(96,165,250,.20));
      border-color: rgba(37,99,235,.55);
      color:#1d4ed8;
      box-shadow: 0 14px 26px rgba(37,99,235,.18);
    }
    .blk{display:none; margin-top:4px}
    .blk.active{display:block}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .field label{display:block; margin:8px 0 6px; font-weight:900; color:#334155}
    .field input,.field select{
      width:100%;
      padding:12px 12px;
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      outline:none;
      background:#fff;
      font-weight:800;
    }

    .pw{ position:relative; }
    .pwWrap{ position:relative; }
    .pwWrap input{ padding-right:54px; }
    .pw .eye{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:38px; height:38px; border-radius:12px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      transition:.15s ease;
      user-select:none;
      color: transparent;
      opacity:0;
      visibility:hidden;
      pointer-events:none;
    }
    .pw .eye.show{
      opacity:1;
      visibility:visible;
      pointer-events:auto;
    }
    .pw .eye:hover{
      border-color: rgba(37,99,235,.28);
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
    }
    .pw .eye::before{
      content:"";
      width:18px; height:18px;
      display:block;
      background-repeat:no-repeat;
      background-position:center;
      background-size:18px 18px;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z'/%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3C/svg%3E");
      opacity:.85;
    }
    .pw .eye.on::before{
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M10.58 10.58A2 2 0 0 0 12 14a2 2 0 0 0 1.42-.58'/%3E%3Cpath d='M9.88 4.24A10.94 10.94 0 0 1 12 4c6.5 0 10 8 10 8a18.4 18.4 0 0 1-2.68 3.9'/%3E%3Cpath d='M6.61 6.61A18.4 18.4 0 0 0 2 12s3.5 8 10 8a10.94 10.94 0 0 0 5.76-1.64'/%3E%3Cline x1='2' y1='2' x2='22' y2='22'/%3E%3C/svg%3E");
      opacity:.85;
    }

    .muterow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .muterow .link{color:#1d4ed8; font-weight:900; cursor:pointer}
    .check{display:flex; align-items:center; gap:8px; font-weight:900; color:#334155}
    .modal-foot{display:flex; justify-content:flex-end; gap:10px; margin-top:12px; flex-wrap:wrap;}
    .btnDanger{
      border:none;
      color:#fff;
      background: linear-gradient(135deg, #ef4444, #fb7185);
      box-shadow: 0 14px 30px rgba(239,68,68,.18);
    }
    .hint{
      margin-top:8px;
      font-size:13px;
      color:rgba(71,85,105,.95);
      font-weight:800;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      box-shadow:0 18px 55px rgba(15,23,42,.25);
      display:none;
      z-index:9999;
      max-width:min(860px, 92vw);
      text-align:center;
    }
    .toast.show{display:block}

    @media (max-width: 980px){
      .hero{grid-template-columns:1fr;}
      .grid4{grid-template-columns: repeat(2, 1fr)}
      .schoolMedia{height:240px}
      .heroTitle{font-size:34px}
      .illusPhoto{min-height:320px}
      .ddMenu{ right:auto; left:0; }
      .grid2{grid-template-columns: 1fr}
      .modal-title{font-size:20px}
    }
    @media (max-width: 520px){
      .wrap{padding:14px 14px 28px}
      .topbar .wrap{padding:12px 14px}
      .heroTitle{font-size:30px}
      .grid4{grid-template-columns:1fr}
      .ddMenu{ min-width: 220px; }
    }
    .regActions { align-items: stretch; }
    @media (max-width: 720px){
      .regActions{ flex-direction: column; }
    }
    .regGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 14px;
      align-items:start;
    }
    .rg-name  { grid-column: 1; grid-row: 1; }
    .rg-phone { grid-column: 2; grid-row: 1; }
    .rg-email { grid-column: 1; grid-row: 2; }
    .rg-pass  { grid-column: 2; grid-row: 2; }
    .rg-pass2 { grid-column: 2; grid-row: 3; }

    .rg-actions{
      grid-column: 1;
      grid-row: 3;
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 38px;
    }
    .rg-actions .btn{ flex:1; justify-content:center; }

    @media (max-width: 640px){
      .regGrid{ grid-template-columns: 1fr; }
      .rg-name  { grid-column: 1; grid-row: 1; }
      .rg-phone { grid-column: 1; grid-row: 2; }
      .rg-email { grid-column: 1; grid-row: 3; }
      .rg-pass  { grid-column: 1; grid-row: 4; }
      .rg-pass2 { grid-column: 1; grid-row: 5; }
      .rg-actions{ grid-column: 1; grid-row: 6; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo" title="Logo nh√† tr∆∞·ªùng">
            <img src="assets/img/logo-school.jpg" alt="Logo nh√† tr∆∞·ªùng">
          </div>
          <div class="btitle">
            <div class="name" id="schoolName">Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi ‚Äì ƒêi·ªán Bi√™n Ph·ªß</div>
          </div>
        </div>

        <div class="nav" aria-label="ƒêi·ªÅu h∆∞·ªõng theo vai tr√≤">
          <div class="dd" data-role="TEACHER">
            <button class="btn ddBtn" type="button" aria-haspopup="true" aria-expanded="false">üë©‚Äçüè´ Gi√°o vi√™n ‚ñæ</button>
            <div class="ddMenu" role="menu" aria-label="Menu Gi√°o vi√™n">
              <button class="ddItem" type="button" data-go-role="TEACHER" data-entry="pages/teacher/teacher-dashboard.html">üìä Dashboard</button>
              <button class="ddItem" type="button" data-go-role="TEACHER" data-entry="pages/teacher/teacher-tasks.html">üìö Ng√¢n h√†ng b√†i</button>
              <button class="ddItem" type="button" data-go-role="TEACHER" data-entry="pages/teacher/teacher-submissions.html">üì• B√†i n·ªôp</button>
              <button class="ddItem" type="button" data-go-role="TEACHER" data-entry="pages/teacher/teacher-grading.html">üßæ Ch·∫•m/nh·∫≠n x√©t</button>
              <button class="ddItem" type="button" data-go-role="TEACHER" data-entry="pages/teacher/teacher-insights.html">üìà Insights</button>
            </div>
          </div>

          <div class="dd" data-role="STUDENT">
            <button class="btn ddBtn" type="button" aria-haspopup="true" aria-expanded="false">üßí H·ªçc sinh ‚ñæ</button>
            <div class="ddMenu" role="menu" aria-label="Menu H·ªçc sinh">
              <button class="ddItem" type="button" data-go-role="STUDENT" data-entry="pages/student/dashboard.html">üè† Trang h·ªçc t·∫≠p c√° nh√¢n</button>
              <button class="ddItem" type="button" data-go-role="STUDENT" data-entry="pages/student/do-task.html">üìù L√†m b√†i</button>
              <button class="ddItem" type="button" data-go-role="STUDENT" data-entry="pages/student/progress.html">üìà Ti·∫øn b·ªô h·ªçc t·∫≠p</button>
            </div>
          </div>

          <div class="dd" data-role="PARENT">
            <button class="btn ddBtn" type="button" aria-haspopup="true" aria-expanded="false">üë®‚Äçüë©‚Äçüëß Ph·ª• huynh ‚ñæ</button>
            <div class="ddMenu" role="menu" aria-label="Menu Ph·ª• huynh">
              <button class="ddItem" type="button" data-go-role="PARENT" data-entry="pages/parent/week.html">üìÖ Theo d√µi theo tu·∫ßn</button>
              <button class="ddItem" type="button" data-go-role="PARENT" data-entry="pages/parent/notes.html">üí¨ Nh·∫≠n x√©t gi√°o vi√™n</button>
              <button class="ddItem" type="button" data-go-role="PARENT" data-entry="pages/parent/progress.html">üìä Ti·∫øn b·ªô c·ªßa con</button>
            </div>
          </div>

          <div class="dd" data-role="ADMIN">
            <button class="btn ddBtn" type="button" aria-haspopup="true" aria-expanded="false">üè´ Nh√† tr∆∞·ªùng ‚ñæ</button>
            <div class="ddMenu" role="menu" aria-label="Menu Nh√† tr∆∞·ªùng">
              <button class="ddItem" type="button" data-go-role="ADMIN" data-entry="pages/admin/dashboard.html">üìä ƒêi·ªÅu h√†nh t·ªïng th·ªÉ</button>
              <button class="ddItem" type="button" data-go-role="ADMIN" data-entry="pages/admin/setup.html">üß© Thi·∫øt l·∫≠p nƒÉm h·ªçc</button>
            </div>
          </div>

          <div class="top-actions">
            <span id="topUserBadge" style="display:none; padding:8px 10px; border-radius:12px; background:#eef2ff; font-weight:900;"></span>
            <button id="btnLoginTop" class="btn btn-primary" data-state="login">ƒêƒÉng nh·∫≠p</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="hero">
      <div class="panel heroLeftCard">
        <div class="schoolMedia">
          <img class="schoolImg" src="assets/img/school-hero-left.jpg" alt="·∫¢nh nh√† tr∆∞·ªùng"/>
          <div class="schoolOverlay"></div>
        </div>
        <div class="heroCopy">
          <h1 class="heroTitle">N·ªÄN T·∫¢NG H·ªåC T·∫¨P S·ªê</h1>
          <div class="heroQuote">
            <div class="qIco">üè´</div>
            <div class="qText">‚ÄúM·ªói th·∫ßy c√¥ l√†m ch·ªß c√¥ng ngh·ªá, m·ªói h·ªçc sinh t·ª± tin h·ªçc t·∫≠p ‚Äì chuy·ªÉn ƒë·ªïi s·ªë b·∫Øt ƒë·∫ßu t·ª´ th·ª±c ti·ªÖn l·ªõp h·ªçc.‚Äù</div>
          </div>
        </div>
      </div>

      <div class="panel illusPhoto" aria-label="Minh ho·∫° nh√† tr∆∞·ªùng">
        <div class="illusFrame">
          <img src="assets/img/school-hero-right.jpg" alt="H√¨nh ·∫£nh ho·∫°t ƒë·ªông nh√† tr∆∞·ªùng">
        </div>
      </div>
    </section>

    <section class="grid4" id="ecosystem" aria-label="L·ª£i √≠ch theo vai tr√≤">
      <div class="card primary">
        <div class="rTop">
          <div class="ico">üë©‚Äçüè´</div>
          <div>
            <div class="title">Gi√°o vi√™n</div>
            <div class="desc">
              <p>Giao b√†i, thu b√†i, ch·∫•m v√† nh·∫≠n x√©t tr·ª±c tuy·∫øn ngay tr√™n h·ªá th·ªëng.</p>
              <p>D·ªØ li·ªáu h·ªçc t·∫≠p l∆∞u theo l·ªõp & nƒÉm h·ªçc, theo d√µi ti·∫øn b·ªô r√µ r√†ng, gi·∫£m s·ªï s√°ch.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="rTop">
          <div class="ico">üßí</div>
          <div>
            <div class="title">H·ªçc sinh</div>
            <div class="desc">
              <p>L√†m b√†i, xem nh·∫≠n x√©t v√† k·∫øt qu·∫£ h·ªçc t·∫≠p c·ªßa b·∫£n th√¢n.</p>
              <p>C√≥ h·ªì s∆° h·ªçc t·∫≠p c√° nh√¢n theo tu·∫ßn, h√¨nh th√†nh th√≥i quen t·ª± h·ªçc.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="rTop">
          <div class="ico">üë®‚Äçüë©‚Äçüëß</div>
          <div>
            <div class="title">Ph·ª• huynh</div>
            <div class="desc">
              <p>Theo d√µi k·∫øt qu·∫£, nh·∫≠n x√©t gi√°o vi√™n v√† th√¥ng b√°o theo tu·∫ßn.</p>
              <p>ƒê·ªìng h√†nh k·ªãp th·ªùi, ph·ªëi h·ª£p hi·ªáu qu·∫£ v·ªõi nh√† tr∆∞·ªùng.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="rTop">
          <div class="ico">üè´</div>
          <div>
            <div class="title">Nh√† tr∆∞·ªùng</div>
            <div class="desc">
              <p>Qu·∫£n l√Ω t·∫≠p trung d·ªØ li·ªáu l·ªõp, h·ªçc sinh v√† nƒÉm h·ªçc khoa h·ªçc.</p>
              <p>T·ªïng h·ª£p b√°o c√°o nhanh, ƒëi·ªÅu h√†nh theo d·ªØ li·ªáu.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">
      <div>¬© <span id="y"></span> ‚Ä¢ <span id="schoolName2">Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi ‚Äì ƒêi·ªán Bi√™n Ph·ªß</span> ‚Ä¢ HEDU</div>
      <div>üìû H·ªó tr·ª£: VƒÉn ph√≤ng nh√† tr∆∞·ªùng</div>
    </div>
  </main>

  <!-- ===== MODAL LOGIN (d√πng chung 4 role) ===== -->
  <div id="loginModal" class="modal" aria-hidden="true">
    <div id="modalCard" class="modal-card" role="dialog" aria-modal="true" aria-label="ƒêƒÉng nh·∫≠p">
      <div class="modal-head">
        <div class="modal-title" id="loginRoleTitle">ƒêƒÉng nh·∫≠p</div>
        <button class="btn" type="button" data-close-login>‚úï</button>
      </div>

      <div class="role-tabs">
        <button class="tab" type="button" data-set-login-role="TEACHER">üë©‚Äçüè´ Gi√°o vi√™n</button>
        <button class="tab" type="button" data-set-login-role="STUDENT">üßí H·ªçc sinh</button>
        <button class="tab" type="button" data-set-login-role="PARENT">üë®‚Äçüë©‚Äçüëß Ph·ª• huynh</button>
        <button class="tab" type="button" data-set-login-role="ADMIN">üè´ Nh√† tr∆∞·ªùng</button>
      </div>

      <!-- ===== TEACHER ===== -->
      <div id="blkTeacher" class="blk">
        <div id="t_login_box">
          <div class="grid2">
            <div class="field">
              <label>SƒêT ho·∫∑c Email</label>
              <input id="t_username" inputmode="text" autocomplete="username" placeholder="vd: 098xxxxxxx / abc@gmail.com"/>
            </div>
            <div class="field pw">
              <label>M·∫≠t kh·∫©u</label>
              <div class="pwWrap">
                <input id="t_password" type="password" autocomplete="current-password" placeholder=""/>
                <button class="eye" type="button" data-toggle-pw="#t_password" aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u"></button>
              </div>
            </div>
          </div>

          <div class="muterow">
            <label class="check"><input type="checkbox" id="t_remember"> Ghi nh·ªõ m·∫≠t kh·∫©u</label>
            <span class="link" id="t_forgot">Qu√™n m·∫≠t kh·∫©u?</span>
          </div>

          <div class="muterow" style="margin-top:8px">
            <span style="font-weight:900;color:#0f172a">Ch∆∞a c√≥ t√†i kho·∫£n?</span>
            <span class="link" id="t_open_register">T·∫°o t√†i kho·∫£n</span>
          </div>

          <div class="hint">‚úÖ Gi√°o vi√™n ƒëƒÉng nh·∫≠p s·∫Ω v√†o ƒë√∫ng trang ƒë√£ b·∫•m ·ªü menu.</div>
        </div>

        <div id="t_register_box" style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed rgba(15,23,42,.12)">
          <div class="regGrid">
            <div class="field rg-name">
              <label>H·ªç v√† t√™n <span style="color:#ef4444">*</span></label>
              <input id="tr_name" placeholder="vd: Nguy·ªÖn VƒÉn A"/>
            </div>

            <div class="field rg-phone">
              <label>S·ªë ƒëi·ªán tho·∫°i <span style="color:#ef4444">*</span></label>
              <input id="tr_phone" type="tel" inputmode="tel" placeholder="vd: 0982xxxxxx"/>
            </div>

            <div class="field rg-email">
              <label>Email (n·∫øu c√≥)</label>
              <input id="tr_email" inputmode="email" placeholder="vd: abc@gmail.com"/>
            </div>

            <div class="field pw rg-pass">
              <label>M·∫≠t kh·∫©u <span style="color:#ef4444">*</span></label>
              <div class="pwWrap">
                <input id="tr_pass" type="password" placeholder=""/>
                <button class="eye" type="button" data-toggle-pw="#tr_pass" aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u"></button>
              </div>
            </div>

            <div class="field pw rg-pass2">
              <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u <span style="color:#ef4444">*</span></label>
              <div class="pwWrap">
                <input id="tr_pass2" type="password" placeholder=""/>
                <button class="eye" type="button" data-toggle-pw="#tr_pass2" aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u"></button>
              </div>
            </div>

            <div class="rg-actions">
              <button class="btn btn-primary" type="button" id="btnTeacherRegister">T·∫°o t√†i kho·∫£n</button>
              <button class="btn" type="button" id="btnTeacherRegisterCancel">Hu·ª∑</button>
            </div>
          </div>

          <div class="hint">‚ö†Ô∏è L∆∞u √Ω: SƒêT nh·∫≠p d·∫°ng text ƒë·ªÉ gi·ªØ s·ªë 0 ƒë·∫ßu. Backend Sheets c≈©ng ph·∫£i ƒë·ªÉ d·∫°ng Plain text.</div>
        </div>
      </div>

      <!-- ===== STUDENT ===== -->
      <div id="blkStudent" class="blk">
        <div class="grid2">
          <div class="field">
            <label>L·ªõp <span style="color:#ef4444">*</span></label>
            <select id="studentClass">
              <option value="">-- Ch·ªçn l·ªõp --</option>
            </select>
          </div>
          <div class="field">
            <label>M√£ h·ªçc sinh <span style="color:#ef4444">*</span></label>
            <input id="s_username" placeholder="vd: HS01 / 5A1-012"/>
          </div>
        </div>

        <div class="hint">üßí H·ªçc sinh: ch·ªâ c·∫ßn ch·ªçn l·ªõp + m√£ h·ªçc sinh.</div>
      </div>

      <!-- ===== PARENT ===== -->
      <div id="blkParent" class="blk">
        <div class="grid2">
          <div class="field">
            <label>L·ªõp <span style="color:#ef4444">*</span></label>
            <select id="parentClass">
              <option value="">-- Ch·ªçn l·ªõp --</option>
            </select>
          </div>
          <div class="field">
            <label>M√£ h·ªçc sinh <span style="color:#ef4444">*</span></label>
            <input id="p_student" placeholder="vd: HS01"/>
          </div>
        </div>

        <div class="hint">üë®‚Äçüë©‚Äçüëß Ph·ª• huynh: ch·ªâ c·∫ßn ch·ªçn l·ªõp + m√£ h·ªçc sinh.</div>
      </div>

      <!-- ===== ADMIN ===== -->
      <div id="blkAdmin" class="blk">
        <div class="field">
          <label>M√£ BGH / Qu·∫£n tr·ªã</label>
          <input id="a_code" placeholder="vd: BGH2026@"/>
        </div>
        <div class="hint">üè´ BGH/Qu·∫£n tr·ªã ch·ªâ nh·∫≠p 1 l·∫ßn t·∫°i ƒë√¢y. (Kh√¥ng h·ªèi l·∫°i ·ªü trang admin n·ªØa.)</div>
      </div>

      <div class="modal-foot">
        <button class="btn" type="button" data-close-login>ƒê·ªÉ sau</button>
        <button class="btn btn-primary" type="button" data-do-login id="btnDoLogin">ƒêƒÉng nh·∫≠p</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
  /**************
   * HEDU Index ‚Äì Flow t·ªëi gi·∫£n (gating + modal login)
   **************/

  // ===== Config SCRIPT_URL (gi·ªØ nguy√™n ƒë·ªÉ kh√¥ng ph√° g√¨ kh√°c) =====
  const SCRIPT_URL = (function(){
    try{
      if(typeof getConfig === "function"){
        const cfg = getConfig();
        if(cfg && cfg.SCRIPT_URL) return cfg.SCRIPT_URL;
      }
    }catch(e){}
    return window.SCRIPT_URL || "";
  })();

  const LS = {
    session: "hedu_session",
    user: "hedu_user",
    role: "hedu_role",
    entry: "hedu_entry",
    rememberT: "hedu_remember_teacher",
    teacherU: "hedu_teacher_u",
    teacherP: "hedu_teacher_p",
    entryByRolePrefix: "hedu_entry_role_"
  };

  const ROLE_LABEL = {
    TEACHER: "Gi√°o vi√™n",
    STUDENT: "H·ªçc sinh",
    PARENT: "Ph·ª• huynh",
    ADMIN: "Nh√† tr∆∞·ªùng"
  };

  // ‚úÖ Trang m·∫∑c ƒë·ªãnh theo vai tr√≤ (khi entry r·ªóng/kh√¥ng h·ª£p l·ªá)
  const DEFAULT_ROUTE = {
    TEACHER: "pages/teacher/teacher-dashboard.html",
    STUDENT: "pages/student/dashboard.html",
    PARENT: "pages/parent/week.html",
    ADMIN: "pages/admin/dashboard.html"
  };

  const $ = (s)=>document.querySelector(s);
  const toastEl = $("#toast");

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 2600);
  }

  function readJSON(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
  }
  function writeJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  // ‚úÖ SSOT: session ch·ªâ ƒë·ªçc/ghi hedu_session (api.js c≈©ng ƒë·ªçc key n√†y)
  function getSession(){ return readJSON(LS.session); }
  function setSession(sess){ writeJSON(LS.session, sess); }
  function clearSession(){
    localStorage.removeItem(LS.session);
    localStorage.removeItem(LS.user);
    localStorage.removeItem(LS.role);
  }

  // ‚úÖ apiCall: d√πng DUY NH·∫§T api.js (ƒë√£ c√≥ POST + fallback JSONP)
  async function apiCall(action, payload = {}) {
    if (typeof window.apiPost !== "function") {
      return { ok:false, error:"Thi·∫øu apiPost (assets/api.js ch∆∞a load)" };
    }
    return window.apiPost(action, payload);
  }

  function safeSetText(id, value){
    const el = document.getElementById(id);
    if(el && value) el.textContent = value;
  }

  // =============================
  // ‚úÖ ENTRY HARDEN (kh√¥ng bao gi·ªù b·ªã entry ph√°)
  // =============================
  function sanitizeEntry(entry){
    const e = String(entry || "").trim();
    if(!e) return "";
    // ch·∫∑n URL ngo√†i
    if(/^(https?:)?\/\//i.test(e)) return "";
    // ch·∫∑n login.html m·ªçi ki·ªÉu
    if(e.toLowerCase().includes("login.html")) return "";
    // ch·∫∑n javascript:
    if(/^javascript:/i.test(e)) return "";
    // normalize
    return e.replace(/^\/+/, "");
  }
  function setEntryForRole(role, entry){
    const clean = sanitizeEntry(entry);
    const key = LS.entryByRolePrefix + String(role || "").toUpperCase();
    if(clean){
      localStorage.setItem(key, clean);
      localStorage.setItem(LS.entry, clean); // gi·ªØ t∆∞∆°ng th√≠ch
    }else{
      localStorage.removeItem(key);
      localStorage.removeItem(LS.entry);
    }
  }
  function getEntryForRole(role){
    const key = LS.entryByRolePrefix + String(role || "").toUpperCase();
    return sanitizeEntry(localStorage.getItem(key) || localStorage.getItem(LS.entry) || "");
  }
  function clearEntry(){
    localStorage.removeItem(LS.entry);
    // kh√¥ng c·∫ßn xo√° entryByRole, ch·ªâ xo√° ‚Äúentry hi·ªán h√†nh‚Äù ƒë·ªÉ kh·ªèi d√≠nh
  }

  // ===== Dropdown role =====
  (function initRoleDropdown(){
    const dds = document.querySelectorAll(".dd");
    const closeAll = ()=> dds.forEach(d=> {
      d.classList.remove("open");
      const btn = d.querySelector(".ddBtn");
      if(btn) btn.setAttribute("aria-expanded", "false");
    });

    dds.forEach(dd=>{
      const btn = dd.querySelector(".ddBtn");
      const menu = dd.querySelector(".ddMenu");
      if(!btn || !menu) return;

      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const isOpen = dd.classList.contains("open");
        closeAll();
        if(!isOpen){
          dd.classList.add("open");
          btn.setAttribute("aria-expanded", "true");
        }
      });
    });

    document.addEventListener("click", (e)=>{
      const item = e.target.closest(".ddItem");
      if(!item) return;
      const role = item.getAttribute("data-go-role");
      const entry = item.getAttribute("data-entry") || "";
      closeAll();
      handleEntry(role, entry);
    });

    document.addEventListener("click", closeAll);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeAll(); });
  })();

  const modal = $("#loginModal");
  const modalCard = $("#modalCard");
  const titleEl = $("#loginRoleTitle");
  const tabs = Array.from(document.querySelectorAll("[data-set-login-role]"));
  const roleTabsWrap = document.querySelector(".role-tabs");
  const modalFoot = document.querySelector(".modal-foot");

  const blocks = {
    TEACHER: $("#blkTeacher"),
    STUDENT: $("#blkStudent"),
    PARENT: $("#blkParent"),
    ADMIN: $("#blkAdmin")
  };

  let currentRole = "TEACHER";
  let teacherRegisterMode = false;

  function openModal(role){
    currentRole = role || currentRole || "TEACHER";
    setRoleUI(currentRole);
    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");

    if(currentRole === "STUDENT" || currentRole === "PARENT"){
      loadClassesIfNeeded();
    }

    setTimeout(()=>{ syncAllPwEyes(); }, 0);

    setTimeout(()=>{
      const focusMap = {
        TEACHER: "#t_username",
        STUDENT: "#studentClass",
        PARENT: "#parentClass",
        ADMIN: "#a_code"
      };
      const el = document.querySelector(focusMap[currentRole] || "#t_username");
      if(el) el.focus();
    }, 10);
  }
  function closeModal(){
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden", "true");
    setRegisterMode(false, true);
  }

  function setRegisterMode(on, silent){
    teacherRegisterMode = !!on;

    if(roleTabsWrap) roleTabsWrap.style.display = teacherRegisterMode ? "none" : "flex";

    const loginBox = document.getElementById("t_login_box");
    if(loginBox) loginBox.style.display = teacherRegisterMode ? "none" : "block";

    if(modalFoot) modalFoot.style.display = teacherRegisterMode ? "none" : "flex";

    if(modalCard) modalCard.classList.toggle("shrink", teacherRegisterMode);

    if(teacherRegisterMode){
      currentRole = "TEACHER";
      setRoleUI("TEACHER");
      titleEl.textContent = "T·∫°o t√†i kho·∫£n Gi√°o vi√™n";
      $("#t_register_box").style.display = "block";
      if(!silent) toast("üßæ Nh·∫≠p th√¥ng tin ƒë·ªÉ t·∫°o t√†i kho·∫£n");

      setTimeout(()=>{ syncAllPwEyes(); }, 0);
      setTimeout(()=>{ const el = document.getElementById("tr_name"); if(el) el.focus(); }, 50);
    }else{
      titleEl.textContent = "ƒêƒÉng nh·∫≠p " + (ROLE_LABEL[currentRole] || "");
      $("#t_register_box").style.display = "none";
      setTimeout(()=>{ syncAllPwEyes(); }, 0);
    }
  }

  function setRoleUI(role){
    if(teacherRegisterMode) role = "TEACHER";

    currentRole = role;
    titleEl.textContent = teacherRegisterMode
      ? "T·∫°o t√†i kho·∫£n Gi√°o vi√™n"
      : ("ƒêƒÉng nh·∫≠p " + (ROLE_LABEL[role] || ""));

    tabs.forEach(t=>{
      t.classList.toggle("active", t.getAttribute("data-set-login-role") === role);
    });
    Object.keys(blocks).forEach(k=>{
      blocks[k].classList.toggle("active", k === role);
    });
    localStorage.setItem(LS.role, role);

    setTimeout(()=>{ syncAllPwEyes(); }, 0);
  }

  document.addEventListener("click", (e)=>{
    if(e.target.matches("[data-close-login]")) closeModal();
    if(e.target === modal) closeModal();
    const tab = e.target.closest("[data-set-login-role]");
    if(tab && !teacherRegisterMode){
      setRoleUI(tab.getAttribute("data-set-login-role"));
      if(currentRole === "STUDENT" || currentRole === "PARENT") loadClassesIfNeeded();
    }
  });

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-toggle-pw]");
    if(!btn) return;
    const sel = btn.getAttribute("data-toggle-pw");
    const input = document.querySelector(sel);
    if(!input) return;

    input.type = (input.type === "password") ? "text" : "password";
    btn.classList.toggle("on", input.type === "text");
  });

  function syncPwEye(input){
    if(!input) return;
    const wrap = input.closest(".pwWrap");
    if(!wrap) return;
    const btn = wrap.querySelector(".eye");
    if(!btn) return;

    const has = !!String(input.value || "").length;
    btn.classList.toggle("show", has);

    if(!has){
      input.type = "password";
      btn.classList.remove("on");
    }else{
      btn.classList.toggle("on", input.type === "text");
    }
  }
  function syncAllPwEyes(){
    document.querySelectorAll(".pwWrap input[type='password'], .pwWrap input[type='text']").forEach(syncPwEye);
  }
  document.addEventListener("input", (e)=>{
    const input = e.target && e.target.matches(".pwWrap input") ? e.target : null;
    if(!input) return;
    syncPwEye(input);
  });

  $("#t_open_register").addEventListener("click", ()=>{ setRegisterMode(true); });

  document.addEventListener("click", (e)=>{
    if(e.target && e.target.id === "btnTeacherRegisterCancel"){
      setRegisterMode(false);
      setRoleUI("TEACHER");
      toast("‚Ü©Ô∏è Quay l·∫°i ƒëƒÉng nh·∫≠p");
      setTimeout(()=>{ const el = document.getElementById("t_username"); if(el) el.focus(); }, 50);
    }
  });

  $("#t_forgot").addEventListener("click", ()=>{
    toast("üîê Qu√™n m·∫≠t kh·∫©u: hi·ªán backend ch∆∞a c√≥ endpoint reset. Anh c√≥ th·ªÉ b·ªï sung action resetTeacherPassword ƒë·ªÉ d√πng.");
  });

  // =========================================================
  // ‚úÖ FIX #1: loadClassesIfNeeded KH√îNG ph·ª• thu·ªôc data.ok
  // =========================================================
  let classesLoaded = false;
  async function loadClassesIfNeeded(){
    if(classesLoaded) return;
    try{
      $("#studentClass").innerHTML = '<option value="">ƒêang t·∫£i l·ªõp...</option>';
      $("#parentClass").innerHTML  = '<option value="">ƒêang t·∫£i l·ªõp...</option>';

      const data = await apiCall("listClassesPublic", {});

      // ch·∫•p nh·∫≠n nhi·ªÅu format:
      // 1) {classes:[...]} (backend hi·ªán t·∫°i c·ªßa anh)
      // 2) {ok:true, classes:[...]}
      // 3) {data:{classes:[...]}}
      const list =
        (Array.isArray(data?.classes) && data.classes) ||
        (Array.isArray(data?.data?.classes) && data.data.classes) ||
        [];

      // n·∫øu backend tr·∫£ l·ªói r√µ r√†ng
      if((data && data.ok === false) || (data && data.error)){
        if(!list.length) throw new Error(data.error || "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch l·ªõp");
      }

      const options = ['<option value="">-- Ch·ªçn l·ªõp --</option>']
        .concat(list.map(c=>{
          const id = (c.classId ?? c.id ?? c.value ?? c.class_id ?? "").toString();
          const name = (c.className ?? c.name ?? c.label ?? c.class_name ?? id).toString();
          return `<option value="${escapeHtml(id)}">${escapeHtml(name)}</option>`;
        })).join("");

      $("#studentClass").innerHTML = options;
      $("#parentClass").innerHTML  = options;
      classesLoaded = true;

    }catch(err){
      $("#studentClass").innerHTML = '<option value="">-- Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªõp --</option>';
      $("#parentClass").innerHTML  = '<option value="">-- Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªõp --</option>';
      toast("‚ö†Ô∏è " + (err.message || "L·ªói t·∫£i l·ªõp"));
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function canGo(role){
    const sess = getSession();
    const u = readJSON(LS.user);
    if(!sess || !(sess.token || sess.sessionId)) return false;
    if(!u || !u.role) return false;
    return String(u.role).toUpperCase() === String(role).toUpperCase();
  }

  function handleEntry(role, entry){
    setEntryForRole(role, entry);
    localStorage.setItem(LS.role, role || "");
    if(canGo(role)){
      const go = getEntryForRole(role) || DEFAULT_ROUTE[role] || "";
      if(go) location.href = go;
      else openModal(role);
    }else{
      openModal(role);
    }
  }

  $("#btnLoginTop").addEventListener("click", async ()=>{
    const state = $("#btnLoginTop").getAttribute("data-state");
    if(state === "logout"){
      await doLogout();
      return;
    }
    clearEntry();
    const lastRole = localStorage.getItem(LS.role) || "TEACHER";
    openModal(lastRole);
  });

  $("#btnDoLogin").addEventListener("click", ()=>doLogin());
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && modal.classList.contains("open")){
      if(teacherRegisterMode) return;
      e.preventDefault();
      doLogin();
    }
  });

  function getVal(id){
    const el = document.getElementById(id);
    return el ? String(el.value || "").trim() : "";
  }

  // =========================================================
  // ‚úÖ FIX #2 + #3: payload chu·∫©n + login success kh√¥ng ph·ª• thu·ªôc resp.ok
  // =========================================================
  async function doLogin(){
    try{
      $("#btnDoLogin").disabled = true;
      $("#btnDoLogin").textContent = "ƒêang x·ª≠ l√Ω...";

      let resp = null;

      if(currentRole === "TEACHER"){
        const username = getVal("t_username");
        const password = (document.getElementById("t_password")?.value || "");

        if(!username) throw new Error("Nh·∫≠p SƒêT ho·∫∑c Email");
        if(!password) throw new Error("Nh·∫≠p m·∫≠t kh·∫©u");

        // g·ª≠i d·∫°ng ‚Äúchu·∫©n‚Äù + api.js t·ª± map th√™m alias
        resp = await apiCall("authTeacherLogin", { username, password });

        const remember = !!document.getElementById("t_remember")?.checked;
        localStorage.setItem(LS.rememberT, remember ? "1" : "0");
        if(remember){
          localStorage.setItem(LS.teacherU, username);
          localStorage.setItem(LS.teacherP, password);
        }else{
          localStorage.removeItem(LS.teacherU);
          localStorage.removeItem(LS.teacherP);
        }
      }

      if(currentRole === "STUDENT"){
        const classId = getVal("studentClass");
        const studentCode = getVal("s_username");
        if(!classId) throw new Error("Ch·ªçn l·ªõp");
        if(!studentCode) throw new Error("Thi·∫øu m√£ h·ªçc sinh");

        // ‚úÖ g·ª≠i studentId (chu·∫©n) + api.js c√≥ th·ªÉ map th√™m
        resp = await apiCall("authStudentLogin", { classId, studentId: studentCode, studentCode });
      }

      if(currentRole === "PARENT"){
        const classId = getVal("parentClass");
        const studentCode = getVal("p_student");
        if(!classId) throw new Error("Ch·ªçn l·ªõp");
        if(!studentCode) throw new Error("Thi·∫øu m√£ h·ªçc sinh");

        resp = await apiCall("authParentLogin", { classId, studentId: studentCode, studentCode });
      }

      if(currentRole === "ADMIN"){
        const code = getVal("a_code");
        if(!code) throw new Error("Nh·∫≠p m√£ BGH/Qu·∫£n tr·ªã");

        resp = await apiCall("authAdminLogin", { adminCode: code, code });
      }

      // ‚úÖ th√†nh c√¥ng n·∫øu:
      // - resp.ok === true
      // - HO·∫∂C c√≥ session/token b·∫•t k·ª≥
      const ok =
        (resp && resp.ok === true) ||
        !!(resp && (resp.session || resp.token || resp.sessionId || resp.sessionToken));

      if(!ok){
        throw new Error(resp && resp.error ? resp.error : "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
      }

      // ===== SSOT session (QUAN TR·ªåNG) =====
      const user = resp.user || {
        role: currentRole,
        name: resp.name || resp.fullName || "",
        classId: resp.classId || "",
        username: resp.username || ""
      };

      const s0 = resp.session || {};
      const token = String(
        s0.token || s0.sessionId ||
        resp.token || resp.sessionToken || resp.sessionId || ""
      );

      const session = {
        token: String(s0.token || resp.token || resp.sessionToken || token || ""),
        sessionId: String(s0.sessionId || resp.sessionId || token || ""),
        role: String(currentRole || user.role || "").toUpperCase(),
        classId: resp.classId || user.classId || "",
        at: Date.now()
      };

      // ‚úÖ L∆∞u ƒë√∫ng 1 n∆°i duy nh·∫•t ƒë·ªÉ api.js/core.js ƒë·ªçc ·ªïn ƒë·ªãnh
      setSession(session);
      writeJSON(LS.user, user);
      localStorage.setItem(LS.role, session.role);

      closeModal();
      toast("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng: " + (ROLE_LABEL[session.role] || session.role));

      updateTopbar();

      // ‚úÖ ƒêi·ªÅu h∆∞·ªõng an to√†n (entry kh√¥ng ph√°)
      const go = getEntryForRole(session.role);
      clearEntry();
      const target = go || DEFAULT_ROUTE[session.role] || "";
      if(target) location.href = target;

    }catch(err){
      toast("‚ö†Ô∏è " + (err.message || "L·ªói ƒëƒÉng nh·∫≠p"));
    }finally{
      $("#btnDoLogin").disabled = false;
      $("#btnDoLogin").textContent = "ƒêƒÉng nh·∫≠p";
    }
  }

  $("#btnTeacherRegister").addEventListener("click", async ()=>{
    try{
      $("#btnTeacherRegister").disabled = true;
      $("#btnTeacherRegister").textContent = "ƒêang t·∫°o...";

      const fullName = getVal("tr_name");
      const phone = getVal("tr_phone");
      const email = getVal("tr_email");
      const password = (document.getElementById("tr_pass")?.value || "");
      const password2 = (document.getElementById("tr_pass2")?.value || "");

      if(!fullName) throw new Error("Thi·∫øu H·ªç v√† t√™n");
      if(!phone) throw new Error("Thi·∫øu S·ªë ƒëi·ªán tho·∫°i");
      if(!password) throw new Error("Thi·∫øu M·∫≠t kh·∫©u");
      if(password !== password2) throw new Error("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp");

      const resp = await apiCall("authTeacherRegister", { fullName, phone, email, password });

      if(!resp || !resp.ok){
        const msg = (resp && resp.error) ? String(resp.error) : "T·∫°o t√†i kho·∫£n th·∫•t b·∫°i";
        const low = msg.toLowerCase();
        if(low.includes("exist") || low.includes("t·ªìn t·∫°i") || low.includes("duplicate") || low.includes("ƒë√£ ƒëƒÉng k√Ω")){
          throw new Error("T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i");
        }
        throw new Error(msg);
      }

      alert("‚úÖ T·∫°o t√†i kho·∫£n gi√°o vi√™n th√†nh c√¥ng!");
      setRegisterMode(false);
      setRoleUI("TEACHER");

      $("#t_username").value = resp.username || phone || email;
      $("#t_password").value = password;

      setTimeout(()=>{ syncAllPwEyes(); }, 0);
      setTimeout(()=>{ const el = document.getElementById("t_username"); if(el) el.focus(); }, 50);

    }catch(err){
      toast("‚ö†Ô∏è " + (err.message || "L·ªói t·∫°o t√†i kho·∫£n"));
    }finally{
      $("#btnTeacherRegister").disabled = false;
      $("#btnTeacherRegister").textContent = "T·∫°o t√†i kho·∫£n";
    }
  });

  async function doLogout(){
    try{
      await apiCall("authLogout", {});
    }catch(e){
    }finally{
      clearSession();
      clearEntry();
      updateTopbar();
      toast("üëã ƒê√£ ƒëƒÉng xu·∫•t");
    }
  }

  function updateTopbar(){
    const badge = $("#topUserBadge");
    const btn = $("#btnLoginTop");
    const user = readJSON(LS.user);
    const sess = getSession();

    if(sess && (sess.token || sess.sessionId) && user && user.role){
      badge.style.display = "inline-flex";
      badge.textContent = `‚úÖ ${ROLE_LABEL[String(user.role).toUpperCase()] || user.role}${user.name ? " ‚Ä¢ " + user.name : ""}`;
      btn.textContent = "ƒêƒÉng xu·∫•t";
      btn.classList.remove("btn-primary");
      btn.classList.add("btnDanger");
      btn.setAttribute("data-state","logout");
    }else{
      badge.style.display = "none";
      btn.textContent = "ƒêƒÉng nh·∫≠p";
      btn.classList.add("btn-primary");
      btn.classList.remove("btnDanger");
      btn.setAttribute("data-state","login");
    }

    const remember = localStorage.getItem(LS.rememberT) === "1";
    $("#t_remember").checked = remember;
    if(remember){
      const u = localStorage.getItem(LS.teacherU) || "";
      const p = localStorage.getItem(LS.teacherP) || "";
      if(u && !$("#t_username").value) $("#t_username").value = u;
      if(p && !$("#t_password").value) $("#t_password").value = p;
    }

    setTimeout(()=>{ syncAllPwEyes(); }, 0);
  }

  (function boot(){
    $("#y").textContent = new Date().getFullYear();

    try{
      if(typeof getConfig === "function"){
        const cfg = getConfig();
        const school = cfg.SCHOOL_NAME || "Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi ‚Äì ƒêi·ªán Bi√™n Ph·ªß";
        safeSetText("schoolName", school);
        safeSetText("schoolName2", school);
        document.title = (cfg.APP_NAME ? cfg.APP_NAME + " ‚Ä¢ " : "") + "C·ªïng th√¥ng tin nh√† tr∆∞·ªùng";
      }
    }catch(e){}

    updateTopbar();
        // ‚úÖ FIX: h·ªó tr·ª£ requireRole() t·ª´ core.js (login=1&role=...&return=...)
    try{
      const u = new URL(location.href);
      const sp = u.searchParams;
      const loginFlag = sp.get("login");
      const roleParam = (sp.get("role") || "").toUpperCase();
      const ret = sp.get("return") || "";

      if(loginFlag === "1"){
        const r = roleParam || (localStorage.getItem(LS.role) || "TEACHER");
        if(ret) setEntryForRole(r, ret);

        // n·∫øu ƒë√£ c√≥ session ƒë√∫ng role th√¨ ƒëi th·∫≥ng lu√¥n
        if(canGo(r)){
          const go = getEntryForRole(r) || DEFAULT_ROUTE[r] || "";
          clearEntry();
          if(go) location.replace(go);
        }else{
          openModal(r);
        }
      }
    }catch(e){}

  })();
</script>

</body>
</html>

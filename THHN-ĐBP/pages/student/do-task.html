<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>H·ªçc sinh ‚Ä¢ L√†m b√†i</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <script src="../../assets/config.js"></script>

  <style>
    /* ===== Topbar (SSOT ‚Äì gi·ªëng dashboard) ===== */
    .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.86);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
    .topbar .inner{max-width:1180px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logoImg{width:40px;height:40px;border-radius:12px;object-fit:cover;display:block}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#fff;background:linear-gradient(135deg,#2563eb,#60a5fa)}
    .btext{min-width:0}
    .bname{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bsub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}

    .navMid{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pills{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;
      font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit
    }
    .pill.active{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 10px 26px rgba(37,99,235,.14)}
    .btnLogout{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;
      font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit
    }

    /* ===== Page ===== */
    .container{max-width:1180px}
    .heroHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:2px 0 12px;border-bottom:1px dashed rgba(148,163,184,.6);margin-bottom:12px
    }
    .heroTitle{margin:0;font-size:34px;letter-spacing:-.02em}
    .heroSub{margin-top:6px}
    .heroRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .chipLite{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);
      border-radius:999px;background:#fff;font-weight:900;font-size:13px;
    }
    .lastUpdate{font-size:12px;color:var(--muted);font-weight:800;white-space:nowrap}

    /* Kid mode */
    body.kid .heroTitle{font-size:30px}
    body.kid .pill, body.kid .btnLogout{font-size:14px;padding:12px 16px}
  </style>
</head>

<body>
<!-- ===== TOPBAR ===== -->
<div class="topbar">
  <div class="inner">
    <div class="brand">
        <div class="btext">
        <div class="bname" id="brandName">‚Äî</div>
        <div class="bsub" id="brandSub">‚Äî</div>
      </div>
    </div>

    <div class="navMid">
      <div class="pills">
        <a class="pill" href="dashboard.html">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
        <a class="pill active" href="do-task.html">L√†m b√†i</a>
        <a class="pill" href="progress.html">Ti·∫øn b·ªô</a>
      </div>
      <a class="btnLogout" href="#" id="btnLogout">ƒêƒÉng xu·∫•t</a>
    </div>
  </div>
</div>

<main class="container">
<section class="card" style="padding:18px;margin-top:14px">

  <!-- ===== HERO ===== -->
  <div class="heroHead">
    <div>
      <h1 class="heroTitle" id="pageTitle">L√†m b√†i</h1>
      <div class="muted heroSub" id="who"></div>
    </div>
    <div class="heroRight">
      <span class="chipLite">üè∑Ô∏è <strong id="studentClass">‚Äî</strong></span>
      <div class="lastUpdate" id="lastUpdate">‚Äî</div>
    </div>
  </div>

  <!-- ===== N·ªòI DUNG ===== -->
  <div class="card" style="padding:16px">
    <div class="field">
      <label>üìò Ch·ªçn b√†i</label>
      <select id="taskSel"><option value="">‚Äî Ch·ªçn b√†i ‚Äî</option></select>
    </div>

    <div class="card" style="padding:12px;background:#f8fafc;border-color:#e2e8f0">
      <div style="font-weight:900" id="taskTitle">‚Äî</div>
      <div class="muted" style="margin:6px 0">N·ªôi dung</div>
      <div style="white-space:pre-wrap;line-height:1.6" id="taskBody">‚Äî</div>
    </div>

    <div class="field" style="margin-top:12px">
      <label>‚úçÔ∏è B√†i l√†m c·ªßa em</label>
      <textarea id="answer" rows="8" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi ·ªü ƒë√¢y‚Ä¶"></textarea>
    </div>

    <div class="actions">
      <button class="btn" id="btnSubmit">N·ªôp b√†i</button>
      <button class="btn secondary" id="btnLoadFeedback" type="button">Xem nh·∫≠n x√©t</button>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:900">üí¨ Nh·∫≠n x√©t</div>
      <div id="feedback" style="white-space:pre-wrap;margin-top:6px">‚Äî</div>
    </div>
  </div>

</section>
</main>

<!-- app.js (index flow) kh√¥ng c·∫ßn cho trang l√†m b√†i, tr√°nh side-effect -->
<script src="../../assets/core.js"></script>
<script src="../../assets/api.js"></script>
<script src="../../assets/student-snippet.js"></script>

<script>
  function fmtTime_(d){
    const p=n=>String(n).padStart(2,"0");
    return `${p(d.getHours())}:${p(d.getMinutes())} - ${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`;
  }

  function getGrade_(cid){
    const m=String(cid||"").match(/^(\d)/);
    return m?Number(m[1]):0;
  }

  async function init_(){
    await studentInit("do-task");
    const s=window.__STU__;
    const cfg=getConfig();
    setBrand_(cfg,s);

    document.getElementById("who").textContent="";
    document.getElementById("studentClass").textContent=s.classId||"‚Äî";
    document.getElementById("lastUpdate").textContent="C·∫≠p nh·∫≠t: "+fmtTime_(new Date());

    const g=getGrade_(s.classId);
    document.body.classList.toggle("kid", g>0 && g<=2);
  }

  /* ===== logic l√†m b√†i gi·ªØ nguy√™n ===== */
  let tasks=[];
  function getParam(n){return new URL(location.href).searchParams.get(n);}

  async function loadTasks_(){
    const s=window.__STU__, token=s.sessionId||s.token||"";
    const r=await api("listTasksForStudent",{token,classId:s.classId,studentId:s.studentId});
    tasks=r.tasks||[];
    const sel=document.getElementById("taskSel");
    sel.innerHTML='<option value="">‚Äî Ch·ªçn b√†i ‚Äî</option>'+tasks.map(t=>`<option value="${t.taskId}">${t.taskId} ‚Ä¢ ${t.topic||""}</option>`).join("");
    const q=getParam("taskId"); if(q) sel.value=q;
    sel.dispatchEvent(new Event("change"));
  }

  document.getElementById("taskSel").onchange=()=>{
    const t=tasks.find(x=>String(x.taskId)===String(taskSel.value));
    taskTitle.textContent=t?.topic||t?.taskId||"‚Äî";
    taskBody.textContent=t?.body||"‚Äî";
    feedback.textContent="‚Äî";
  };

  btnSubmit.onclick=async()=>{
    const s=window.__STU__, token=s.sessionId||s.token||"";
    if(!taskSel.value||!answer.value.trim()) return toast("Ch∆∞a ƒë·ªß th√¥ng tin");
    await api("submitAnswer",{token,classId:s.classId,studentId:s.studentId,taskId:taskSel.value,answer:answer.value.trim()});
    toast("ƒê√£ n·ªôp b√†i ‚úÖ");
  };

  btnLoadFeedback.onclick=async()=>{
    const s=window.__STU__, token=s.sessionId||s.token||"";
    const r=await api("getMyHistory",{token,classId:s.classId,studentId:s.studentId,limit:200});
    const fb=(r.feedbacks||[]).find(x=>String(x.taskId)===String(taskSel.value));
    feedback.textContent=fb?.feedbackHS||"Ch∆∞a c√≥ nh·∫≠n x√©t";
  };

  (async()=>{await init_(); await loadTasks_();})();
</script>
</body>
</html>

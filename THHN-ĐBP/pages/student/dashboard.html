<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HEDU ‚Ä¢ H·ªçc sinh ‚Ä¢ Dashboard</title>
  <link rel="stylesheet" href="../../assets/styles.css">
  <script src="../../assets/config.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo">H</div>
        <div>
          <div class="name" id="brandName"></div>
          <div class="sub" id="brandSub"></div>
        </div>
      </div>
      <a class="smallLink" href="#" id="btnLogout">ƒêƒÉng xu·∫•t</a>
    </div>
  </div>

  <div class="shell">
    <div class="shellTop">
      <div>
        <div style="font-weight:900;font-size:18px">C·ªïng H·ªçc sinh</div>
        <div style="color:var(--muted);font-size:13px" id="who">‚Äî</div>
      </div>
      <div class="pills">
        <a class="pill" href="dashboard.html">Dashboard</a>
        <a class="pill" href="do-task.html">L√†m b√†i</a>
        <a class="pill" href="progress.html">Ti·∫øn b·ªô</a>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="t">B√†i ƒë∆∞·ª£c giao</div><div class="v" id="k_tasks">‚Äî</div></div>
      <div class="kpi"><div class="t">ƒê√£ n·ªôp</div><div class="v" id="k_submitted">‚Äî</div></div>
      <div class="kpi"><div class="t">Nh·∫≠n x√©t</div><div class="v" id="k_feedback">‚Äî</div></div>
    </div>

    <div style="height:12px"></div>

    <div class="card" style="padding:14px">
      <div style="font-weight:900">B√†i c·∫ßn l√†m</div>
      <div style="color:var(--muted);font-size:12px;margin-top:4px">Ch·ªçn m·ªôt b√†i ƒë·ªÉ l√†m v√† n·ªôp.</div>

      <div style="height:10px"></div>
      <table class="table">
        <thead>
          <tr><th>M√£ b√†i</th><th>Ch·ªß ƒë·ªÅ</th><th>M·∫£ng</th><th></th></tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="4" style="color:var(--muted)">Ch∆∞a c√≥ b√†i‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/student-snippet.js"></script>

  <script>
    (async ()=>{
      await studentInit("dashboard");
      const s = window.__STU__;
      const token = s.sessionId || s.token || "";

      try{
        const rTasks = await api("listTasksForStudent", { token, classId:s.classId, studentId:s.studentId });
        const tasks = rTasks.tasks || [];

        const rHist = await api("getMyHistory", { token, classId:s.classId, studentId:s.studentId, limit: 200 });
        const fbs = rHist.feedbacks || [];
        const subs = rHist.submissions || [];

        const submittedSet = new Set(subs.map(x=> String(x.taskId||"").trim()).filter(Boolean));
        const need = tasks.filter(t => !submittedSet.has(String(t.taskId||"").trim()));

        document.getElementById("k_tasks").textContent = tasks.length;
        document.getElementById("k_submitted").textContent = submittedSet.size;
        document.getElementById("k_feedback").textContent = fbs.length;

        const tb = document.getElementById("rows");
        if(!need.length){
          tb.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Kh√¥ng c√≤n b√†i c·∫ßn l√†m üéâ</td></tr>`;
          return;
        }

        tb.innerHTML = need.map(t=>`
          <tr>
            <td>${t.taskId||"‚Äî"}</td>
            <td>${t.topic||t.unit||"‚Äî"}</td>
            <td>${t.domain||"‚Äî"}</td>
            <td><a class="smallLink" href="do-task.html?taskId=${encodeURIComponent(t.taskId)}">L√†m b√†i</a></td>
          </tr>
        `).join("");
      }catch(e){
        toast(e.message || "Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.");
      }
    })();
  </script>
</body>
</html>

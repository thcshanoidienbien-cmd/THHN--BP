<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Há»c sinh â€¢ Báº£ng Ä‘iá»u khiá»ƒn</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <script src="../../assets/config.js"></script>

  <style>
    .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.86);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
    .topbar .inner{max-width:1180px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#fff;background:linear-gradient(135deg,#2563eb,#60a5fa)}
    .logoImg{width:40px;height:40px;border-radius:12px;object-fit:cover;display:block}
    .btext{min-width:0}
    .bname{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bsub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}

    .navMid{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pills{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit}
    .pill.active{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 10px 26px rgba(37,99,235,.14)}
    .rightActions{display:flex;align-items:center;gap:10px}
    .btnLogout{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit}

    .container{max-width:1180px}
    .heroHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:2px 0 12px;border-bottom:1px dashed rgba(148,163,184,.6);margin-bottom:12px}
    .heroTitle{margin:0;font-size:34px;letter-spacing:-.02em}
    .heroSub{margin-top:6px}
    .heroRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chipLite{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:900;font-size:13px;white-space:nowrap;box-shadow:0 8px 22px rgba(15,23,42,.04)}
    .lastUpdate{font-size:12px;color:var(--muted);font-weight:800;text-align:right;white-space:nowrap}

    .gridKpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.gridKpi{grid-template-columns:1fr}}
    .kpiCard{padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .kpiCard .t{color:var(--muted);font-size:12px;font-weight:900;white-space:nowrap}
    .kpiCard .v{font-size:22px;font-weight:900;margin-top:6px}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}

    /* Kid mode */
    body.kid .heroTitle{font-size:30px}
    body.kid .pill, body.kid .btnLogout{font-size:14px;padding:12px 16px}
    body.kid .chipLite{font-size:14px;padding:10px 14px}
    body.kid .kpiCard .t{font-size:13px}
    body.kid .kpiCard .v{font-size:26px}
    body.kid .dcard{border-radius:20px}
    body.kid .muted{font-size:13px}

    .taskCards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:900px){.taskCards{grid-template-columns:1fr}}
    .taskCard{border:1px solid var(--line);border-radius:18px;background:#fff;padding:14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .taskCard .left{min-width:0}
    .taskCard .title{font-weight:900;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .taskCard .meta{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35}
    .taskCard .go{white-space:nowrap;border:1px solid var(--line);border-radius:999px;padding:10px 12px;font-weight:900;text-decoration:none;color:#fff;background:var(--primary);box-shadow:0 10px 26px rgba(37,99,235,.14)}

    .hidden{display:none !important}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="btext">
          <div class="bname" id="brandName">â€”</div>
          <div class="bsub" id="brandSub">â€”</div>
        </div>
      </div>

      <div class="navMid">
        <div class="pills">
          <a class="pill" href="dashboard.html">Báº£ng Ä‘iá»u khiá»ƒn</a>
          <a class="pill" href="do-task.html">LÃ m bÃ i</a>
          <a class="pill" href="progress.html">Tiáº¿n bá»™</a>
        </div>
        <div class="rightActions">
          <a class="btnLogout" href="#" id="btnLogout">ÄÄƒng xuáº¥t</a>
        </div>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="card" style="padding:18px;margin-top:14px">
      <div class="heroHead">
        <div>
          <h1 class="heroTitle" id="pageTitle">Trang Há»c sinh</h1>
          <div class="muted heroSub" id="who">â€”</div>
        </div>

        <div class="heroRight">
          <div class="chips">
            <span class="chipLite" id="chipClass">ğŸ·ï¸ <strong id="studentClass">â€”</strong></span>
          </div>
          <div class="lastUpdate" id="lastUpdate">Cáº­p nháº­t láº§n cuá»‘i: â€”</div>
        </div>
      </div>

      <div class="dcard">
        <div style="font-weight:900" id="overviewTitle">ğŸ“’ Tá»•ng quan há»c táº­p</div>
        <div class="muted" style="margin-top:6px" id="overviewSub">Thá»‘ng kÃª nhanh dá»±a trÃªn bÃ i Ä‘Æ°á»£c giao, lá»‹ch sá»­ ná»™p vÃ  nháº­n xÃ©t.</div>

        <div class="gridKpi mt">
          <div class="kpiCard">
            <div class="t" id="kpi1t">ğŸ“š BÃ i Ä‘Æ°á»£c giao</div>
            <div class="v" id="k_tasks">â€”</div>
          </div>
          <div class="kpiCard">
            <div class="t" id="kpi2t">ğŸ“¨ Con Ä‘Ã£ ná»™p</div>
            <div class="v" id="k_submitted">â€”</div>
          </div>
          <div class="kpiCard">
            <div class="t" id="kpi3t">ğŸ’¬ Lá»i nháº­n xÃ©t</div>
            <div class="v" id="k_feedback">â€”</div>
          </div>
        </div>

        <div class="muted mt hidden" id="kidLine" style="font-weight:900"></div>
      </div>

      <div style="height:12px"></div>

      <div class="dcard">
        <div class="row">
          <div>
            <div style="font-weight:900" id="needTitle">ğŸ‘¨â€ğŸ“ BÃ i cáº§n lÃ m</div>
            <div class="muted" style="font-size:12px;margin-top:4px" id="needSub">Chá»n má»™t bÃ i Ä‘á»ƒ lÃ m vÃ  ná»™p. Danh sÃ¡ch tá»± áº©n cÃ¡c bÃ i Ä‘Ã£ ná»™p.</div>
          </div>
          <button class="btn" id="btnReload" type="button">Táº£i láº¡i</button>
        </div>

        <div class="divider"></div>

        <table class="table" id="tableWrap">
          <thead>
            <tr><th>MÃ£ bÃ i</th><th>Chá»§ Ä‘á»</th><th>Máº£ng</th><th></th></tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="4" style="color:var(--muted)">ChÆ°a cÃ³ bÃ iâ€¦</td></tr>
          </tbody>
        </table>

        <div id="cardsWrap" class="taskCards hidden"></div>

        <div class="muted" style="margin-top:10px;font-size:12px;font-weight:800" id="tipLine">
          Máº¹o: Náº¿u em Ä‘Ã£ lÃ m xong, hÃ£y sang má»¥c <b>Tiáº¿n bá»™</b> Ä‘á»ƒ xem nháº­n xÃ©t vÃ  Ä‘iá»ƒm.
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <script src="../../assets/app.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/student-snippet.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"â€”";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }

    function fmtTime_(d){
      const pad=n=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())} - ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }

    function getGradeFromClassId_(classId){
      const s = String(classId||"").trim();
      const m = s.match(/^(\d)/);
      const g = m ? Number(m[1]) : 0;
      return (g>=1 && g<=5) ? g : 0;
    }

    function applyKidModeUI_(grade){
      const isKid = grade > 0 && grade <= 2;
      document.body.classList.toggle("kid", isKid);

      if(isKid){
        document.getElementById("pageTitle").textContent = "GÃ³c há»c táº­p cá»§a con âœ¨";
        document.getElementById("overviewTitle").textContent = "ğŸ“’ HÃ´m nay con há»c gÃ¬?";
        document.getElementById("overviewSub").textContent = "Con xem bÃ i cáº§n lÃ m vÃ  báº¥m â€œLÃ m bÃ iâ€ nhÃ© ğŸ˜Š";
        document.getElementById("needTitle").textContent = "ğŸ§¸ BÃ i con cáº§n lÃ m";
        document.getElementById("needSub").textContent = "Chá»n 1 bÃ i Ä‘á»ƒ lÃ m vÃ  ná»™p. CÃ¡c bÃ i Ä‘Ã£ ná»™p sáº½ tá»± áº©n.";
        document.getElementById("btnReload").textContent = "LÃ m má»›i ğŸ”„";
        document.getElementById("tipLine").innerHTML = "Máº¹o: Xong rá»“i nhá»› sang <b>Tiáº¿n bá»™</b> Ä‘á»ƒ xem lá»i nháº­n xÃ©t nha ğŸ’¬";
      }else{
        document.getElementById("pageTitle").textContent = "Trang Há»c sinh";
        document.getElementById("overviewTitle").textContent = "ğŸ“’ Tá»•ng quan há»c táº­p";
        document.getElementById("overviewSub").textContent = "Thá»‘ng kÃª nhanh dá»±a trÃªn bÃ i Ä‘Æ°á»£c giao, lá»‹ch sá»­ ná»™p vÃ  nháº­n xÃ©t.";
        document.getElementById("needTitle").textContent = "ğŸ‘¨â€ğŸ“ BÃ i cáº§n lÃ m";
        document.getElementById("needSub").textContent = "Chá»n má»™t bÃ i Ä‘á»ƒ lÃ m vÃ  ná»™p. Danh sÃ¡ch tá»± áº©n cÃ¡c bÃ i Ä‘Ã£ ná»™p.";
        document.getElementById("btnReload").textContent = "Táº£i láº¡i";
        document.getElementById("tipLine").innerHTML = "Máº¹o: Náº¿u em Ä‘Ã£ lÃ m xong, hÃ£y sang má»¥c <b>Tiáº¿n bá»™</b> Ä‘á»ƒ xem nháº­n xÃ©t vÃ  Ä‘iá»ƒm.";
      }
      return isKid;
    }

    function renderTasksStandard_(need){
      const tb = document.getElementById("rows");
      if(!need.length){
        tb.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">KhÃ´ng cÃ²n bÃ i cáº§n lÃ m ğŸ‰</td></tr>`;
        return;
      }
      tb.innerHTML = need.map(t=>`
        <tr>
          <td>${t.taskId||"â€”"}</td>
          <td>${t.topic||t.unit||"â€”"}</td>
          <td>${t.domain||"â€”"}</td>
          <td><a class="smallLink" href="do-task.html?taskId=${encodeURIComponent(t.taskId)}">LÃ m bÃ i</a></td>
        </tr>
      `).join("");
    }

    function renderTasksKid_(need){
      const wrap = document.getElementById("cardsWrap");
      if(!need.length){
        wrap.innerHTML = `
          <div class="taskCard">
            <div class="left">
              <div class="title">ğŸ‰ HÃ´m nay con xong rá»“i!</div>
              <div class="meta">Con cÃ³ thá»ƒ sang má»¥c <b>Tiáº¿n bá»™</b> Ä‘á»ƒ xem lá»i nháº­n xÃ©t ğŸ’¬</div>
            </div>
            <a class="go" href="progress.html">Xem Tiáº¿n bá»™</a>
          </div>
        `;
        return;
      }
      wrap.innerHTML = need.map(t=>{
        const topic = (t.topic||t.unit||"BÃ i táº­p");
        const domain = (t.domain||"");
        return `
          <div class="taskCard">
            <div class="left">
              <div class="title">ğŸ“˜ ${topic}</div>
              <div class="meta">
                MÃ£ bÃ i: <b>${t.taskId||"â€”"}</b>${domain ? `<br/>Máº£ng: <b>${domain}</b>` : ""}
              </div>
            </div>
            <a class="go" href="do-task.html?taskId=${encodeURIComponent(t.taskId)}">LÃ m bÃ i</a>
          </div>
        `;
      }).join("");
    }

    async function loadData_(){
      const s = window.__STU__;
      if(!s) return;

      const who = document.getElementById("who");
      if(who) who.textContent = "";

      document.getElementById("studentClass").textContent = (s.classId||"â€”");

      const grade = getGradeFromClassId_(s.classId);
      const isKid = applyKidModeUI_(grade);

      document.getElementById("lastUpdate").textContent = "Cáº­p nháº­t láº§n cuá»‘i: " + fmtTime_(new Date());

      document.getElementById("tableWrap").classList.toggle("hidden", isKid);
      document.getElementById("cardsWrap").classList.toggle("hidden", !isKid);

      const token = s.sessionId || s.token || "";

      try{
        const rTasks = await api("listTasksForStudent", { token, classId:s.classId, studentId:s.studentId });
        const tasks = rTasks.tasks || [];

        const rHist = await api("getMyHistory", { token, classId:s.classId, studentId:s.studentId, limit: 200 });
        const fbs = rHist.feedbacks || [];
        const subs = rHist.submissions || [];

        const submittedSet = new Set(subs.map(x=> String(x.taskId||"").trim()).filter(Boolean));
        const need = tasks.filter(t => !submittedSet.has(String(t.taskId||"").trim()));

        document.getElementById("k_tasks").textContent = tasks.length;
        document.getElementById("k_submitted").textContent = submittedSet.size;
        document.getElementById("k_feedback").textContent = fbs.length;

        const kidLine = document.getElementById("kidLine");
        if(isKid){
          kidLine.classList.remove("hidden");
          kidLine.textContent = `ğŸŒŸ HÃ´m nay con cÃ²n ${need.length} bÃ i cáº§n lÃ m nhÃ©!`;
        }else{
          kidLine.classList.add("hidden");
        }

        if(isKid) renderTasksKid_(need);
        else renderTasksStandard_(need);

      }catch(e){
        toast(e.message || "KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u.");
      }
    }

    (async ()=>{
      await studentInit("dashboard");
      document.getElementById("btnReload").onclick = loadData_;
      await loadData_();
    })();
  </script>
</body>
</html>

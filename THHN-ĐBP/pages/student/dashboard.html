<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>H·ªçc sinh ‚Ä¢ B·∫£ng ƒëi·ªÅu khi·ªÉn</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <script src="../../assets/config.js"></script>

  <style>
    /* ===== Topbar (gi·ªëng tinh th·∫ßn index/teacher) ===== */
    .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.86);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
    .topbar .inner{max-width:1180px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#fff;background:linear-gradient(135deg,#2563eb,#60a5fa)}
    .logoImg{width:40px;height:40px;border-radius:12px;object-fit:cover;display:block}
    .btext{min-width:0}
    .bname{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bsub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}

    .navMid{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pills{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;
      font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit
    }
    .pill.active{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 10px 26px rgba(37,99,235,.14)}
    .rightActions{display:flex;align-items:center;gap:10px}
    .btnLogout{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;
      font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit
    }

    /* ===== Page ===== */
    .container{max-width:1180px}
    .heroHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:2px 0 12px;border-bottom:1px dashed rgba(148,163,184,.6);margin-bottom:12px
    }
    .heroTitle{margin:0;font-size:34px;letter-spacing:-.02em}
    .heroSub{margin-top:6px}
    .heroRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chipLite{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);
      border-radius:999px;background:#fff;font-weight:900;font-size:13px;white-space:nowrap;
      box-shadow:0 8px 22px rgba(15,23,42,.04)
    }
    .lastUpdate{font-size:12px;color:var(--muted);font-weight:800;text-align:right;white-space:nowrap}

    .gridKpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.gridKpi{grid-template-columns:1fr}}
    .kpiCard{padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .kpiCard .t{color:var(--muted);font-size:12px;font-weight:900;white-space:nowrap}
    .kpiCard .v{font-size:22px;font-weight:900;margin-top:6px}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}

    /* ===== Kid mode ===== */
    body.kid .heroTitle{font-size:30px}
    body.kid .pill, body.kid .btnLogout{font-size:14px;padding:12px 16px}
    body.kid .chipLite{font-size:14px;padding:10px 14px}
    body.kid .kpiCard .t{font-size:13px}
    body.kid .kpiCard .v{font-size:26px}
    body.kid .dcard{border-radius:20px}
    body.kid .muted{font-size:13px}

    /* Card list for Kid mode */
    .taskCards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:900px){.taskCards{grid-template-columns:1fr}}
    .taskCard{
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      padding:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .taskCard .left{min-width:0}
    .taskCard .title{font-weight:900;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .taskCard .meta{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35}
    .taskCard .go{
      white-space:nowrap;
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      text-decoration:none;
      color:#fff;
      background:var(--primary);
      box-shadow:0 10px 26px rgba(37,99,235,.14)
    }

    /* hide helpers */
    .hidden{display:none !important}
  </style>
</head>

<body>
  <!-- ===== TOPBAR ===== -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
          <div class="btext">
          <!-- ‚úÖ Theo y√™u c·∫ßu: d√≤ng 1 = T√äN TR∆Ø·ªúNG, d√≤ng 2 = T√äN H·ªåC SINH -->
          <div class="bname" id="brandName">‚Äî</div>
          <div class="bsub" id="brandSub">‚Äî</div>
        </div>
      </div>

      <div class="navMid">
        <div class="pills">
          <a class="pill" href="dashboard.html">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
          <a class="pill" href="do-task.html">L√†m b√†i</a>
          <a class="pill" href="progress.html">Ti·∫øn b·ªô</a>
        </div>

        <div class="rightActions">
          <a class="btnLogout" href="#" id="btnLogout">ƒêƒÉng xu·∫•t</a>
        </div>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="card" style="padding:18px;margin-top:14px">

      <!-- ===== HERO ===== -->
      <div class="heroHead">
        <div>
          <h1 class="heroTitle" id="pageTitle">Trang H·ªçc sinh</h1>
          <div class="muted heroSub" id="who">‚Äî</div>
        </div>

        <!-- ‚úÖ Ch·ªâ hi·ªÉn th·ªã chip L·ªöP b√™n ph·∫£i (kh√¥ng l·∫∑p ‚ÄúH·ªçc sinh ‚Ä¢ 5A1‚Äù tr√™n menu) -->
        <div class="heroRight">
          <div class="chips">
            <span class="chipLite" id="chipClass">üè∑Ô∏è <strong id="studentClass">‚Äî</strong></span>
          </div>
          <div class="lastUpdate" id="lastUpdate">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ‚Äî</div>
        </div>
      </div>

      <!-- ===== T·ªïng quan ===== -->
      <div class="dcard">
        <div style="font-weight:900" id="overviewTitle">üìí T·ªïng quan h·ªçc t·∫≠p</div>
        <div class="muted" style="margin-top:6px" id="overviewSub">Th·ªëng k√™ nhanh d·ª±a tr√™n b√†i ƒë∆∞·ª£c giao, l·ªãch s·ª≠ n·ªôp v√† nh·∫≠n x√©t.</div>

        <div class="gridKpi mt">
          <div class="kpiCard">
            <div class="t" id="kpi1t">üìö B√†i ƒë∆∞·ª£c giao</div>
            <div class="v" id="k_tasks">‚Äî</div>
          </div>
          <div class="kpiCard">
            <div class="t" id="kpi2t">üì® Con ƒë√£ n·ªôp</div>
            <div class="v" id="k_submitted">‚Äî</div>
          </div>
          <div class="kpiCard">
            <div class="t" id="kpi3t">üí¨ L·ªùi nh·∫≠n x√©t</div>
            <div class="v" id="k_feedback">‚Äî</div>
          </div>
        </div>

        <!-- Kid-only friendly line -->
        <div class="muted mt hidden" id="kidLine" style="font-weight:900"></div>
      </div>

      <div style="height:12px"></div>

      <!-- ===== B√†i c·∫ßn l√†m ===== -->
      <div class="dcard">
        <div class="row">
          <div>
            <div style="font-weight:900" id="needTitle">üë®‚Äçüéì B√†i c·∫ßn l√†m</div>
            <div class="muted" style="font-size:12px;margin-top:4px" id="needSub">
              Ch·ªçn m·ªôt b√†i ƒë·ªÉ l√†m v√† n·ªôp. Danh s√°ch t·ª± ·∫©n c√°c b√†i ƒë√£ n·ªôp.
            </div>
          </div>
          <button class="btn" id="btnReload" type="button">T·∫£i l·∫°i</button>
        </div>

        <div class="divider"></div>

        <!-- Standard: table -->
        <table class="table" id="tableWrap">
          <thead>
            <tr><th>M√£ b√†i</th><th>Ch·ªß ƒë·ªÅ</th><th>M·∫£ng</th><th></th></tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="4" style="color:var(--muted)">Ch∆∞a c√≥ b√†i‚Ä¶</td></tr>
          </tbody>
        </table>

        <!-- Kid: cards -->
        <div id="cardsWrap" class="taskCards hidden"></div>

        <div class="muted" style="margin-top:10px;font-size:12px;font-weight:800" id="tipLine">
          M·∫πo: N·∫øu em ƒë√£ l√†m xong, h√£y sang m·ª•c <b>Ti·∫øn b·ªô</b> ƒë·ªÉ xem nh·∫≠n x√©t v√† ƒëi·ªÉm.
        </div>
      </div>

    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <script src="../../assets/app.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/student-snippet.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"‚Äî";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }

    function fmtTime_(d){
      const pad=n=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())} - ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }

    function getGradeFromClassId_(classId){
      // ∆Øu ti√™n format "1A1..5A1"
      const s = String(classId||"").trim();
      const m = s.match(/^(\d)/);
      const g = m ? Number(m[1]) : 0;
      return (g>=1 && g<=5) ? g : 0;
    }

    function applyKidModeUI_(grade){
      const isKid = grade > 0 && grade <= 2;
      document.body.classList.toggle("kid", isKid);

      // Copywriting theo l·ª©a tu·ªïi
      if(isKid){
        document.getElementById("pageTitle").textContent = "G√≥c h·ªçc t·∫≠p c·ªßa con ‚ú®";
        document.getElementById("overviewTitle").textContent = "üìí H√¥m nay con h·ªçc g√¨?";
        document.getElementById("overviewSub").textContent = "Con xem b√†i c·∫ßn l√†m v√† b·∫•m ‚ÄúL√†m b√†i‚Äù nh√© üòä";
        document.getElementById("needTitle").textContent = "üß∏ B√†i con c·∫ßn l√†m";
        document.getElementById("needSub").textContent = "Ch·ªçn 1 b√†i ƒë·ªÉ l√†m v√† n·ªôp. C√°c b√†i ƒë√£ n·ªôp s·∫Ω t·ª± ·∫©n.";
        document.getElementById("btnReload").textContent = "L√†m m·ªõi üîÑ";
        document.getElementById("tipLine").innerHTML = "M·∫πo: Xong r·ªìi nh·ªõ sang <b>Ti·∫øn b·ªô</b> ƒë·ªÉ xem l·ªùi nh·∫≠n x√©t nha üí¨";
      }else{
        // Standard (gi·ªØ ƒë√∫ng nh∆∞ hi·ªán t·∫°i)
        document.getElementById("pageTitle").textContent = "Trang H·ªçc sinh";
        document.getElementById("overviewTitle").textContent = "üìí T·ªïng quan h·ªçc t·∫≠p";
        document.getElementById("overviewSub").textContent = "Th·ªëng k√™ nhanh d·ª±a tr√™n b√†i ƒë∆∞·ª£c giao, l·ªãch s·ª≠ n·ªôp v√† nh·∫≠n x√©t.";
        document.getElementById("needTitle").textContent = "üë®‚Äçüéì B√†i c·∫ßn l√†m";
        document.getElementById("needSub").textContent = "Ch·ªçn m·ªôt b√†i ƒë·ªÉ l√†m v√† n·ªôp. Danh s√°ch t·ª± ·∫©n c√°c b√†i ƒë√£ n·ªôp.";
        document.getElementById("btnReload").textContent = "T·∫£i l·∫°i";
        document.getElementById("tipLine").innerHTML = "M·∫πo: N·∫øu em ƒë√£ l√†m xong, h√£y sang m·ª•c <b>Ti·∫øn b·ªô</b> ƒë·ªÉ xem nh·∫≠n x√©t v√† ƒëi·ªÉm.";
      }

      return isKid;
    }

      function renderTasksStandard_(need){
      const tb = document.getElementById("rows");
      if(!need.length){
        tb.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Kh√¥ng c√≤n b√†i c·∫ßn l√†m üéâ</td></tr>`;
        return;
      }
      tb.innerHTML = need.map(t=>`
        <tr>
          <td>${t.taskId||"‚Äî"}</td>
          <td>${t.topic||t.unit||"‚Äî"}</td>
          <td>${t.domain||"‚Äî"}</td>
          <td><a class="smallLink" href="do-task.html?taskId=${encodeURIComponent(t.taskId)}">L√†m b√†i</a></td>
        </tr>
      `).join("");
    }

    function renderTasksKid_(need){
      const wrap = document.getElementById("cardsWrap");
      if(!need.length){
        wrap.innerHTML = `
          <div class="taskCard">
            <div class="left">
              <div class="title">üéâ H√¥m nay con xong r·ªìi!</div>
              <div class="meta">Con c√≥ th·ªÉ sang m·ª•c <b>Ti·∫øn b·ªô</b> ƒë·ªÉ xem l·ªùi nh·∫≠n x√©t üí¨</div>
            </div>
            <a class="go" href="progress.html">Xem Ti·∫øn b·ªô</a>
          </div>
        `;
        return;
      }
      wrap.innerHTML = need.map(t=>{
        const topic = (t.topic||t.unit||"B√†i t·∫≠p");
        const domain = (t.domain||"");
        return `
          <div class="taskCard">
            <div class="left">
              <div class="title">üìò ${topic}</div>
              <div class="meta">
                M√£ b√†i: <b>${t.taskId||"‚Äî"}</b>${domain ? `<br/>M·∫£ng: <b>${domain}</b>` : ""}
              </div>
            </div>
            <a class="go" href="do-task.html?taskId=${encodeURIComponent(t.taskId)}">L√†m b√†i</a>
          </div>
        `;
      }).join("");
    }

    async function loadData_(){
      const s = window.__STU__;
      if(!s) return;

      const cfg = (typeof getConfig === "function") ? getConfig() : {};
      setBrand_(cfg, s);

      // Who line (nh·∫π nh√†ng)
      const who = document.getElementById("who");
      if(who) who.textContent = ""; // ‚úÖ kh√¥ng hi·ªán ‚ÄúH·ªçc sinh ‚Ä¢ 5A1‚Äù

      // Chip l·ªõp (b√™n ph·∫£i)
      document.getElementById("studentClass").textContent = (s.classId||"‚Äî");

      const grade = getGradeFromClassId_(s.classId);
      const isKid = applyKidModeUI_(grade);

      document.getElementById("lastUpdate").textContent = "C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: " + fmtTime_(new Date());

      // Toggle list layout
      document.getElementById("tableWrap").classList.toggle("hidden", isKid);
      document.getElementById("cardsWrap").classList.toggle("hidden", !isKid);

      const token = s.sessionId || s.token || "";

      try{
        const rTasks = await api("listTasksForStudent", { token, classId:s.classId, studentId:s.studentId });
        const tasks = rTasks.tasks || [];

        const rHist = await api("getMyHistory", { token, classId:s.classId, studentId:s.studentId, limit: 200 });
        const fbs = rHist.feedbacks || [];
        const subs = rHist.submissions || [];

        const submittedSet = new Set(subs.map(x=> String(x.taskId||"").trim()).filter(Boolean));
        const need = tasks.filter(t => !submittedSet.has(String(t.taskId||"").trim()));

        document.getElementById("k_tasks").textContent = tasks.length;
        document.getElementById("k_submitted").textContent = submittedSet.size;
        document.getElementById("k_feedback").textContent = fbs.length;

        // Kid friendly line
        const kidLine = document.getElementById("kidLine");
        if(isKid){
          kidLine.classList.remove("hidden");
          kidLine.textContent = `üåü H√¥m nay con c√≤n ${need.length} b√†i c·∫ßn l√†m nh√©!`;
        }else{
          kidLine.classList.add("hidden");
        }

        if(isKid) renderTasksKid_(need);
        else renderTasksStandard_(need);

      }catch(e){
        toast(e.message || "Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.");
      }
    }

    (async ()=>{
      await studentInit("dashboard"); // ‚úÖ wire logout -> ../../index.html
      document.getElementById("btnReload").onclick = loadData_;
      await loadData_();
    })();
  </script>
</body>
</html>

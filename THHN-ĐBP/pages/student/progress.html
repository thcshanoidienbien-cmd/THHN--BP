<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>H·ªçc sinh ‚Ä¢ Ti·∫øn b·ªô</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <script src="../../assets/config.js"></script>

  <style>
    /* ===== Topbar (SSOT ‚Äì ƒë·ªìng b·ªô Dashboard/Do-task) ===== */
    .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.86);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
    .topbar .inner{max-width:1180px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#fff;background:linear-gradient(135deg,#2563eb,#60a5fa)}
    .logoImg{width:40px;height:40px;border-radius:12px;object-fit:cover;display:block}
    .btext{min-width:0}
    .bname{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bsub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}

    .navMid{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pills{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit}
    .pill.active{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 10px 26px rgba(37,99,235,.14)}
    .btnLogout{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:13px;white-space:nowrap;text-decoration:none;color:inherit}

    /* ===== Page ===== */
    .container{max-width:1180px}
    .heroHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:2px 0 12px;border-bottom:1px dashed rgba(148,163,184,.6);margin-bottom:12px}
    .heroTitle{margin:0;font-size:34px;letter-spacing:-.02em}
    .heroSub{margin-top:6px;color:var(--muted)}
    .heroRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chipLite{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:900;font-size:13px;white-space:nowrap;box-shadow:0 8px 22px rgba(15,23,42,.04)}
    .lastUpdate{font-size:12px;color:var(--muted);font-weight:800;text-align:right;white-space:nowrap}

    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}

    /* Mobile */
    @media(max-width:720px){
      .heroTitle{font-size:28px}
      .navMid{gap:8px}
      .pill,.btnLogout{padding:10px 12px}
    }
  </style>
</head>

<body>
  <!-- ===== TOPBAR ===== -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
         <div class="btext">
          <!-- d√≤ng 1 = T√äN TR∆Ø·ªúNG; d√≤ng 2 = T√äN H·ªåC SINH -->
          <div class="bname" id="brandName">‚Äî</div>
          <div class="bsub" id="brandSub">‚Äî</div>
        </div>
      </div>

      <div class="navMid">
        <div class="pills">
          <a class="pill" href="dashboard.html">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
          <a class="pill" href="do-task.html">L√†m b√†i</a>
          <a class="pill active" href="progress.html">Ti·∫øn b·ªô</a>
        </div>
        <a class="btnLogout" href="#" id="btnLogout">ƒêƒÉng xu·∫•t</a>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="card" style="padding:18px;margin-top:14px">

      <!-- ===== HERO ===== -->
      <div class="heroHead">
        <div>
          <h1 class="heroTitle">Ti·∫øn b·ªô h·ªçc t·∫≠p</h1>
          <div class="heroSub" id="heroSub">üå± M·ªói d√≤ng l√† m·ªôt tu·∫ßn h·ªçc c·ªßa con. N·ªôp b√†i ƒë·ªÅu ƒë·∫∑n l√† con ƒëang ti·∫øn b·ªô ƒë√≥ nha!</div>
        </div>
        <div class="heroRight">
          <div class="chips">
            <span class="chipLite">üè∑Ô∏è <strong id="studentClass">‚Äî</strong></span>
          </div>
          <div class="lastUpdate" id="lastUpdate">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ‚Äî</div>
        </div>
      </div>

      <!-- ===== CONTENT ===== -->
      <div class="dcard">
        <div style="font-weight:900">üìä T·ªïng h·ª£p theo tu·∫ßn</div>
        <div class="muted" style="margin-top:6px">D·ª±a tr√™n l·ªãch s·ª≠ n·ªôp b√†i v√† nh·∫≠n x√©t c·ªßa gi√°o vi√™n.</div>

        <div class="divider"></div>

        <table class="table">
          <thead>
            <tr>
              <th>Tu·∫ßn</th>
              <th>ƒê√£ n·ªôp</th>
              <th>Nh·∫≠n x√©t</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="4" style="color:var(--muted)">Ch∆∞a c√≥ d·ªØ li·ªáu‚Ä¶</td></tr>
          </tbody>
        </table>

        <div class="muted" style="margin-top:10px;font-size:12px;font-weight:800">
          ‚ÑπÔ∏è M·∫πo: Con sang m·ª•c <b>L√†m b√†i</b> ƒë·ªÉ n·ªôp b√†i, r·ªìi quay l·∫°i ƒë√¢y xem ti·∫øn b·ªô theo t·ª´ng tu·∫ßn nh√©.
        </div>
      </div>

    </section>
  </main>

  <script src="../../assets/app.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/student-snippet.js"></script>

  <script>
    function weekKey_(iso){
      const d = new Date(iso);
      if (isNaN(d)) return "‚Äî";
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
      return `${date.getUTCFullYear()}-W${("0"+weekNo).slice(-2)}`;
    }

    function fmtTime_(d){
      const p=n=>String(n).padStart(2,"0");
      return `${p(d.getHours())}:${p(d.getMinutes())} - ${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`;
    }

    function getGradeFromClassId_(classId){
      const s = String(classId||"").trim();
      const m = s.match(/^(\d)/);
      const g = m ? Number(m[1]) : 0;
      return (g>=1 && g<=5) ? g : 0;
    }

    (async ()=>{
      await studentInit("progress");
      const s = window.__STU__;
      if(!s) return;

      const cfg = (typeof getConfig === "function") ? (getConfig()||{}) : {};
      // SSOT brand (logo + school + student)
      try{ if(typeof setBrand_ === "function") setBrand_(cfg, s); }catch(_){
        document.getElementById("brandName").textContent = cfg.SCHOOL_NAME || "‚Äî";
        document.getElementById("brandSub").textContent = s.displayName || s.name || "H·ªçc sinh";
      }

      document.getElementById("studentClass").textContent = s.classId || "‚Äî";
      document.getElementById("lastUpdate").textContent = "C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: " + fmtTime_(new Date());

      // Kid copy nh·∫π nh√†ng
      const g = getGradeFromClassId_(s.classId);
      if(g>0 && g<=2){
        document.getElementById("heroSub").textContent = "üåü Con l√†m b√†i ƒë·ªÅu l√† gi·ªèi l·∫Øm! M·ªói d√≤ng l√† 1 tu·∫ßn h·ªçc c·ªßa con nha.";
      }

      const token = s.sessionId || s.token || "";

      try{
        const r = await api("getMyHistory", { token, classId:s.classId, studentId:s.studentId, limit: 400 });
        const subs = r.submissions || [];
        const fbs  = r.feedbacks || [];

        const byWeek = {};
        subs.forEach(x=>{
          const k = weekKey_(x.createdAt);
          byWeek[k] = byWeek[k] || { submitted:0, feedback:0 };
          byWeek[k].submitted++;
        });
        fbs.forEach(x=>{
          const k = weekKey_(x.createdAt);
          byWeek[k] = byWeek[k] || { submitted:0, feedback:0 };
          byWeek[k].feedback++;
        });

        const keys = Object.keys(byWeek).filter(k=>k!=="‚Äî").sort().reverse();
        const tb = document.getElementById("rows");
        if(!keys.length){
          tb.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Ch∆∞a c√≥ d·ªØ li·ªáu‚Ä¶</td></tr>`;
          return;
        }

        tb.innerHTML = keys.map(k=>{
          const it = byWeek[k];
          const note = it.feedback ? "C√≥ nh·∫≠n x√©t ‚úÖ" : (it.submitted ? "ƒê√£ n·ªôp, ch·ªù nh·∫≠n x√©t ‚è≥" : "‚Äî");
          return `<tr>
            <td>${k}</td>
            <td>${it.submitted}</td>
            <td>${it.feedback}</td>
            <td>${note}</td>
          </tr>`;
        }).join("");

      }catch(e){
        // gi·ªØ im l·∫∑ng ƒë·ªÉ kh√¥ng ph√° UX; b·∫£ng gi·ªØ tr·∫°ng th√°i "Ch∆∞a c√≥ d·ªØ li·ªáu"
      }
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thi·∫øt l·∫≠p h·ªá th·ªëng</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#2563eb"/>

  <style>
    /* ===== ƒê·ªìng b·ªô style theo admin/dashboard (Pro) ===== */
    .grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}

    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}

    .heroHead{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; padding:2px 0 12px;
      border-bottom:1px dashed rgba(148,163,184,.6);
      margin-bottom:12px;
    }
    .heroTitle{margin:0; font-size:34px; letter-spacing:-.02em}
    .heroSub{margin-top:6px}
    .heroRight{display:flex; flex-direction:column; align-items:flex-end; gap:8px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chipLite{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      font-weight:900;
      font-size:13px;
      box-shadow: 0 8px 22px rgba(15,23,42,.04);
      white-space:nowrap;
    }
    .lastUpdate{
      font-size:12px; color:var(--muted);
      font-weight:800; text-align:right; max-width:420px;
    }

    /* nav chips click effect (menu + logout) */
    .nav .chip, .top-actions .chip{
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      will-change: transform;
    }
    .nav .chip:hover, .top-actions .chip:hover{
      box-shadow: 0 12px 30px rgba(2,6,23,.08);
      transform: translateY(-1px);
    }
    .nav .chip:active, .top-actions .chip:active{
      transform: translateY(0px) scale(.98);
      box-shadow: 0 6px 18px rgba(2,6,23,.10);
    }

    /* Sections */
    .secTitle{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      padding-bottom:10px;
      margin-bottom:12px;
      border-bottom: 1px dashed rgba(148,163,184,.6);
    }
    .secTitle .h{
      font-weight:1000;
      font-size:18px;
    }
    .secTitle .sub{
      margin-top:4px;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      line-height:1.45;
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .btn{flex:0 0 auto;white-space:nowrap}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      margin:6px 6px 0 0;
      font-weight:900;
      color:var(--text);
    }

    /* Warnings */
    .warnBox{
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      border-radius: 16px;
      padding: 12px 12px;
      margin-top: 10px;
    }
    .warnTitle{
      font-weight:1000;
      display:flex; align-items:center; gap:8px;
      margin:0 0 6px;
    }
    .warnList{
      margin:0;
      padding-left:18px;
      color:#92400e;
      font-weight:800;
      font-size:13px;
      line-height:1.55;
    }

    /* Inputs unify */
    label{font-size:12px;color:var(--muted);font-weight:900;margin:10px 0 6px;display:block}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:14px;
      transition:.15s ease;
    }
    textarea{min-height:170px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.6);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:18px;
      background:#111827;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      max-width:92vw;
      display:none;
      z-index:999;
    }
    .toast.show{ display:block; }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      background:rgba(2, 6, 23, .55);
      z-index: 900;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal.show{display:flex}
  </style>
</head>

<body data-active="admin-setup">

  <!-- TOPBAR (ƒë·ªìng b·ªô dashboard) -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <img id="brandLogo" alt="Logo"
             style="width:34px;height:34px;border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#fff" />
        <div class="meta">
          <div class="title" id="brandTitle">Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi - ƒêi·ªán Bi√™n Ph·ªß</div>
          <div class="sub" id="brandSub">Qu·∫£n tr·ªã nh√† tr∆∞·ªùng</div>
        </div>
      </div>

      <div class="nav" style="flex:1;justify-content:center;flex-wrap:nowrap;overflow:hidden">
        <a class="chip" href="./dashboard.html">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
        <a class="chip active" href="./setup.html">Thi·∫øt l·∫≠p</a>
        <a class="chip" href="../../index.html">Trang ch·ªß</a>
      </div>

      <div class="top-actions">
        <button class="chip" id="btnLogout" type="button">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="card" style="padding:18px">

      <!-- HERO -->
      <div class="heroHead">
        <div>
          <h1 class="heroTitle">Thi·∫øt l·∫≠p h·ªá th·ªëng</h1>
          <div class="muted heroSub">NƒÉm h·ªçc ‚Ä¢ L·ªõp h·ªçc ‚Ä¢ Import h·ªçc sinh ‚Ä¢ S·∫µn s√†ng v·∫≠n h√†nh</div>
        </div>

        <div class="heroRight">
          <div class="lastUpdate" id="lastUpdate">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ‚Äî</div>
        </div>
      </div>

      <!-- ROW 1 -->
      <div class="grid2 mt">

        <!-- LEFT: Years + Import -->
        <div class="dcard">
          <div class="secTitle">
            <div>
              <div class="h">1) NƒÉm h·ªçc</div>
              <div class="sub">T·∫°o/Ch·ªçn nƒÉm h·ªçc v√† ƒë·∫∑t Active ƒë·ªÉ qu·∫£n l√Ω l·ªõp & h·ªçc sinh theo nƒÉm.</div>
            </div>
            <div class="chips" style="justify-content:flex-end">
              <span class="chipLite">‚úÖ <strong id="badgeActive">Active: ‚Äî</strong></span>
            </div>
          </div>

          <label>Danh s√°ch nƒÉm</label>
          <div class="row">
            <select id="selYears"></select>
            <button class="btn" id="btnSetActive" type="button">ƒê·∫∑t active</button>
          </div>

          <label>T·∫°o nƒÉm m·ªõi</label>
          <div class="row">
            <input id="txtNewYear" placeholder="VD: 2025-2026" />
            <button class="btn ghost" id="btnAddYear" type="button">T·∫°o & ƒë·∫∑t Active</button>
          </div>

          <div class="divider"></div>

          <div class="secTitle" style="border-bottom:none;margin-bottom:6px;padding-bottom:0">
            <div>
              <div class="h">3) Import h·ªçc sinh</div>
              <div class="sub">M·ªói d√≤ng: <b>classId,studentId,fullName</b> (VD: <b>5A1,HS001,Nguy·ªÖn VƒÉn A</b>)</div>
            </div>
          </div>

          <label>Import v√†o nƒÉm</label>
          <select id="selYearImport"></select>

          <label>D·ªØ li·ªáu</label>
          <textarea id="txtStudents" placeholder="5A1,HS001,Nguy·ªÖn VƒÉn A&#10;5A1,HS002,Tr·∫ßn Th·ªã B"></textarea>

          <div class="actions mt">
            <button class="btn" id="btnImport" type="button">üì• Import</button>
          </div>

          <!-- C·∫£nh b√°o c·∫ßn x·ª≠ l√Ω -->
          <div class="warnBox" id="warnBox" style="display:none">
            <div class="warnTitle">‚ö†Ô∏è C·∫£nh b√°o c·∫ßn x·ª≠ l√Ω</div>
            <ul class="warnList" id="warnList"></ul>
          </div>

          <div class="mt muted" style="font-weight:800;font-size:12px;line-height:1.5">
            üí° G·ª£i √Ω: L√†m theo th·ª© t·ª± <b>NƒÉm h·ªçc ‚Üí L·ªõp h·ªçc ‚Üí Import h·ªçc sinh</b> ƒë·ªÉ tr√°nh l·ªách d·ªØ li·ªáu.
          </div>
        </div>

        <!-- RIGHT: Classes list -->
        <div class="dcard">
          <div class="secTitle">
            <div>
              <div class="h">2) L·ªõp h·ªçc</div>
              <div class="sub">T·∫°o l·ªõp thu·ªôc nƒÉm Active. L·ªõp t·∫°o xong s·∫Ω hi·ªÉn th·ªã ngay trong danh s√°ch.</div>
            </div>
            <div class="chips" style="justify-content:flex-end">
              <span class="chipLite">üè∑Ô∏è <strong id="yearForClasses">NƒÉm: ‚Äî</strong></span>
            </div>
          </div>

          <label>Kh·ªëi</label>
          <select id="selGrade">
            <option value="1">Kh·ªëi 1</option>
            <option value="2">Kh·ªëi 2</option>
            <option value="3">Kh·ªëi 3</option>
            <option value="4">Kh·ªëi 4</option>
            <option value="5" selected>Kh·ªëi 5</option>
          </select>

          <label>M√£ l·ªõp</label>
          <div class="row">
            <input id="txtClassId" value="5A1" />
            <button class="btn" id="btnCreateClass" type="button">üè´ T·∫°o l·ªõp</button>
          </div>

          <div class="divider"></div>

          <div style="font-weight:1000;font-size:16px">Danh s√°ch l·ªõp</div>
          <div class="muted" style="font-weight:800;font-size:12px;margin-top:4px">
            NƒÉm: <b id="lblYear">‚Äî</b>
          </div>

          <div id="classList" style="margin-top:8px;color:var(--text)"></div>
        </div>

      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <!-- Modal ƒëƒÉng nh·∫≠p Admin (gi·ªØ ch·ª©c nƒÉng, kh√¥ng ƒë·ªïi h·ªá th·ªëng) -->
  <div class="modal" id="modal">
    <div class="card" style="width:min(520px, 98vw);padding:18px;border-radius:22px">
      <h2 style="margin:0 0 6px;font-weight:1000">üîê ƒêƒÉng nh·∫≠p BGH / Qu·∫£n tr·ªã</h2>
      <div class="muted" style="font-weight:800;margin-bottom:14px">
        Nh·∫≠p m√£ qu·∫£n tr·ªã do nh√† tr∆∞·ªùng cung c·∫•p ƒë·ªÉ v√†o trang thi·∫øt l·∫≠p.
      </div>

      <div class="field">
        <label for="adminCode">M√£ BGH / Qu·∫£n tr·ªã</label>
        <input id="adminCode" type="password" placeholder="V√≠ d·ª•: BGH2026@" autocomplete="current-password" />
      </div>

      <div class="actions" style="justify-content:flex-end">
        <button class="btn ghost" id="btnCancel" type="button">ƒê·ªÉ sau</button>
        <button class="btn" id="btnLogin" type="button">ƒêƒÉng nh·∫≠p</button>
      </div>
    </div>
  </div>

  <!-- SSOT -->
  <script src="../../assets/config.js"></script>
  <script src="../../assets/api.js?v=20260101"></script>
  <script src="../../assets/core.js"></script>

  <script>
    const el = (id)=>document.getElementById(id);

    function toast(msg){
      const t = el("toast");
      t.hidden=false;
      t.textContent = msg || "‚Äî";
      t.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>{ t.classList.remove("show"); t.hidden=true; }, 2400);
    }

    function fmtTime_(d){
      const pad=n=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())} - ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function setLastUpdate_(){ el("lastUpdate").textContent = "C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: " + fmtTime_(new Date()); }

    // Logo + Brand t·ª´ config (KH√îNG s·ª≠a config.js)
    function resolveFromPage_(path){
      try { return new URL("../../" + String(path||"").replace(/^\/+/,""), window.location.href).href; }
      catch(e){ return ""; }
    }
    function initBrand_(){
      let cfg = {};
      try{ cfg = (typeof getConfig === "function") ? (getConfig()||{}) : {}; }catch(e){}
      const school = cfg.SCHOOL_NAME || "Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi - ƒêi·ªán Bi√™n Ph·ªß";
      const logo = cfg.LOGO_URL ? resolveFromPage_(cfg.LOGO_URL) : "";

      // ‚úÖ y√™u c·∫ßu √¥ng ch·ªß: d√≤ng 1 + d√≤ng 2 c·ªë ƒë·ªãnh nh∆∞ m·∫´u
      el("brandTitle").textContent = "Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi - ƒêi·ªán Bi√™n Ph·ªß";
      el("brandSub").textContent   = "Qu·∫£n tr·ªã nh√† tr∆∞·ªùng";

      const img = el("brandLogo");
      if (logo) img.src = logo;
      img.onerror = () => {
        img.src =
          "data:image/svg+xml;utf8," +
          encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
            <rect width='64' height='64' rx='14' fill='#2563eb'/>
            <text x='50%' y='56%' text-anchor='middle' font-size='34' font-family='Arial' fill='white' font-weight='700'>H</text>
          </svg>`);
      };
    }

    function openModal(){ el("modal").classList.add("show"); setTimeout(()=> el("adminCode").focus(), 60); }
    function closeModal(){ el("modal").classList.remove("show"); }

    function getAdminSession_(){
  try{
    const s = JSON.parse(localStorage.getItem("hedu_session") || "null");
    if(!s) return null;
    const role = String(s.role || "").toUpperCase();
    if(role !== "ADMIN") return null;
    // chu·∫©n ho√° token
    if(!s.token && s.sessionId) s.token = s.sessionId;
    return s;
  }catch(e){
    return null;
  }
}

    async function doAdminLogin(){
      const code = String(el("adminCode").value||"").trim();
      if(!code){ toast("Ch∆∞a nh·∫≠p m√£ qu·∫£n tr·ªã."); return; }

      el("btnLogin").disabled = true;
      el("btnLogin").textContent = "ƒêang ƒëƒÉng nh·∫≠p‚Ä¶";

      try{
        const r = await apiPost("authAdminLogin", { adminCode: code, token:"", sessionId:"" });
        if(!r || r.ok === false) throw new Error((r && (r.error || r.message)) || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
        const sess = r.session || null;
        if (sess){
          if (!sess.token) sess.token = sess.sessionId;
          sess.role = (sess.role || "ADMIN");
        }
        localStorage.setItem("hedu_session", JSON.stringify(sess));

        closeModal();
        toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚úÖ");
        await loadAll();
      }catch(err){
        toast(String(err.message || err));
      }finally{
        el("btnLogin").disabled = false;
        el("btnLogin").textContent = "ƒêƒÉng nh·∫≠p";
      }
    }

    async function logout_(){
      try{ await apiPost("authLogout", {}); }catch(e){}
      try{ localStorage.removeItem("hedu_session"); }catch(e){}
      toast("ƒê√£ ƒëƒÉng xu·∫•t ‚úÖ");
      setTimeout(()=>{ window.location.href = "../../index.html"; }, 250);
    }

    function parseStudents(text){
      const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out = [];
      for(const ln of lines){
        const parts = ln.split(",").map(s=>s.trim());
        if(parts.length < 2) continue;
        const classId = parts[0] || "";
        const studentId = parts[1] || "";
        const fullName = (parts.slice(2).join(",") || studentId).trim();
        if(classId && studentId) out.push({ classId, studentId, fullName });
      }
      return out;
    }

    function setWarnings_(warnings){
      const box = el("warnBox");
      const ul  = el("warnList");
      if(!warnings || !warnings.length){
        box.style.display = "none";
        ul.innerHTML = "";
        return;
      }
      box.style.display = "block";
      ul.innerHTML = warnings.map(w=>`<li>${String(w||"")}</li>`).join("");
    }

    async function loadClasses(year, token){
      const r = await apiPost("adminListClasses", { token, year });
      if (r && r.ok === false) throw new Error(r.error || "L·ªói t·∫£i l·ªõp");

      const y = r.year || year || "";
      el("yearForClasses").textContent = "NƒÉm: " + (y || "‚Äî");
      el("lblYear").textContent = (y || "‚Äî");

      const list = r.classes || [];
      if(!list.length){
        el("classList").innerHTML = `<div class="muted" style="font-weight:800">Ch∆∞a c√≥ l·ªõp trong nƒÉm h·ªçc n√†y.</div>`;
        return { classes: [] };
      }
      el("classList").innerHTML = list.map(c=>{
        const count = (c.studentCount ?? 0);
        return `<span class="pill">üè´ <b>${c.classId}</b> ¬∑ Kh·ªëi ${c.grade || "‚Äî"} ¬∑ ${count} HS</span>`;
      }).join("");
      return { classes: list };
    }
    function fillYearsUI_(years, active){
  const selYears = el("selYears");
  const selImp   = el("selYearImport");

  const arr = Array.isArray(years) ? years.filter(Boolean) : [];
  const act = String(active || arr[0] || "").trim();

  // lu√¥n c√≥ option (tr√°nh select tr·ªëng nh√¨n nh∆∞ ‚Äúkh√¥ng c√≥ d·ªØ li·ªáu‚Äù)
  const opt = arr.length
    ? arr.map(v => `<option value="${String(v)}">${String(v)}</option>`).join("")
    : `<option value="">‚Äî Ch∆∞a c√≥ nƒÉm h·ªçc ‚Äî</option>`;

  selYears.innerHTML = opt;
  selImp.innerHTML   = opt;

  if(act){
    selYears.value = act;
    selImp.value   = act;
  }
}

    async function loadAll(){
      // ‚úÖ guard
      const session = getAdminSession_();
      if(!session || !(session.token || session.sessionId)){
        openModal(); return;
      }
      const token = String(session.token || session.sessionId || "").trim();

      // Years + active
      const y = await apiPost("adminListYears", { token });
        if (y && y.ok === false) throw new Error(y.error || "L·ªói t·∫£i nƒÉm h·ªçc");
      
      const years  = y.years || [];
      const active = y.activeYear || years[0] || "";

      el("badgeActive").textContent = "Active: " + (active || "‚Äî");

      // ‚úÖ ƒë√¢y l√† d√≤ng quan tr·ªçng: ƒë·ªï dropdown
      fillYearsUI_(years, active);

      
      // fill dropdowns
      const opt = years.map(v=>`<option value="${v}">${v}</option>`).join("");
      el("selYears").innerHTML = opt || `<option value="">‚Äî</option>`;
      el("selYearImport").innerHTML = opt || `<option value="">‚Äî</option>`;
      if(active){
        el("selYears").value = active;
        el("selYearImport").value = active;
      }

      // classes of active year
      const info = active ? await loadClasses(active, token) : { classes: [] };

      // warnings (kh√¥ng c·∫ßn endpoint m·ªõi)
      const warnings = [];
      if(!years.length) warnings.push("Ch∆∞a c√≥ nƒÉm h·ªçc. H√£y t·∫°o nƒÉm h·ªçc v√† ƒë·∫∑t Active.");
      if(years.length && !active) warnings.push("Ch∆∞a c√≥ nƒÉm h·ªçc Active. H√£y ch·ªçn v√† b·∫•m ‚Äúƒê·∫∑t active‚Äù.");
      if(active && (!info.classes || !info.classes.length)) warnings.push("NƒÉm h·ªçc Active ch∆∞a c√≥ l·ªõp. H√£y t·∫°o l·ªõp tr∆∞·ªõc khi import h·ªçc sinh.");

      // import text quick validate
      const sample = String(el("txtStudents").value||"").trim();
      if(sample){
        const parsed = parseStudents(sample);
        if(!parsed.length) warnings.push("D·ªØ li·ªáu import ƒëang sai ƒë·ªãnh d·∫°ng. M·ªói d√≤ng ph·∫£i l√†: classId,studentId,fullName.");
      }

      setWarnings_(warnings);
      setLastUpdate_();
    }

    // actions
    el("btnSetActive").addEventListener("click", async ()=>{
    try{
      const session = getAdminSession_();
      if(!session) return;
      const token = session.token || session.sessionId || "";

      const year = (el("selYears").value || "").trim();
      if(!year) return toast("Ch·ªçn nƒÉm h·ªçc tr∆∞·ªõc ƒë√£.");

      const r = await apiPost("adminSetActiveYear", { token, year }); // ‚úÖ ƒë√∫ng
      if (r && r.ok === false) throw new Error(r.error || "Kh√¥ng ƒë·∫∑t ƒë∆∞·ª£c active");

      toast("ƒê√£ ƒë·∫∑t nƒÉm h·ªçc active: " + (r.activeYear || year));
      await loadAll();
    }catch(err){ toast(String(err.message||err)); }
  });


    el("btnAddYear").addEventListener("click", async ()=>{
    try{
      const session = getAdminSession_();
      if(!session) return;
      const token = session.token || session.sessionId || "";

      const year = (el("txtNewYear").value || "").trim();
      if(!year) return toast("Vui l√≤ng nh·∫≠p nƒÉm h·ªçc (VD: 2025-2026)");

      // ‚úÖ 2 b∆∞·ªõc cho ch·∫Øc
      const a = await apiPost("adminAddYear", { token, year });
      if (a && a.ok === false) throw new Error(a.error || "Kh√¥ng t·∫°o ƒë∆∞·ª£c nƒÉm h·ªçc");

      const r = await apiPost("adminSetActiveYear", { token, year });
      if (r && r.ok === false) throw new Error(r.error || "Kh√¥ng ƒë·∫∑t ƒë∆∞·ª£c active");

      toast("ƒê√£ t·∫°o & ƒë·∫∑t active: " + (r.activeYear || year));
      el("txtNewYear").value = "";
      await loadAll();
    }catch(err){ toast(String(err.message||err)); }
  });


    el("btnCreateClass").addEventListener("click", async ()=>{
      try{
        const session = getAdminSession_();
        if(!session) return;
        const token = session.token || session.sessionId || "";

        const year = el("selYears").value;
        const grade = el("selGrade").value;
        const classId = el("txtClassId").value.trim();
        if(!year) return toast("Ch∆∞a c√≥ nƒÉm h·ªçc active.");
        if(!classId) return toast("Vui l√≤ng nh·∫≠p m√£ l·ªõp.");

        const r = await apiPost("adminCreateClass", { token, year, grade, classId });
        if (r && r.ok === false) throw new Error(r.error || "Kh√¥ng t·∫°o ƒë∆∞·ª£c l·ªõp");
        toast("ƒê√£ t·∫°o/c·∫≠p nh·∫≠t l·ªõp: " + r.classId);
        await loadAll();
      }catch(err){ toast(String(err.message||err)); }
    });

    el("btnImport").addEventListener("click", async ()=>{
      try{
        const session = getAdminSession_();
        if(!session) return;
        const token = session.token || session.sessionId || "";

        const year = el("selYearImport").value;
        if(!year) return toast("Vui l√≤ng ch·ªçn nƒÉm h·ªçc ƒë·ªÉ import.");
        const students = parseStudents(el("txtStudents").value);
        if(!students.length) return toast("D·ªØ li·ªáu import ch∆∞a ƒë√∫ng ƒë·ªãnh d·∫°ng.");

        const r = await apiPost("adminImportStudents", { token, year, students });
        if (r && r.ok === false) throw new Error(r.error || "Import th·∫•t b·∫°i");

        toast(`Import xong: th√™m ${r.added||0}, c·∫≠p nh·∫≠t ${r.updated||0}`);
        await loadAll();
      }catch(err){ toast(String(err.message||err)); }
    });

    // modal events
    el("btnLogin").addEventListener("click", doAdminLogin);
    el("btnCancel").addEventListener("click", ()=>{ closeModal(); toast("B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p sau."); });
    el("adminCode").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doAdminLogin(); });

    // top right logout
    el("btnLogout").addEventListener("click", logout_);

    // Boot
    (async function(){
      try{
        initBrand_();
        const s = getAdminSession_();
        if(s && (s.token || s.sessionId)){
          await loadAll();
        }else{
          openModal();
        }
      }catch(err){
        toast(String(err.message||err));
      }
    })();
  </script>
</body>
</html>

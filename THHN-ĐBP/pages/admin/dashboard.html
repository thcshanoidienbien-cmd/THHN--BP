<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qu·∫£n tr·ªã nh√† tr∆∞·ªùng</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#2563eb"/>

  <style>
    /* ===== Layout gi·ªëng teacher-dashboard (Pro) ===== */
    .grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}

    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}

    .heroHead{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; padding:2px 0 12px;
      border-bottom:1px dashed rgba(148,163,184,.6);
      margin-bottom:12px;
    }
    .heroTitle{margin:0; font-size:34px; letter-spacing:-.02em}
    .heroSub{margin-top:6px}

    /* ‚úÖ B·ªè chips g√≥c ph·∫£i (BGH/Qu·∫£n tr·ªã + NƒÉm h·ªçc) theo y√™u c·∫ßu */
    .heroRight{display:none}

    /* KPI h√†ng ƒë·∫ßu */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:980px){ .kpis{ grid-template-columns: repeat(2,1fr); } }
    @media(max-width:520px){ .kpis{ grid-template-columns: 1fr; } }
    .kpiBox{
      padding:14px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      text-align:center;
    }
    .kpiBox .t{color:var(--muted);font-size:12px;font-weight:800;white-space:nowrap}
    .kpiBox .v{font-size:22px;font-weight:900;margin-top:6px}

    /* System health list */
    .healthList{display:grid;gap:10px;margin-top:10px}
    .healthItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
    }
    .healthItem .label{font-weight:900}
    .healthItem .desc{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px}
    .healthLeft{display:flex;flex-direction:column}
    .healthRight{display:flex;align-items:center;gap:8px;white-space:nowrap}

    /* table */
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin-top:12px;
    }
    .table th,.table td{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:left;
      vertical-align:middle;
      font-weight:800;
    }
    .table th{
      background:#f8fafc;
      font-weight:900;
      color:#334155;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:.04em;
    }
    .table tr:last-child td{border-bottom:0}

    /* ===== Menu: √©p 1 d√≤ng ngang + hi·ªáu ·ª©ng b·∫•m ===== */
    .topbar{ z-index:50; }
    .topbar .inner{ gap:14px; }
    .nav{
      flex:1;
      justify-content:center;
      flex-wrap:nowrap;
      overflow:auto hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .nav::-webkit-scrollbar{ height:0; }

    /* ‚úÖ Hi·ªáu ·ª©ng b·∫•m cho chip menu + ƒêƒÉng xu·∫•t */
    .chip{
      transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease, filter .12s ease;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:hover{
      filter: brightness(0.98);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .chip:active{
      transform: translateY(1px) scale(0.99);
      box-shadow:none;
    }
    button.chip{
      appearance:none;
      background:#fff;
    }

    /* ===== Alert box ===== */
    .alertBox{
      margin-top:12px;
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      border-radius:16px;
      padding:12px 12px;
    }
    .alertHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .alertTitle{font-weight:1000}
    .alertSub{color:var(--muted);font-size:12px;font-weight:800;margin-top:4px}
    .alertList{margin:10px 0 0; padding:0 0 0 18px}
    .alertList li{margin:6px 0; font-weight:800}
    .alertList b{font-weight:1000}
    .alertOk{
      border-color: rgba(22,163,74,.28);
      background: rgba(22,163,74,.10);
    }

    /* ===== Modal ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      background:rgba(2,6,23,.55);
      z-index:60;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal.show{display:flex}
  </style>
</head>

<body data-active="admin-dashboard">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <img id="brandLogo" alt="Logo"
             style="width:34px;height:34px;border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#fff" />
        <div class="meta">
          <!-- ‚úÖ D√≤ng 1 -->
          <div class="title" id="brandTitle">Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi ‚Äì ƒêi·ªán Bi√™n Ph·ªß</div>
          <!-- ‚úÖ D√≤ng 2 -->
          <div class="sub" id="brandSub">Qu·∫£n tr·ªã nh√† tr∆∞·ªùng</div>
        </div>
      </div>

      <div class="nav">
        <a class="chip active" href="./dashboard.html">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
        <a class="chip" href="./setup.html">Thi·∫øt l·∫≠p</a>
        <a class="chip" href="../../index.html">Trang ch·ªß</a>
      </div>

      <div class="top-actions" style="pointer-events:auto">
        <!-- ‚úÖ B·∫£o ƒë·∫£m b·∫•m ƒë∆∞·ª£c: button n·∫±m tr√™n c√πng, kh√¥ng b·ªã l·ªõp n√†o che -->
        <button class="chip" id="btnLogout" type="button" style="position:relative;z-index:2">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="card" style="padding:18px">

      <!-- HERO -->
      <div class="heroHead">
        <div>
          <h1 class="heroTitle">Qu·∫£n tr·ªã nh√† tr∆∞·ªùng</h1>
          <div class="muted heroSub">T·ªïng quan v·∫≠n h√†nh ‚Ä¢ Ch·ªâ s·ªë ch√≠nh ‚Ä¢ T√¨nh tr·∫°ng h·ªá th·ªëng</div>
        </div>
        <!-- ‚úÖ ƒê√£ ·∫©n g√≥c ph·∫£i theo y√™u c·∫ßu -->
        <div class="heroRight"></div>
      </div>

      <!-- KPI -->
      <div class="kpis" id="kpiRow">
        <div class="kpiBox">
          <div class="t">S·ªë l·ªõp</div>
          <div class="v" id="mClasses">‚Äî</div>
        </div>
        <div class="kpiBox">
          <div class="t">H·ªçc sinh</div>
          <div class="v" id="mStudents">‚Äî</div>
        </div>
        <div class="kpiBox">
          <div class="t">Gi√°o vi√™n</div>
          <div class="v" id="mTeachers">‚Äî</div>
        </div>
        <div class="kpiBox">
          <div class="t">B√†i ƒë√£ giao</div>
          <div class="v" id="mTasks">‚Äî</div>
        </div>
      </div>

      <!-- ROW 2 -->
      <div class="grid2 mt">

        <!-- LEFT -->
        <div class="dcard">
          <div class="section-title" style="margin:0 0 10px;border-bottom:1px dashed rgba(148,163,184,.6);padding-bottom:10px">
            <div>
              <div style="font-weight:1000;font-size:18px">üìä T·ªïng quan ho·∫°t ƒë·ªông</div>
              <div class="muted" style="font-weight:800;font-size:12px;margin-top:4px">
                N·∫Øm nhanh n·ªôp b√†i ‚Äì nh·∫≠n x√©t ‚Äì l·ªõp g·∫ßn ƒë√¢y ƒë·ªÉ ƒëi·ªÅu h√†nh k·ªãp th·ªùi
              </div>
            </div>
            <!-- ‚úÖ B·ªè c·ª•m n√∫t khoanh ƒë·ªè ·ªü gi·ªØa: kh√¥ng ƒë·∫∑t ·ªü ƒë√¢y n·ªØa -->
            <div></div>
          </div>

          <div class="kpis" style="grid-template-columns:repeat(3,minmax(0,1fr));margin-top:0">
            <div class="kpiBox">
              <div class="t">B√†i n·ªôp</div>
              <div class="v" id="mSubs">‚Äî</div>
            </div>
            <div class="kpiBox">
              <div class="t">Nh·∫≠n x√©t</div>
              <div class="v" id="mFbs">‚Äî</div>
            </div>
            <div class="kpiBox">
              <div class="t">NƒÉm h·ªçc ƒëang d√πng</div>
              <div class="v" id="mYear">‚Äî</div>
            </div>
          </div>

          <div class="mt" style="font-weight:1000;font-size:16px">üè´ L·ªõp g·∫ßn ƒë√¢y</div>
          <div class="muted" style="font-weight:800;font-size:12px;margin-top:4px">Hi·ªÉn th·ªã t·ªëi ƒëa 6 l·ªõp</div>

          <table class="table">
            <thead>
              <tr>
                <th>L·ªõp</th>
                <th>Kh·ªëi</th>
                <th>H·ªçc sinh</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="classesBody">
              <tr>
                <td colspan="4" style="color:#64748b;font-weight:800">Ch∆∞a c√≥ d·ªØ li·ªáu.</td>
              </tr>
            </tbody>
          </table>

          <!-- ‚úÖ H√†nh ƒë·ªông ƒë·∫∑t cu·ªëi kh·ªëi LEFT cho g·ªçn (kh√¥ng l·∫∑p, kh√¥ng r·ªëi) -->
          <div class="actions mt" style="justify-content:flex-end">
            <button class="btn ghost" id="btnGoSetup" type="button">‚öôÔ∏è Thi·∫øt l·∫≠p</button>
            <button class="btn" id="btnRefresh" type="button">üîÑ T·∫£i l·∫°i</button>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="dcard">
          <div class="section-title" style="margin:0 0 10px;border-bottom:1px dashed rgba(148,163,184,.6);padding-bottom:10px">
            <div>
              <div style="font-weight:1000;font-size:18px">üß© T√¨nh tr·∫°ng h·ªá th·ªëng</div>
              <div class="muted" style="font-weight:800;font-size:12px;margin-top:4px">
                Ki·ªÉm tra c·∫•u h√¨nh ƒë·ªÉ v·∫≠n h√†nh ·ªïn ƒë·ªãnh (d·ªØ li·ªáu l·∫•y t·ª´ adminOverview)
              </div>
            </div>
          </div>

          <div class="healthList">
            <div class="healthItem">
              <div class="healthLeft">
                <div class="label">C·∫•u tr√∫c Sheets</div>
                <div class="desc">C√°c sheet b·∫Øt bu·ªôc c√≥ ƒë·ªß</div>
              </div>
              <div class="healthRight">
                <span class="badge" id="hSheets">‚Äî</span>
              </div>
            </div>

            <div class="healthItem">
              <div class="healthLeft">
                <div class="label">Ti√™u ƒë·ªÅ c·ªôt d·ªØ li·ªáu</div>
                <div class="desc">Header kh·ªõp schema SSOT</div>
              </div>
              <div class="healthRight">
                <span class="badge" id="hHeaders">‚Äî</span>
              </div>
            </div>

            <div class="healthItem">
              <div class="healthLeft">
                <div class="label">Kho√° AI (n·∫øu d√πng)</div>
                <div class="desc">Ch·ªâ ki·ªÉm tra tr·∫°ng th√°i c·∫•u h√¨nh</div>
              </div>
              <div class="healthRight">
                <span class="badge" id="hOpenai">‚Äî</span>
              </div>
            </div>

            <div class="healthItem">
              <div class="healthLeft">
                <div class="label">L·ªõp m·ª•c ti√™u</div>
                <div class="desc">ƒê√£ t·∫°o l·ªõp ch·∫°y th·ª≠ / pilot</div>
              </div>
              <div class="healthRight">
                <span class="badge" id="hPilot">‚Äî</span>
              </div>
            </div>
          </div>

          <!-- ‚úÖ C·∫£nh b√°o c·∫ßn x·ª≠ l√Ω (chuy√™n nghi·ªáp) -->
          <div class="alertBox mt" id="alertBox" hidden>
            <div class="alertHead">
              <div>
                <div class="alertTitle">‚ö†Ô∏è C·∫£nh b√°o c·∫ßn x·ª≠ l√Ω</div>
                <div class="alertSub">H·ªá th·ªëng ph√°t hi·ªán m·ªôt s·ªë m·ª•c ch∆∞a ƒë·∫°t. N√™n x·ª≠ l√Ω ƒë·ªÉ v·∫≠n h√†nh ·ªïn ƒë·ªãnh.</div>
              </div>
            </div>
            <ul class="alertList" id="alertList"></ul>
          </div>

          <!-- ‚úÖ Tr·∫°ng th√°i OK (khi kh√¥ng c√≥ c·∫£nh b√°o) -->
          <div class="alertBox alertOk mt" id="alertOk" hidden>
            <div class="alertHead">
              <div>
                <div class="alertTitle">‚úÖ H·ªá th·ªëng ƒëang ·ªïn ƒë·ªãnh</div>
                <div class="alertSub">C√°c ki·ªÉm tra ch√≠nh ƒë·ªÅu ƒë·∫°t. C√≥ th·ªÉ tri·ªÉn khai ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</div>
              </div>
            </div>
          </div>

          <div class="mt muted" style="font-weight:800;font-size:12px;line-height:1.5">
            üí° G·ª£i √Ω: Giai ƒëo·∫°n ch·∫°y th·ª≠ ch·ªâ c·∫ßn qu·∫£n l√Ω 01 l·ªõp m·ª•c ti√™u. Khi m·ªü r·ªông, b·ªï sung nƒÉm h·ªçc ‚Äì l·ªõp ‚Äì danh s√°ch h·ªçc sinh trong m·ª•c <b>Thi·∫øt l·∫≠p</b>.
          </div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <!-- Modal ƒëƒÉng nh·∫≠p Admin (gi·ªØ nguy√™n ch·ª©c nƒÉng) -->
  <div class="modal" id="modal">
    <div class="card" style="width:min(520px, 98vw);padding:18px;border-radius:22px">
      <h2 style="margin:0 0 6px;font-weight:1000">üîê ƒêƒÉng nh·∫≠p BGH / Qu·∫£n tr·ªã</h2>
      <div class="muted" style="font-weight:800;margin-bottom:14px">
        Nh·∫≠p m√£ qu·∫£n tr·ªã do nh√† tr∆∞·ªùng cung c·∫•p ƒë·ªÉ v√†o trang qu·∫£n tr·ªã.
      </div>

      <div class="field">
        <label for="adminCode">M√£ BGH / Qu·∫£n tr·ªã</label>
        <input id="adminCode" type="password" placeholder="V√≠ d·ª•: BGH2026@" autocomplete="current-password" />
      </div>

      <div class="actions" style="justify-content:flex-end">
        <button class="btn ghost" id="btnCancel" type="button">ƒê·ªÉ sau</button>
        <button class="btn" id="btnLogin" type="button">ƒêƒÉng nh·∫≠p</button>
      </div>
    </div>
  </div>

  <!-- SSOT -->
  <script src="../../assets/config.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/core.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.hidden = false;
      t.textContent = msg || "‚Äî";
      t.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>{ t.classList.remove("show"); t.hidden = true; }, 2400);
    }

    function openModal(){ $("modal").classList.add("show"); setTimeout(()=> $("adminCode").focus(), 60); }
    function closeModal(){ $("modal").classList.remove("show"); }

    // Logo + Brand t·ª´ config (KH√îNG s·ª≠a config.js)
    function resolveFromPage_(path){
      try { return new URL("../../" + String(path||"").replace(/^\/+/,""), window.location.href).href; }
      catch(e){ return ""; }
    }
    function getCfg_(){
      // ∆∞u ti√™n window.HEDU_CONFIG n·∫øu c√≥, fallback getConfig()
      try{
        if (window.HEDU_CONFIG) return window.HEDU_CONFIG;
      }catch(e){}
      try{
        return (typeof getConfig === "function") ? (getConfig()||{}) : {};
      }catch(e){}
      return {};
    }
    function initBrand_(){
      const cfg = getCfg_();
      const school = cfg.SCHOOL_NAME || "Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi ‚Äì ƒêi·ªán Bi√™n Ph·ªß";
      const logoPath = cfg.LOGO_URL || "assets/img/logo.png";
      const logo = resolveFromPage_(logoPath);

      $("brandTitle").textContent = "Tr∆∞·ªùng Ti·ªÉu h·ªçc H√† N·ªôi ‚Äì ƒêi·ªán Bi√™n Ph·ªß";
      $("brandSub").textContent = "Qu·∫£n tr·ªã nh√† tr∆∞·ªùng";

      const img = $("brandLogo");
      img.src = logo;
      img.onerror = () => {
        img.src =
          "data:image/svg+xml;utf8," +
          encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
            <rect width='64' height='64' rx='14' fill='#2563eb'/>
            <text x='50%' y='56%' text-anchor='middle' font-size='34' font-family='Arial' fill='white' font-weight='700'>H</text>
          </svg>`);
      };
    }

    // Session
    function getAdminSession_(){
      try{ return (typeof requireRole === "function") ? requireRole("ADMIN") : null; }
      catch(e){ return null; }
    }

    function badgeText_(el, ok, okText="OK", badText="C·∫ßn ki·ªÉm tra"){
      el.classList.remove("ok","warn","bad");
      el.classList.add("badge");
      if (ok === true){ el.classList.add("ok"); el.textContent = "‚úÖ " + okText; }
      else if (ok === false){ el.classList.add("warn"); el.textContent = "‚ö†Ô∏è " + badText; }
      else { el.textContent = "‚Äî"; }
    }

    function setText(id, v){
      $(id).textContent = (v===0 ? "0" : (v || "‚Äî"));
    }

    function renderAlerts_(health){
      const box = $("alertBox");
      const okBox = $("alertOk");
      const list = $("alertList");
      list.innerHTML = "";

      const warns = [];
      if (!health || typeof health !== "object"){
        warns.push("Ch∆∞a ƒë·ªçc ƒë∆∞·ª£c tr·∫°ng th√°i h·ªá th·ªëng. Vui l√≤ng b·∫•m <b>T·∫£i l·∫°i</b>.");
      } else {
        if (!health.sheetsOk)  warns.push("Thi·∫øu/sai <b>C·∫•u tr√∫c Sheets</b> (c·∫ßn ƒë·ªß sheet b·∫Øt bu·ªôc).");
        if (!health.headersOk) warns.push("Sai <b>Ti√™u ƒë·ªÅ c·ªôt d·ªØ li·ªáu</b> (ch∆∞a kh·ªõp schema).");
        if (health.openaiOk === false) warns.push("<b>Kho√° AI</b> ch∆∞a c·∫•u h√¨nh (n·∫øu nh√† tr∆∞·ªùng d√πng AI).");
        if (!health.has5A1) warns.push("Ch∆∞a t·∫°o <b>L·ªõp m·ª•c ti√™u (pilot)</b> ƒë·ªÉ ch·∫°y th·ª≠.");
      }

      if (warns.length){
        box.hidden = false;
        okBox.hidden = true;
        warns.forEach(w=>{
          const li = document.createElement("li");
          li.innerHTML = w;
          list.appendChild(li);
        });
      } else {
        box.hidden = true;
        okBox.hidden = false;
      }
    }

    function renderOverview(ov){
      // KPI
      setText("mYear", ov.activeYear || "‚Äî");
      setText("mClasses", ov.totalClasses ?? "‚Äî");
      setText("mStudents", ov.totalStudents ?? "‚Äî");
      setText("mTeachers", ov.totalTeachers ?? "‚Äî");
      setText("mTasks", ov.totalTasks ?? "‚Äî");
      setText("mSubs", ov.totalSubmissions ?? "‚Äî");
      setText("mFbs", ov.totalFeedbacks ?? "‚Äî");

      // health th·∫≠t
      const health = ov.health || {};
      badgeText_($("hSheets"),  !!health.sheetsOk,  "OK", "Thi·∫øu / sai");
      badgeText_($("hHeaders"), !!health.headersOk, "OK", "Ch∆∞a kh·ªõp");

      if (health.openaiOk === true) badgeText_($("hOpenai"), true, "ƒê√£ c·∫•u h√¨nh", "Ch∆∞a c·∫•u h√¨nh");
      else if (health.openaiOk === false) badgeText_($("hOpenai"), false, "ƒê√£ c·∫•u h√¨nh", "Ch∆∞a c·∫•u h√¨nh");
      else { $("hOpenai").textContent = "‚Äî"; $("hOpenai").className = "badge"; }

      badgeText_($("hPilot"),  !!health.has5A1, "OK", "Ch∆∞a t·∫°o");

      // alerts
      renderAlerts_(health);

      // l·ªõp g·∫ßn ƒë√¢y
      const tb = $("classesBody");
      const rows = Array.isArray(ov.classes) ? ov.classes : [];
      if (!rows.length){
        tb.innerHTML = `<tr><td colspan="4" style="color:#64748b;font-weight:800">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªõp.</td></tr>`;
        return;
      }
      tb.innerHTML = rows.slice(0,6).map(c=>{
        const ok = (c.health === "OK");
        const badge = ok
          ? `<span class="badge ok">‚úÖ OK</span>`
          : `<span class="badge warn">‚ö†Ô∏è C·∫ßn ki·ªÉm tra</span>`;
        return `
          <tr>
            <td>${c.classId || "-"}</td>
            <td>${c.grade || "-"}</td>
            <td>${(c.studentCount ?? 0)}</td>
            <td>${badge}</td>
          </tr>
        `;
      }).join("");
    }

    async function loadOverview(){
      const s = getAdminSession_();
      if(!s || !s.token){
        openModal();
        toast("Vui l√≤ng ƒëƒÉng nh·∫≠p Admin ƒë·ªÉ ti·∫øp t·ª•c.");
        return;
      }
      try{
        toast("ƒêang t·∫£i d·ªØ li·ªáu qu·∫£n tr·ªã‚Ä¶");
        const r = await apiPost("adminOverview", { token: s.token });
        if(!r || r.ok === false){
          const msg = String((r && (r.error || r.message)) || "L·ªói t·∫£i d·ªØ li·ªáu");
          if (msg.toLowerCase().includes("phi√™n") || msg.toLowerCase().includes("kh√¥ng ƒë·ªß quy·ªÅn") || msg.toLowerCase().includes("unauthorized")){
            try{ localStorage.removeItem("hedu_session"); }catch(e){}
            openModal();
          }
          toast(msg);
          return;
        }
        renderOverview(r.overview || {});
        toast("ƒê√£ c·∫≠p nh·∫≠t ‚úÖ");
      }catch(err){
        toast("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c backend.");
        console.error(err);
      }
    }

    async function doAdminLogin(){
      const code = String($("adminCode").value||"").trim();
      if(!code){ toast("Ch∆∞a nh·∫≠p m√£ qu·∫£n tr·ªã."); return; }

      $("btnLogin").disabled = true;
      $("btnLogin").textContent = "ƒêang ƒëƒÉng nh·∫≠p‚Ä¶";

      try{
        const r = await apiPost("authAdminLogin", { adminCode: code });
        if(!r || r.ok === false) throw new Error((r && (r.error || r.message)) || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");

        localStorage.setItem("hedu_session", JSON.stringify(r.session || null));

        closeModal();
        toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚úÖ");
        await loadOverview();
      }catch(err){
        toast(String(err.message || err));
      }finally{
        $("btnLogin").disabled = false;
        $("btnLogin").textContent = "ƒêƒÉng nh·∫≠p";
      }
    }

    async function logout_(){
      try{ await apiPost("authLogout", {}); }catch(e){}
      try{ localStorage.removeItem("hedu_session"); }catch(e){}
      toast("ƒê√£ ƒëƒÉng xu·∫•t ‚úÖ");
      setTimeout(()=>{ window.location.href = "../../index.html"; }, 220);
    }

    // Events
    $("btnLogin").addEventListener("click", doAdminLogin);
    $("btnCancel").addEventListener("click", ()=>{ closeModal(); toast("B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p sau."); });
    $("adminCode").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doAdminLogin(); });

    // ‚úÖ FIX: ƒë·∫£m b·∫£o n√∫t ƒêƒÉng xu·∫•t lu√¥n click ƒë∆∞·ª£c
    $("btnLogout").addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); logout_(); });

    $("btnGoSetup").addEventListener("click", ()=>{ window.location.href = "./setup.html"; });
    $("btnRefresh").addEventListener("click", loadOverview);

    // Boot
    (async function boot(){
      initBrand_();
      const s = getAdminSession_();
      if(s && s.token){
        await loadOverview();
      }else{
        openModal();
      }
    })();
  </script>
</body>
</html>

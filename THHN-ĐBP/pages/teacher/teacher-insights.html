<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HEDU ‚Ä¢ Insights</title>
  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#1a73e8"/>
  <style>
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:900;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}
    .dcard{padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .split{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;align-items:start}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    .quick{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.quick{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.quick{grid-template-columns:1fr}}
    .qcard{padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .big{font-size:26px;font-weight:900;margin-top:6px}
    textarea{min-height:140px}
    .list{display:grid;gap:10px}
  </style>
</head>
<body data-active="insights">
  <div id="topbar"></div>

  <main class="container">
    <section class="card" style="padding:16px">
      <div class="row">
        <div>
          <h1 style="margin:0">Insights üìà</h1>
          <div class="muted" id="sub">‚Äî</div>
        </div>
        <div class="pill" id="me">‚Äî</div>
      </div>

      <div class="actions mt">
        <button class="btn ghost" id="btnPortal" type="button">üè† Portal</button>
        <button class="btn ghost" id="btnTasks" type="button">üìö Tasks</button>
        <button class="btn ghost" id="btnSubs" type="button">üì® B√†i n·ªôp</button>
        <button class="btn" id="btnReload" type="button">T·∫£i l·∫°i</button>
      </div>

      <div class="split mt">
        <!-- LEFT: gradebook + reports -->
        <div class="dcard">
          <div style="font-weight:900">üìí Gradebook + Reports</div>
          <div class="muted mt">T·ªïng h·ª£p ti·∫øn ƒë·ªô, b√°o c√°o nhanh, b√°o c√°o tu·∫ßn (AI)</div>

          <div class="quick mt" id="kpi"></div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label>B√°o c√°o kho·∫£ng (ng√†y)</label>
              <select id="rangeDays">
                <option value="7">7</option>
                <option value="14">14</option>
                <option value="30">30</option>
              </select>
            </div>
            <div class="actions" style="align-items:flex-end;justify-content:flex-end">
              <button class="btn ghost" id="btnReport" type="button">üìÑ Report nhanh</button>
              <button class="btn" id="btnWeeklyAI" type="button">ü§ñ B√°o c√°o tu·∫ßn (AI)</button>
            </div>
          </div>

          <textarea id="reportBox" class="mt" placeholder="B√°o c√°o s·∫Ω hi·ªán ·ªü ƒë√¢y..." readonly></textarea>

          <div class="divider"></div>

          <div style="font-weight:900">üë®‚Äçüéì Danh s√°ch ti·∫øn ƒë·ªô</div>
          <div class="muted mt">B·∫•m 1 h·ªçc sinh ƒë·ªÉ xem Learning Path + nh·∫Øn tin</div>
          <div class="mt" id="tableBox"></div>
        </div>

        <!-- RIGHT: learning path + messages -->
        <div class="dcard">
          <div style="font-weight:900">üß≠ Learning Path + Messages</div>
          <div class="muted mt">G·ª£i √Ω l·ªô tr√¨nh 2 tu·∫ßn (AI) + nh·∫Øn tin HS/PH</div>

          <div class="grid2 mt">
            <div>
              <label>Ch·ªçn h·ªçc sinh</label>
              <select id="studentId"></select>
            </div>
            <div class="actions" style="align-items:flex-end;justify-content:flex-end">
              <button class="btn" id="btnPath" type="button">üß† L·∫•y Learning Path</button>
            </div>
          </div>

          <textarea id="pathBox" class="mt" placeholder="Learning path..." readonly></textarea>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label>G·ª≠i t·ªõi</label>
              <select id="toRole">
                <option value="PARENT">PH·ª§ HUYNH</option>
                <option value="STUDENT">H·ªåC SINH</option>
              </select>
            </div>
            <div>
              <label>Ti√™u ƒë·ªÅ</label>
              <input id="msgSubject" placeholder="VD: Nh·∫Øc n·ªôp b√†i / Khen ng·ª£i tu·∫ßn n√†y...">
            </div>
          </div>

          <label class="mt">N·ªôi dung</label>
          <textarea id="msgContent" placeholder="Nh·∫≠p n·ªôi dung tin nh·∫Øn..."></textarea>

          <div class="actions mt">
            <button class="btn" id="btnSend" type="button">üì® G·ª≠i tin</button>
            <button class="btn ghost" id="btnLoadMsgs" type="button">üì• T·∫£i tin</button>
          </div>

          <div class="divider"></div>
          <div class="list" id="msgList"></div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <script src="../../assets/config.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/teacher-snippet.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"‚Äî";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }
    function esc(s){return String(s||"").replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));}

    const session=requireRole("TEACHER");
    const token=session.token;
    const classId=localStorage.getItem("hedu_teacher_classId") || session.classId || "5A1";
    me.textContent = `${session.displayName||"Gi√°o vi√™n"} ‚Ä¢ ${classId}`;

    btnPortal.onclick=()=>location.href="./teacher-dashboard.html";
    btnTasks.onclick=()=>location.href="./teacher-tasks.html";
    btnSubs.onclick=()=>location.href="./teacher-submissions.html";

    let _students=[];

    function renderKpi_(gb){
      const rows = gb.rows||[];
      const taskCount = Number(gb.taskCount||0);
      const totalSubmitted = rows.reduce((a,x)=>a+(Number(x.submitted)||0),0);
      const totalGraded = rows.reduce((a,x)=>a+(Number(x.graded)||0),0);

      kpi.innerHTML=`
        <div class="qcard"><div class="muted" style="font-weight:900">T·ªïng Tasks</div><div class="big">${esc(taskCount)}</div></div>
        <div class="qcard"><div class="muted" style="font-weight:900">S·ªë HS</div><div class="big">${esc(rows.length)}</div></div>
        <div class="qcard"><div class="muted" style="font-weight:900">T·ªïng n·ªôp</div><div class="big">${esc(totalSubmitted)}</div></div>
        <div class="qcard"><div class="muted" style="font-weight:900">ƒê√£ nh·∫≠n x√©t</div><div class="big">${esc(totalGraded)}</div></div>
      `;
    }

    function renderTable_(gb){
      const rows = gb.rows||[];
      if(!rows.length){
        tableBox.innerHTML = `<div class="muted">Ch∆∞a c√≥ danh s√°ch h·ªçc sinh.</div>`;
        return;
      }

      tableBox.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>H·ªçc sinh</th>
              <th>N·ªôp</th>
              <th>ƒê√£ nh·∫≠n x√©t</th>
              <th>Ti·∫øn ƒë·ªô</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const p = Number(String(r.progress||"0%").replace("%",""))||0;
              const pct = Math.max(0,Math.min(100,p));
              return `
                <tr>
                  <td>
                    <div style="font-weight:900">${esc(r.studentId)}</div>
                    <div class="muted">${esc(r.name||"")}</div>
                  </td>
                  <td>${esc(r.submitted||0)}</td>
                  <td>${esc(r.graded||0)}</td>
                  <td>
                    <div class="pbar"><span style="width:${pct}%"></span></div>
                    <div class="muted" style="font-size:12px;margin-top:6px">${pct}%</div>
                  </td>
                  <td><button class="btn ghost" data-st="${esc(r.studentId)}" type="button">Ch·ªçn</button></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      tableBox.querySelectorAll("button[data-st]").forEach(b=>{
        b.onclick=()=>{
          studentId.value = b.getAttribute("data-st");
          toast("ƒê√£ ch·ªçn h·ªçc sinh ‚úÖ");
        };
      });
    }

    async function loadStudentsSelect_(){
      const r = await api("listStudents",{token,classId});
      _students = r.students || [];
      studentId.innerHTML = _students.map(s=>`<option value="${esc(s.studentId)}">${esc(s.studentId)} ‚Ä¢ ${esc(s.name||"")}</option>`).join("")
        || `<option value="">(ch∆∞a c√≥ HS)</option>`;
      sub.textContent = `Pilot ${r.system.classId} ‚Ä¢ Kh·ªëi ${r.system.grade} ‚Ä¢ ${r.system.subject} ‚Ä¢ ${r.system.textbook}`;
    }

    async function loadGradebook_(){
      const gb = await api("getGradebook",{token,classId});
      renderKpi_(gb);
      renderTable_(gb);
    }

    btnReport.onclick = async ()=>{
      try{
        const r = await api("getClassReport",{token,classId,rangeDays:Number(rangeDays.value||7)});
        const rep = r.report||{};
        reportBox.value = [
          `B√ÅO C√ÅO NHANH (${rep.rangeDays||7} ng√†y)`,
          `- B√†i n·ªôp: ${rep.submissions||0}`,
          `- N·ªôp mu·ªôn: ${rep.lateSubmissions||0}`,
          `- Nh·∫≠n x√©t: ${rep.feedbacks||0}`,
          ``,
          `T·ª´: ${rep.since||""}`,
          `ƒê·∫øn: ${rep.now||""}`
        ].join("\n");
        toast("ƒê√£ t·∫°o report ‚úÖ");
      }catch(e){ toast(e.message||"Report l·ªói"); }
    };

    btnWeeklyAI.onclick = async ()=>{
      try{
        reportBox.value = "‚è≥ ƒêang t·∫°o b√°o c√°o tu·∫ßn b·∫±ng AI...";
        const r = await api("aiClassWeeklyReport",{token,classId,rangeDays:Number(rangeDays.value||7)});
        reportBox.value = (r.reportText||"").trim() || "AI kh√¥ng tr·∫£ n·ªôi dung.";
        toast("AI ƒë√£ t·∫°o b√°o c√°o ‚úÖ");
      }catch(e){ toast(e.message||"AI report l·ªói"); }
    };

    btnPath.onclick = async ()=>{
      try{
        const sid = studentId.value || "";
        if(!sid) return toast("Ch∆∞a c√≥ h·ªçc sinh.");
        pathBox.value = "‚è≥ ƒêang l·∫•y learning path...";
        const r = await api("getLearningPath",{token,classId,studentId:sid});
        pathBox.value = (r.planText||"").trim();
        toast("ƒê√£ t·∫£i learning path ‚úÖ");
      }catch(e){ toast(e.message||"Learning path l·ªói"); }
    };

    btnSend.onclick = async ()=>{
      try{
        const sid = studentId.value || "";
        if(!sid) return toast("Ch·ªçn h·ªçc sinh tr∆∞·ªõc.");
        if(!msgContent.value.trim()) return toast("N·ªôi dung tin nh·∫Øn ƒëang tr·ªëng.");

        await api("sendMessage",{
          token, classId,
          toRole: toRole.value,
          toStudentId: sid,
          subject: msgSubject.value.trim(),
          content: msgContent.value.trim()
        });

        msgContent.value = "";
        toast("ƒê√£ g·ª≠i tin ‚úÖ");
      }catch(e){ toast(e.message||"G·ª≠i tin l·ªói"); }
    };

    async function loadMsgs(){
      try{
        const sid = studentId.value || "";
        if(!sid) return toast("Ch·ªçn h·ªçc sinh tr∆∞·ªõc.");
        const r = await api("listMessages",{
          token, classId,
          toStudentId: sid,
          limit: 30
        });

        const items = r.messages || [];
        msgList.innerHTML = items.length ? "" : `<div class="muted">Ch∆∞a c√≥ tin nh·∫Øn.</div>`;
        items.forEach(m=>{
          const div=document.createElement("div");
          div.className="dcard";
          div.innerHTML = `
            <div style="font-weight:900">${esc(m.subject||"(Kh√¥ng ti√™u ƒë·ªÅ)")}</div>
            <div class="muted" style="font-size:12px;margin-top:4px">${esc(m.createdAt||"")} ‚Ä¢ From: ${esc(m.fromRole||"")} (${esc(m.fromName||"")})</div>
            <div style="margin-top:8px;white-space:pre-wrap">${esc(m.content||"")}</div>
          `;
          msgList.appendChild(div);
        });
        toast("ƒê√£ t·∫£i tin ‚úÖ");
      }catch(e){ toast(e.message||"T·∫£i tin l·ªói"); }
    }
    btnLoadMsgs.onclick = loadMsgs;

    btnReload.onclick = async ()=>{
      try{
        await loadStudentsSelect_();
        await loadGradebook_();
        await loadMsgs();
        toast("ƒê√£ t·∫£i t·∫•t c·∫£ ‚úÖ");
      }catch(e){ toast(e.message||"Reload l·ªói"); }
    };

    (async ()=>{
      renderTeacherTopbar("gradebook"); // chip s·∫µn c√≥
      await loadStudentsSelect_();
      await loadGradebook_();
      await loadMsgs();
    })();
  </script>
  
</body>
</html>

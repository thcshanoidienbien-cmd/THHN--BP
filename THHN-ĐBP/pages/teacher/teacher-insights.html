<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Thá»‘ng kÃª & PhÃ¢n tÃ­ch</title>
  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#1a73e8"/>

  <style>
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:900;font-size:12px;white-space:nowrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}
    .dcard{
      padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff;
      box-shadow: 0 10px 26px rgba(2,6,23,.04);
    }
    .split{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;align-items:start}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    .quick{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.quick{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.quick{grid-template-columns:1fr}}
    .qcard{
      padding:14px;border:1px solid var(--line);border-radius:16px;
      background: linear-gradient(180deg,#fff,rgba(248,250,252,.92));
    }
    .big{font-size:26px;font-weight:900;margin-top:6px}

    textarea{min-height:140px}
    .list{display:grid;gap:10px}

    /* ===== Page head (Ä‘Ãºng 1 dÃ²ng) ===== */
    .pageHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      margin-top:6px;padding-bottom:12px;border-bottom:1px dashed rgba(148,163,184,.55);
    }
    .pageTitle{display:flex; align-items:flex-start; gap:12px; min-width:0;}
    .picon{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(96,165,250,.25));
      border:1px solid rgba(37,99,235,.18);
      font-size:22px; flex:0 0 auto;
    }
    .pageTitle h1{margin:0;font-size:30px;letter-spacing:.2px;white-space:nowrap}
    .pageTitle .sub{margin-top:6px;color:var(--muted);font-size:13px}

    /* ===== Actions bar (chá»‰ cÃ²n Táº£i láº¡i) ===== */
    .actionsBar{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .btnOneLine{white-space:nowrap}

    /* ===== Section labels ===== */
    .secLabel{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    /* Table tighten */
    .table th{ white-space:nowrap; }
  </style>
</head>

<body data-active="insights">
  <div id="topbar"></div>

  <main class="container">
    <section class="card" style="padding:16px">
      <!-- HEAD -->
      <div class="pageHead">
        <div class="pageTitle">
          <div class="picon">ğŸ“ˆ</div>
          <div style="min-width:0">
            <h1>Thá»‘ng kÃª & PhÃ¢n tÃ­ch</h1>
            <div class="sub" id="sub">â€”</div>
          </div>
        </div>
        <div class="pill" id="me">â€”</div>
      </div>

      <!-- ONLY ACTION: Reload -->
      <div class="actionsBar">
        <button class="btn btnOneLine" id="btnReload" type="button">Táº£i láº¡i dá»¯ liá»‡u</button>
      </div>

      <div class="split mt">
        <!-- LEFT: tá»•ng quan + bÃ¡o cÃ¡o + tiáº¿n Ä‘á»™ -->
        <div class="dcard">
          <div style="font-weight:900">ğŸ“’ Tá»•ng quan lá»›p</div>
          <div class="muted mt">Chá»‰ sá»‘ nhanh â€¢ BÃ¡o cÃ¡o theo thá»i gian â€¢ Tiáº¿n Ä‘á»™ theo há»c sinh</div>

          <div class="secLabel">ğŸ“’ 1) Chá»‰ sá»‘ nhanh</div>
          <div class="quick mt" id="kpi"></div>

          <div class="divider"></div>

          <div class="secLabel">ğŸ“„ 2) BÃ¡o cÃ¡o</div>
          <div class="grid2 mt">
            <div>
              <label>Khoáº£ng thá»i gian bÃ¡o cÃ¡o (ngÃ y)</label>
              <select id="rangeDays">
                <option value="7">7</option>
                <option value="14">14</option>
                <option value="30">30</option>
              </select>
            </div>
            <div class="actions" style="align-items:flex-end;justify-content:flex-end">
              <button class="btn ghost btnOneLine" id="btnReport" type="button">ğŸ“„ Táº¡o bÃ¡o cÃ¡o nhanh</button>
              <button class="btn btnOneLine" id="btnWeeklyAI" type="button">ğŸ¤– BÃ¡o cÃ¡o tuáº§n (AI)</button>
            </div>
          </div>

          <textarea id="reportBox" class="mt" placeholder="BÃ¡o cÃ¡o sáº½ hiá»ƒn thá»‹ táº¡i Ä‘Ã¢y..." readonly></textarea>

          <div class="divider"></div>

          <div style="font-weight:900">ğŸ‘¨â€ğŸ“ 3) Tiáº¿n Ä‘á»™ theo há»c sinh</div>
          <div class="muted mt">Báº¥m chá»n 1 há»c sinh Ä‘á»ƒ xem â€œLá»™ trÃ¬nh há»câ€ vÃ  gá»­i tin nháº¯n</div>
          <div class="mt" id="tableBox"></div>
        </div>

        <!-- RIGHT: lá»™ trÃ¬nh + tin nháº¯n -->
        <div class="dcard">
          <div style="font-weight:900">ğŸ‘¨â€ğŸ“ Lá»™ trÃ¬nh há»c & Tin nháº¯n</div>
          <div class="muted mt">Gá»£i Ã½ lá»™ trÃ¬nh 2 tuáº§n (AI) vÃ  nháº¯n tin tá»›i HS/PH</div>

          <div class="grid2 mt">
            <div>
              <label>Chá»n há»c sinh</label>
              <select id="studentId"></select>
            </div>
            <div class="actions" style="align-items:flex-end;justify-content:flex-end">
              <button class="btn btnOneLine" id="btnPath" type="button">ğŸ§  Láº¥y lá»™ trÃ¬nh há»c</button>
            </div>
          </div>

          <textarea id="pathBox" class="mt" placeholder="Lá»™ trÃ¬nh há»c sáº½ hiá»ƒn thá»‹ táº¡i Ä‘Ã¢y..." readonly></textarea>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label>Gá»­i tá»›i</label>
              <select id="toRole">
                <option value="PARENT">PHá»¤ HUYNH</option>
                <option value="STUDENT">Há»ŒC SINH</option>
              </select>
            </div>
            <div>
              <label>TiÃªu Ä‘á»</label>
              <input id="msgSubject" placeholder="VD: Nháº¯c ná»™p bÃ i / Khen tiáº¿n bá»™...">
            </div>
          </div>

          <label class="mt">Ná»™i dung</label>
          <textarea id="msgContent" placeholder="Nháº­p ná»™i dung tin nháº¯n..."></textarea>

          <div class="actions mt">
            <button class="btn btnOneLine" id="btnSend" type="button">ğŸ“¨ Gá»­i tin</button>
            <button class="btn ghost btnOneLine" id="btnLoadMsgs" type="button">ğŸ“¥ Táº£i tin nháº¯n</button>
          </div>

          <div class="divider"></div>
          <div class="list" id="msgList"></div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <!-- âœ… SSOT: Ä‘Ãºng thá»© tá»± -->
  <script src="../../assets/config.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <!-- âœ… DÃ¹ng teacher.js Ä‘á»ƒ topbar Ä‘á»“ng bá»™ -->
  <script src="../../assets/teacher.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"â€”";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }
    function esc(s){return String(s||"").replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));}

    const session=requireRole("TEACHER");
    if(!session){ throw new Error("Äang chuyá»ƒn vá» Ä‘Äƒng nháº­p..."); }
    const token=session.token;

    // âœ… luÃ´n láº¥y lá»›p qua core.js
    function currentClassId(){
      return getTeacherClassId(session.classId || "5A1");
    }

    // pill hiá»ƒn thá»‹: TÃªn GV â€¢ Lá»›p hiá»‡n táº¡i
    const meEl = document.getElementById("me");
    function syncMe_(){
      if(meEl) meEl.textContent = `${session.displayName||"GiÃ¡o viÃªn"} â€¢ ${currentClassId()}`;
      // badge gÃ³c pháº£i trÃªn topbar (náº¿u teacher.js cÃ³)
      try{ if(typeof setTeacherHeaderBadge==="function") setTeacherHeaderBadge(currentClassId()); }catch(_){}
    }
    syncMe_();

    const sub = document.getElementById("sub");
    const kpi = document.getElementById("kpi");
    const rangeDays = document.getElementById("rangeDays");
    const btnReport = document.getElementById("btnReport");
    const btnWeeklyAI = document.getElementById("btnWeeklyAI");
    const reportBox = document.getElementById("reportBox");
    const tableBox = document.getElementById("tableBox");

    const studentId = document.getElementById("studentId");
    const btnPath = document.getElementById("btnPath");
    const pathBox = document.getElementById("pathBox");

    const toRole = document.getElementById("toRole");
    const msgSubject = document.getElementById("msgSubject");
    const msgContent = document.getElementById("msgContent");
    const btnSend = document.getElementById("btnSend");
    const btnLoadMsgs = document.getElementById("btnLoadMsgs");
    const msgList = document.getElementById("msgList");

    const btnReload = document.getElementById("btnReload");

    let _students=[];

    // âœ… KPI Ä‘á»•i sang ngÃ´n ngá»¯ nhÃ  trÆ°á»ng
    function renderKpi_(gb){
      const rows = gb.rows||[];
      const taskCount = Number(gb.taskCount||0);
      const totalSubmitted = rows.reduce((a,x)=>a+(Number(x.submitted)||0),0);
      const totalGraded = rows.reduce((a,x)=>a+(Number(x.graded)||0),0);

      kpi.innerHTML=`
        <div class="qcard">
          <div class="muted" style="font-weight:900">ğŸ“’ Tá»•ng sá»‘ bÃ i</div>
          <div class="big">${esc(taskCount)}</div>
        </div>
        <div class="qcard">
          <div class="muted" style="font-weight:900">ğŸ‘¨â€ğŸ“ Sá»‘ há»c sinh</div>
          <div class="big">${esc(rows.length)}</div>
        </div>
        <div class="qcard">
          <div class="muted" style="font-weight:900">ğŸ“¨ Tá»•ng lÆ°á»£t ná»™p</div>
          <div class="big">${esc(totalSubmitted)}</div>
        </div>
        <div class="qcard">
          <div class="muted" style="font-weight:900">âœ… ÄÃ£ nháº­n xÃ©t</div>
          <div class="big">${esc(totalGraded)}</div>
        </div>
      `;
    }

    function renderTable_(gb){
      const rows = gb.rows||[];
      if(!rows.length){
        tableBox.innerHTML = `<div class="muted">ChÆ°a cÃ³ danh sÃ¡ch há»c sinh.</div>`;
        return;
      }

      tableBox.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Há»c sinh</th>
              <th>Ná»™p</th>
              <th>ÄÃ£ nháº­n xÃ©t</th>
              <th>Tiáº¿n Ä‘á»™</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const p = Number(String(r.progress||"0%").replace("%",""))||0;
              const pct = Math.max(0,Math.min(100,p));
              return `
                <tr>
                  <td>
                    <div style="font-weight:900">${esc(r.studentId)}</div>
                    <div class="muted">${esc(r.name||"")}</div>
                  </td>
                  <td>${esc(r.submitted||0)}</td>
                  <td>${esc(r.graded||0)}</td>
                  <td>
                    <div class="pbar"><span style="width:${pct}%"></span></div>
                    <div class="muted" style="font-size:12px;margin-top:6px">${pct}%</div>
                  </td>
                  <td><button class="btn ghost btnOneLine" data-st="${esc(r.studentId)}" type="button">Chá»n</button></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      tableBox.querySelectorAll("button[data-st]").forEach(b=>{
        b.onclick=()=>{
          studentId.value = b.getAttribute("data-st");
          toast("ÄÃ£ chá»n há»c sinh âœ…");
        };
      });
    }

    async function loadStudentsSelect_(){
      const r = await api("listStudents",{token, classId: currentClassId()});
      _students = r.students || [];
      studentId.innerHTML = _students.map(s=>`<option value="${esc(s.studentId)}">${esc(s.studentId)} â€¢ ${esc(s.name||"")}</option>`).join("")
        || `<option value="">(chÆ°a cÃ³ há»c sinh)</option>`;

      sub.textContent = `Lá»›p ${r.system.classId} â€¢ Khá»‘i ${r.system.grade} â€¢ ${r.system.subject} â€¢ ${r.system.textbook}`;
      syncMe_();
    }

    async function loadGradebook_(){
      const gb = await api("getGradebook",{token, classId: currentClassId()});
      renderKpi_(gb);
      renderTable_(gb);
    }

    btnReport.onclick = async ()=>{
      try{
        const r = await api("getClassReport",{token, classId: currentClassId(), rangeDays:Number(rangeDays.value||7)});
        const rep = r.report||{};
        reportBox.value = [
          `BÃO CÃO NHANH (${rep.rangeDays||7} ngÃ y)`,
          `- LÆ°á»£t ná»™p bÃ i: ${rep.submissions||0}`,
          `- Ná»™p muá»™n: ${rep.lateSubmissions||0}`,
          `- LÆ°á»£t nháº­n xÃ©t: ${rep.feedbacks||0}`,
          ``,
          `Tá»«: ${rep.since||""}`,
          `Äáº¿n: ${rep.now||""}`
        ].join("\n");
        toast("ÄÃ£ táº¡o bÃ¡o cÃ¡o âœ…");
      }catch(e){ toast(e.message||"Táº¡o bÃ¡o cÃ¡o lá»—i"); }
    };

    btnWeeklyAI.onclick = async ()=>{
      try{
        reportBox.value = "â³ Äang táº¡o bÃ¡o cÃ¡o tuáº§n báº±ng AI...";
        const r = await api("aiClassWeeklyReport",{token, classId: currentClassId(), rangeDays:Number(rangeDays.value||7)});
        reportBox.value = (r.reportText||"").trim() || "AI khÃ´ng tráº£ ná»™i dung.";
        toast("AI Ä‘Ã£ táº¡o bÃ¡o cÃ¡o âœ…");
      }catch(e){ toast(e.message||"BÃ¡o cÃ¡o AI lá»—i"); }
    };

    btnPath.onclick = async ()=>{
      try{
        const sid = studentId.value || "";
        if(!sid) return toast("ChÆ°a cÃ³ há»c sinh.");
        pathBox.value = "â³ Äang láº¥y lá»™ trÃ¬nh há»c...";
        const r = await api("getLearningPath",{token, classId: currentClassId(), studentId:sid});
        pathBox.value = (r.planText||"").trim();
        toast("ÄÃ£ táº£i lá»™ trÃ¬nh há»c âœ…");
      }catch(e){ toast(e.message||"Lá»™ trÃ¬nh há»c lá»—i"); }
    };

    btnSend.onclick = async ()=>{
      try{
        const sid = studentId.value || "";
        if(!sid) return toast("Chá»n há»c sinh trÆ°á»›c.");
        if(!msgContent.value.trim()) return toast("Ná»™i dung tin nháº¯n Ä‘ang trá»‘ng.");

        await api("sendMessage",{
          token, classId: currentClassId(),
          toRole: toRole.value,
          toStudentId: sid,
          subject: msgSubject.value.trim(),
          content: msgContent.value.trim()
        });

        msgContent.value = "";
        toast("ÄÃ£ gá»­i tin âœ…");
      }catch(e){ toast(e.message||"Gá»­i tin lá»—i"); }
    };

    async function loadMsgs(){
      try{
        const sid = studentId.value || "";
        if(!sid) return toast("Chá»n há»c sinh trÆ°á»›c.");
        const r = await api("listMessages",{
          token, classId: currentClassId(),
          toStudentId: sid,
          limit: 30
        });

        const items = r.messages || [];
        msgList.innerHTML = items.length ? "" : `<div class="muted">ChÆ°a cÃ³ tin nháº¯n.</div>`;
        items.forEach(m=>{
          const div=document.createElement("div");
          div.className="dcard";
          div.innerHTML = `
            <div style="font-weight:900">${esc(m.subject||"(KhÃ´ng tiÃªu Ä‘á»)")}</div>
            <div class="muted" style="font-size:12px;margin-top:4px">${esc(m.createdAt||"")} â€¢ Tá»«: ${esc(m.fromRole||"")} (${esc(m.fromName||"")})</div>
            <div style="margin-top:8px;white-space:pre-wrap">${esc(m.content||"")}</div>
          `;
          msgList.appendChild(div);
        });
        toast("ÄÃ£ táº£i tin nháº¯n âœ…");
      }catch(e){ toast(e.message||"Táº£i tin nháº¯n lá»—i"); }
    }
    btnLoadMsgs.onclick = loadMsgs;

    btnReload.onclick = async ()=>{
      try{
        await loadStudentsSelect_();
        await loadGradebook_();
        await loadMsgs();
        toast("ÄÃ£ táº£i táº¥t cáº£ âœ…");
      }catch(e){ toast(e.message||"Táº£i dá»¯ liá»‡u lá»—i"); }
    };

    (async ()=>{
      // âœ… MENU: Ä‘Ãºng key theo teacher.js
      renderTeacherTopbar("insights");
      await loadStudentsSelect_();
      await loadGradebook_();
      await loadMsgs();
    })();
  </script>
</body>
</html>

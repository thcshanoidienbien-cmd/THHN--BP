<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HEDU â€¢ Grading</title>
  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#1a73e8"/>
  <style>
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:900;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}
    .dcard{padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    textarea{min-height:160px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body data-active="grading">
  <div id="topbar"></div>

  <main class="container">
    <section class="card" style="padding:16px">
      <div class="row">
        <div>
          <h1 style="margin:0">Cháº¥m bÃ i & Nháº­n xÃ©t ğŸ“</h1>
          <div class="muted" id="sub">â€”</div>
        </div>
        <div class="pill" id="me">â€”</div>
      </div>

      <div class="actions mt">
        <button class="btn ghost" id="btnBack" type="button">â† Quay láº¡i bÃ i ná»™p</button>
        <button class="btn ghost" id="btnInsights" type="button">ğŸ“ˆ Insights</button>
      </div>

      <div class="split mt">
        <!-- LEFT: submission -->
        <div class="dcard">
          <div style="font-weight:900">ğŸ“¨ BÃ i ná»™p</div>
          <div class="muted mt" id="meta">â€”</div>

          <label class="mt">Äá» / Task (tÃ³m táº¯t)</label>
          <textarea id="taskBody" readonly></textarea>

          <label class="mt">BÃ i lÃ m há»c sinh</label>
          <textarea id="answer" readonly></textarea>
        </div>

        <!-- RIGHT: grading -->
        <div class="dcard">
          <div class="row">
            <div style="font-weight:900">âœ… Cháº¥m & lÆ°u nháº­n xÃ©t</div>
            <span class="badge ok">â— Ready</span>
          </div>

          <div class="grid2 mt">
            <div>
              <label>Äiá»ƒm</label>
              <input id="score" placeholder="VD: 8">
            </div>
            <div>
              <label>Thang Ä‘iá»ƒm</label>
              <input id="scoreMax" value="10">
            </div>
          </div>

          <label class="mt">Rubric snapshot</label>
          <textarea id="rubric" class="mono" readonly></textarea>

          <div class="actions mt">
            <button class="btn" id="btnAI" type="button">ğŸ¤– AI gá»£i Ã½ nháº­n xÃ©t</button>
            <button class="btn ghost" id="btnSaveQuickHS" type="button">ğŸ’¬ LÆ°u nhanh (HS)</button>
            <button class="btn ghost" id="btnSaveQuickPH" type="button">ğŸ’¬ LÆ°u nhanh (PH)</button>
          </div>

          <label class="mt">Nháº­n xÃ©t cho Há»ŒC SINH</label>
          <textarea id="fbHS" placeholder="ğŸ‘ 2 Ã½ tá»‘t..."></textarea>

          <label class="mt">Nháº­n xÃ©t cho PHá»¤ HUYNH</label>
          <textarea id="fbPH" placeholder="HÆ°á»›ng dáº«n Ä‘á»“ng hÃ nh 10 phÃºt/ngÃ y..."></textarea>

          <label class="mt">Nháº­n xÃ©t lÆ°u Há»’ SÆ </label>
          <textarea id="fbProfile" placeholder="KhÃ¡ch quan, táº­p trung ká»¹ nÄƒng..."></textarea>

          <div class="actions mt">
            <button class="btn" id="btnSave" type="button">ğŸ’¾ LÆ°u cháº¥m bÃ i</button>
          </div>

          <div class="muted mt" id="hint">â€”</div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <script src="../../assets/config.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/teacher-snippet.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"â€”";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }
    function qp(name){
      const u=new URL(location.href);
      return u.searchParams.get(name)||"";
    }

    const session=requireRole("TEACHER");
    const token=session.token;
    const classId=localStorage.getItem("hedu_teacher_classId") || session.classId || "5A1";
    me.textContent = `${session.displayName||"GiÃ¡o viÃªn"} â€¢ ${classId}`;
    const submissionId = qp("submissionId");

    btnBack.onclick=()=>location.href="./teacher-submissions.html";
    btnInsights.onclick=()=>location.href="./teacher-insights.html";

    let _ctx = { taskId:"", studentId:"", grade:"", subject:"", textbook:"" };

    async function load(){
      try{
        if(!submissionId) throw new Error("Thiáº¿u submissionId");
        const r = await api("getSubmissionDetail", { token, classId, submissionId });

        sub.textContent = `Pilot ${r.system.classId} â€¢ Khá»‘i ${r.system.grade} â€¢ ${r.system.subject} â€¢ ${r.system.textbook}`;

        const s = r.submission || {};
        const t = r.task || {};
        const fb = r.feedback || null;

        _ctx.taskId = s.taskId || t.taskId || "";
        _ctx.studentId = s.studentId || "";
        _ctx.grade = t.grade || r.system.grade;
        _ctx.subject = t.subject || r.system.subject;
        _ctx.textbook = t.textbook || r.system.textbook;

        meta.textContent = `HS: ${_ctx.studentId} â€¢ Task: ${_ctx.taskId} â€¢ Ná»™p lÃºc: ${s.createdAt||""}`;
        taskBody.value = (t.body || "").trim();
        answer.value = (s.answer || "").trim();
        rubric.value = (t.rubric || "").trim();

        if(fb){
          score.value = fb.score || "";
          scoreMax.value = fb.scoreMax || "10";
          fbHS.value = fb.feedbackHS || "";
          fbPH.value = fb.feedbackPH || "";
          fbProfile.value = fb.feedbackProfile || "";
          hint.textContent = "ÄÃ£ cÃ³ nháº­n xÃ©t trÆ°á»›c Ä‘Ã³ (náº¿u muá»‘n, lÆ°u thÃªm báº£n má»›i).";
        }else{
          hint.textContent = "ChÆ°a cÃ³ nháº­n xÃ©t. CÃ³ thá»ƒ dÃ¹ng AI Ä‘á»ƒ gá»£i Ã½ ğŸ§ ";
        }

        toast("ÄÃ£ táº£i âœ…");
      }catch(e){
        toast(e.message||"KhÃ´ng táº£i Ä‘Æ°á»£c bÃ i.");
      }
    }

    btnAI.onclick = async ()=>{
      try{
        if(!rubric.value.trim()) return toast("Task chÆ°a cÃ³ rubric.");
        if(!answer.value.trim()) return toast("BÃ i lÃ m trá»‘ng.");

        const r = await api("aiSuggestFeedback",{
          token,
          grade:_ctx.grade,
          subject:_ctx.subject,
          textbook:_ctx.textbook,
          rubric: rubric.value,
          answer: answer.value
        });

        const txt = String(r.feedbackText||"").trim();
        if(!txt) return toast("AI khÃ´ng tráº£ ná»™i dung.");

        // Heuristic split 3 pháº§n
        // (Náº¿u AI tráº£ Ä‘Ãºng Ä‘á»‹nh dáº¡ng, váº«n ok; náº¿u khÃ´ng thÃ¬ Ä‘á»ƒ toÃ n bá»™ vÃ o HS)
        fbHS.value = txt;
        toast("AI Ä‘Ã£ gá»£i Ã½ nháº­n xÃ©t âœ… (GV chá»‰nh láº¡i cho chuáº©n)");
      }catch(e){ toast(e.message||"Gá»i AI lá»—i"); }
    };

    btnSaveQuickHS.onclick = async ()=>{
      try{
        if(!fbHS.value.trim()) return toast("Nháº­n xÃ©t HS Ä‘ang trá»‘ng.");
        await api("saveFeedbackTyped",{
          token, classId,
          studentId:_ctx.studentId,
          taskId:_ctx.taskId,
          feedbackText: fbHS.value.trim(),
          feedbackType:"HS"
        });
        toast("ÄÃ£ lÆ°u nhanh (HS) âœ…");
      }catch(e){ toast(e.message||"LÆ°u lá»—i"); }
    };

    btnSaveQuickPH.onclick = async ()=>{
      try{
        if(!fbPH.value.trim()) return toast("Nháº­n xÃ©t PH Ä‘ang trá»‘ng.");
        await api("saveFeedbackTyped",{
          token, classId,
          studentId:_ctx.studentId,
          taskId:_ctx.taskId,
          feedbackText: fbPH.value.trim(),
          feedbackType:"PH"
        });
        toast("ÄÃ£ lÆ°u nhanh (PH) âœ…");
      }catch(e){ toast(e.message||"LÆ°u lá»—i"); }
    };

    btnSave.onclick = async ()=>{
      try{
        const sc = score.value.trim();
        const sm = scoreMax.value.trim() || "10";

        if(!fbHS.value.trim() && !fbPH.value.trim() && !fbProfile.value.trim()){
          return toast("Cáº§n cÃ³ Ã­t nháº¥t 1 nháº­n xÃ©t.");
        }

        await api("saveGrade",{
          token, classId,
          taskId:_ctx.taskId,
          studentId:_ctx.studentId,
          score: sc,
          scoreMax: sm,
          feedbackHS: fbHS.value.trim(),
          feedbackPH: fbPH.value.trim(),
          feedbackProfile: fbProfile.value.trim(),
          rubricSnapshot: rubric.value.trim(),
          aiUsed: true
        });

        toast("ÄÃ£ lÆ°u cháº¥m bÃ i âœ…");
      }catch(e){ toast(e.message||"LÆ°u cháº¥m bÃ i lá»—i"); }
    };

    (async ()=>{
      renderTeacherTopbar("subs");
      await load();
    })();
  </script>
</body>
</html>

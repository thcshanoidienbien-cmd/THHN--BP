<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cháº¥m bÃ i & Nháº­n xÃ©t</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#2563eb"/>

  <style>
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:900;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}
    .dcard{padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    textarea{min-height:160px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body data-active="grading">
  <div id="topbar"></div>

  <main class="container">
    <section class="card" style="padding:16px">
      <div class="row">
        <div>
          <h1 style="margin:0">Cháº¥m bÃ i & Nháº­n xÃ©t ğŸ“</h1>
          <div class="muted" id="sub">â€”</div>
        </div>
        <div class="pill" id="me">â€”</div>
      </div>

      <div class="actions mt">
        <button class="btn ghost" id="btnBack" type="button">â† Quay láº¡i danh sÃ¡ch bÃ i ná»™p</button>
        <button class="btn ghost" id="btnInsights" type="button">ğŸ“Š Thá»‘ng kÃª & PhÃ¢n tÃ­ch</button>
      </div>

      <div class="split mt">
        <!-- TRÃI: BÃ i ná»™p -->
        <div class="dcard">
          <div style="font-weight:900">ğŸ“¨ BÃ i ná»™p</div>
          <div class="muted mt" id="meta">â€”</div>

          <label class="mt">Äá» bÃ i (tÃ³m táº¯t)</label>
          <textarea id="taskBody" readonly></textarea>

          <label class="mt">BÃ i lÃ m cá»§a há»c sinh</label>
          <textarea id="answer" readonly></textarea>
        </div>

        <!-- PHáº¢I: Cháº¥m bÃ i -->
        <div class="dcard">
          <div class="row">
            <div style="font-weight:900">âœ… Cháº¥m Ä‘iá»ƒm & lÆ°u nháº­n xÃ©t</div>
            <span class="badge ok">â— Sáºµn sÃ ng</span>
          </div>

          <div class="grid2 mt">
            <div>
              <label>Äiá»ƒm</label>
              <input id="score" placeholder="VÃ­ dá»¥: 8">
            </div>
            <div>
              <label>Thang Ä‘iá»ƒm</label>
              <input id="scoreMax" value="10">
            </div>
          </div>

          <label class="mt">Rubric (tiÃªu chÃ­ cháº¥m) â€“ báº£n chá»¥p</label>
          <textarea id="rubric" class="mono" readonly></textarea>

          <div class="actions mt">
            <button class="btn" id="btnAI" type="button">ğŸ¤– AI gá»£i Ã½ nháº­n xÃ©t</button>
            <button class="btn ghost" id="btnSaveQuickHS" type="button">ğŸ’¬ LÆ°u nhanh (Há»c sinh)</button>
            <button class="btn ghost" id="btnSaveQuickPH" type="button">ğŸ’¬ LÆ°u nhanh (Phá»¥ huynh)</button>
          </div>

          <label class="mt">Nháº­n xÃ©t cho Há»ŒC SINH</label>
          <textarea id="fbHS" placeholder="VÃ­ dá»¥: Con lÃ m tá»‘t 2 Ã½... / Cáº§n bá»• sung 1 Ã½..."></textarea>

          <label class="mt">Nháº­n xÃ©t cho PHá»¤ HUYNH</label>
          <textarea id="fbPH" placeholder="VÃ­ dá»¥: Má»—i ngÃ y luyá»‡n 10 phÃºt... / Nháº¯c con Ä‘á»c ká»¹ Ä‘á»..."></textarea>

          <label class="mt">Nháº­n xÃ©t lÆ°u Há»’ SÆ </label>
          <textarea id="fbProfile" placeholder="KhÃ¡ch quan, táº­p trung vÃ o ká»¹ nÄƒng vÃ  tiáº¿n bá»™..."></textarea>

          <div class="actions mt">
            <button class="btn" id="btnSave" type="button">ğŸ’¾ LÆ°u cháº¥m bÃ i</button>
          </div>

          <div class="muted mt" id="hint">â€”</div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <!-- âœ… Load Ä‘Ãºng thá»© tá»± SSOT -->
  <script src="../../assets/config.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <!-- âœ… DÃ¹ng teacher.js (khÃ´ng dÃ¹ng teacher-snippet.js theo yÃªu cáº§u cá»§a anh) -->
  <script src="../../assets/teacher.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"â€”";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }
    function qp(name){
      const u=new URL(location.href);
      return u.searchParams.get(name)||"";
    }

    const session = requireRole("TEACHER");
    if(!session) { throw new Error("Äang chuyá»ƒn vá» Ä‘Äƒng nháº­p..."); }

    const token = session?.token || "";

    function currentClassId(){
      return getTeacherClassId(session.classId || "5A1");
    }

    // pill hiá»ƒn thá»‹: TÃªn GV â€¢ Lá»›p hiá»‡n táº¡i
    const meEl = document.getElementById("me");
    if (meEl) meEl.textContent = `${session.displayName||"GiÃ¡o viÃªn"} â€¢ ${currentClassId()}`;

    const submissionId = qp("submissionId");

    const btnBack = document.getElementById("btnBack");
    const btnInsights = document.getElementById("btnInsights");
    const sub = document.getElementById("sub");
    const meta = document.getElementById("meta");
    const taskBody = document.getElementById("taskBody");
    const answer = document.getElementById("answer");
    const rubric = document.getElementById("rubric");

    const score = document.getElementById("score");
    const scoreMax = document.getElementById("scoreMax");
    const fbHS = document.getElementById("fbHS");
    const fbPH = document.getElementById("fbPH");
    const fbProfile = document.getElementById("fbProfile");
    const hint = document.getElementById("hint");

    const btnAI = document.getElementById("btnAI");
    const btnSaveQuickHS = document.getElementById("btnSaveQuickHS");
    const btnSaveQuickPH = document.getElementById("btnSaveQuickPH");
    const btnSave = document.getElementById("btnSave");

    btnBack.onclick=()=>location.href="./teacher-submissions.html";
    btnInsights.onclick=()=>location.href="./teacher-insights.html";

    let _ctx = { taskId:"", studentId:"", grade:"", subject:"", textbook:"" };

    async function load(){
      try{
        if(!submissionId) throw new Error("Thiáº¿u mÃ£ bÃ i ná»™p (submissionId).");

        const r = await api("getSubmissionDetail", { token, classId: currentClassId(), submissionId });

        // dÃ²ng mÃ´ táº£ há»‡ thá»‘ng (giá»¯ nguyÃªn logic, Viá»‡t hoÃ¡ nhÃ£n)
        sub.textContent = `Khá»‘i ${r.system.grade} â€¢ ${r.system.subject} â€¢ ${r.system.textbook}`;

        const s = r.submission || {};
        const t = r.task || {};
        const fb = r.feedback || null;

        _ctx.taskId = s.taskId || t.taskId || "";
        _ctx.studentId = s.studentId || "";
        _ctx.grade = t.grade || r.system.grade;
        _ctx.subject = t.subject || r.system.subject;
        _ctx.textbook = t.textbook || r.system.textbook;

        meta.textContent = `Há»c sinh: ${_ctx.studentId} â€¢ BÃ i: ${_ctx.taskId} â€¢ Ná»™p lÃºc: ${s.createdAt||""}`;
        taskBody.value = (t.body || "").trim();
        answer.value = (s.answer || "").trim();
        rubric.value = (t.rubric || "").trim();

        if(fb){
          score.value = fb.score || "";
          scoreMax.value = fb.scoreMax || "10";
          fbHS.value = fb.feedbackHS || "";
          fbPH.value = fb.feedbackPH || "";
          fbProfile.value = fb.feedbackProfile || "";
          hint.textContent = "ÄÃ£ cÃ³ nháº­n xÃ©t trÆ°á»›c Ä‘Ã³. Náº¿u cáº§n, anh cÃ³ thá»ƒ chá»‰nh sá»­a vÃ  lÆ°u láº¡i báº£n má»›i.";
        }else{
          hint.textContent = "ChÆ°a cÃ³ nháº­n xÃ©t. Anh cÃ³ thá»ƒ dÃ¹ng AI Ä‘á»ƒ gá»£i Ã½ rá»“i chá»‰nh láº¡i cho chuáº©n âœ…";
        }

        // luÃ´n hiá»‡n Ä‘Ãºng lá»›p (náº¿u giÃ¡o viÃªn Ä‘á»•i lá»›p á»Ÿ nÆ¡i khÃ¡c)
        if (meEl) meEl.textContent = `${session.displayName||"GiÃ¡o viÃªn"} â€¢ ${currentClassId()}`;

        toast("ÄÃ£ táº£i bÃ i âœ…");
      }catch(e){
        toast(e.message||"KhÃ´ng táº£i Ä‘Æ°á»£c bÃ i ná»™p.");
      }
    }

    btnAI.onclick = async ()=>{
      try{
        if(!rubric.value.trim()) return toast("BÃ i nÃ y chÆ°a cÃ³ rubric (tiÃªu chÃ­ cháº¥m).");
        if(!answer.value.trim()) return toast("BÃ i lÃ m Ä‘ang trá»‘ng.");

        const r = await api("aiSuggestFeedback",{
          token,
          grade:_ctx.grade,
          subject:_ctx.subject,
          textbook:_ctx.textbook,
          rubric: rubric.value,
          answer: answer.value
        });

        const txt = String(r.feedbackText||"").trim();
        if(!txt) return toast("AI chÆ°a tráº£ ná»™i dung gá»£i Ã½.");

        fbHS.value = txt;
        toast("AI Ä‘Ã£ gá»£i Ã½ âœ… (Anh chá»‰nh láº¡i cÃ¢u chá»¯ cho Ä‘Ãºng lá»›p/Ä‘Ãºng chuáº©n)");
      }catch(e){
        toast(e.message||"Gá»i AI bá»‹ lá»—i.");
      }
    };

    btnSaveQuickHS.onclick = async ()=>{
      try{
        if(!fbHS.value.trim()) return toast("Nháº­n xÃ©t cho há»c sinh Ä‘ang trá»‘ng.");
        await api("saveFeedbackTyped",{
          token, classId: currentClassId(),
          studentId:_ctx.studentId,
          taskId:_ctx.taskId,
          feedbackText: fbHS.value.trim(),
          feedbackType:"HS"
        });
        toast("ÄÃ£ lÆ°u nhanh (Há»c sinh) âœ…");
      }catch(e){
        toast(e.message||"LÆ°u nhanh bá»‹ lá»—i.");
      }
    };

    btnSaveQuickPH.onclick = async ()=>{
      try{
        if(!fbPH.value.trim()) return toast("Nháº­n xÃ©t cho phá»¥ huynh Ä‘ang trá»‘ng.");
        await api("saveFeedbackTyped",{
          token, classId: currentClassId(),
          studentId:_ctx.studentId,
          taskId:_ctx.taskId,
          feedbackText: fbPH.value.trim(),
          feedbackType:"PH"
        });
        toast("ÄÃ£ lÆ°u nhanh (Phá»¥ huynh) âœ…");
      }catch(e){
        toast(e.message||"LÆ°u nhanh bá»‹ lá»—i.");
      }
    };

    btnSave.onclick = async ()=>{
      try{
        const sc = score.value.trim();
        const sm = scoreMax.value.trim() || "10";

        if(!fbHS.value.trim() && !fbPH.value.trim() && !fbProfile.value.trim()){
          return toast("Cáº§n cÃ³ Ã­t nháº¥t 1 ná»™i dung nháº­n xÃ©t trÆ°á»›c khi lÆ°u.");
        }

        await api("saveGrade",{
          token, classId: currentClassId(),
          taskId:_ctx.taskId,
          studentId:_ctx.studentId,
          score: sc,
          scoreMax: sm,
          feedbackHS: fbHS.value.trim(),
          feedbackPH: fbPH.value.trim(),
          feedbackProfile: fbProfile.value.trim(),
          rubricSnapshot: rubric.value.trim(),
          aiUsed: true
        });

        toast("ÄÃ£ lÆ°u cháº¥m bÃ i âœ…");
      }catch(e){
        toast(e.message||"LÆ°u cháº¥m bÃ i bá»‹ lá»—i.");
      }
    };

    (async ()=>{
      // âœ… topbar chuáº©n (logo + menu + Ä‘Äƒng xuáº¥t) do teacher.js dá»±ng
      renderTeacherTopbar("grading");
      await load();
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cá»•ng GiÃ¡o viÃªn</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#2563eb"/>

  <style>
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}
    .dash{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.dash{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.dash{grid-template-columns:1fr}}

    /* ===== Pro Hero ===== */
    .heroHead{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      padding:2px 0 12px;
      border-bottom:1px dashed rgba(148,163,184,.6);
      margin-bottom:12px;
    }
    .heroTitle{margin:0; font-size:34px; letter-spacing:-.02em}
    .heroSub{margin-top:6px}
    .heroRight{display:flex; flex-direction:column; align-items:flex-end; gap:8px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chipLite{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      font-weight:900;
      font-size:13px;
      box-shadow: 0 8px 22px rgba(15,23,42,.04);
      white-space:nowrap;
    }
    .chipLite strong{font-weight:900}
    .lastUpdate{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      text-align:right;
      max-width:360px;
    }

    /* ===== Row 2 (Week + Notes) ===== */
    .miniTitle{margin:0 0 6px; font-size:16px}
    .summaryGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:980px){.summaryGrid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.summaryGrid{grid-template-columns:1fr}}
    .miniKpi{
      padding:14px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
    }
    .miniKpi .t{color:var(--muted); font-size:12px; font-weight:900}
    .miniKpi .v{font-size:22px; font-weight:900; margin-top:6px}

    /* ===== OVERRIDE: KPI gÃ³c pháº£i (Chá»‰ sá»‘ nhanh) ===== */
    .dash{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:980px){.dash{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.dash{grid-template-columns:1fr}}

    .dash .dcard{
      padding:14px 12px;
      border-radius:14px;
      text-align:center;
    }

    .dash .dcard .muted{
      font-size:12px;
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;   /* âœ… Ã©p 1 dÃ²ng */
    }

    .dash .dcard > div:last-child{
      font-size:22px;
      font-weight:800;
      margin-top:6px;
    }

    /* ===== OVERRIDE: 3 box TÃ³m táº¯t tuáº§n ===== */
    .summaryGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:980px){.summaryGrid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.summaryGrid{grid-template-columns:1fr}}

    .miniKpi{
      padding:14px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      text-align:center;      /* âœ… cÄƒn giá»¯a Ä‘áº¹p */
    }

    .miniKpi .t{
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      line-height:1.4;
    }

    .miniKpi .v{
      font-size:20px;
      font-weight:800;
      margin-top:6px;
    }

    .noteBox textarea{
      min-height: 150px;
    }
    .noteMeta{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
  </style>
</head>

<body data-active="dashboard">
  <!-- TOPBAR DÃ™NG CHUNG (cÃ³ LOGO) -->
  <div id="topbar"></div>

  <main class="container">

    <section class="card" style="padding:18px">

      <!-- ===== HERO (Pro) ===== -->
      <div class="heroHead">
        <div>
          <h1 class="heroTitle">Cá»•ng GiÃ¡o viÃªn</h1>
          <div class="muted heroSub">Báº£ng Ä‘iá»u khiá»ƒn â€¢ Quáº£n lÃ½ lá»›p â€¢ Theo dÃµi tiáº¿n Ä‘á»™</div>
        </div>

        <div class="heroRight">
          <div class="chips">
            <!-- âœ… Chá»‰ hiá»‡n tÃªn GV (khÃ´ng kÃ¨m â€œâ€¢ Lá»›p â€¦â€) -->
            <span class="chipLite" id="meChip">ğŸ‘©â€ğŸ« <strong id="meName">â€”</strong></span>

            <!-- âœ… Chá»‰ hiá»‡n lá»›p Ä‘Ãºng vá»›i lá»›p Ä‘ang chá»n -->
            <span class="chipLite" id="classChip">ğŸ·ï¸ <strong id="classNow">â€”</strong></span>
          </div>

          <div class="lastUpdate" id="lastUpdate">Cáº­p nháº­t láº§n cuá»‘i: â€”</div>
        </div>
      </div>

      <!-- ===== ROW 1 ===== -->
      <div class="grid2 mt">

        <!-- ===== Cá»˜T TRÃI ===== -->
        <div class="dcard">
          <h3 style="margin:0 0 6px">ğŸ“Œ Lá»›p Ä‘ang quáº£n lÃ½</h3>
          <div class="muted">Chá»n lá»›p â†’ cÃ¡c trang khÃ¡c tá»± nháº­n lá»›p âœ…</div>

          <div class="mt">
            <label>Lá»›p</label>
            <select id="classId"></select>
          </div>

          <div class="mt muted" id="sub">â€”</div>
        </div>

        <!-- ===== Cá»˜T PHáº¢I ===== -->
        <div class="dcard">
          <h3 style="margin:0 0 6px">âš¡ Chá»‰ sá»‘ nhanh</h3>
          <div class="muted">Tá»•ng quan theo lá»›p</div>

          <div class="dash mt" id="dash"></div>

          <div class="actions mt">
            <button class="btn" id="btnRefresh" type="button">Táº£i dá»¯ liá»‡u</button>
          </div>
        </div>

      </div>

      <!-- ===== ROW 2 ===== -->
      <div class="grid2 mt">

        <!-- ===== TÃ“M Táº®T TUáº¦N ===== -->
        <div class="dcard">
          <h3 class="miniTitle">ğŸ—“ï¸ TÃ³m táº¯t tuáº§n</h3>
          <div class="muted">Tá»± tá»•ng há»£p tá»« bÃ i ná»™p & sá»• Ä‘iá»ƒm (khÃ´ng cáº§n endpoint má»›i)</div>

          <div class="summaryGrid" id="weekBox">
            <div class="miniKpi">
              <div class="t">BÃ i ná»™p trong tuáº§n</div>
              <div class="v" id="wk_subs">â€”</div>
            </div>
            <div class="miniKpi">
              <div class="t">ÄÃ£ nháº­n xÃ©t trong tuáº§n</div>
              <div class="v" id="wk_graded">â€”</div>
            </div>
            <div class="miniKpi">
              <div class="t">ChÆ°a nháº­n xÃ©t (Æ°á»›c tÃ­nh)</div>
              <div class="v" id="wk_pending">â€”</div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px; font-weight:800; font-size:12px">
            Ghi chÃº: â€œChÆ°a nháº­n xÃ©tâ€ Ä‘Æ°á»£c Æ°á»›c tÃ­nh dá»±a trÃªn sá»‘ bÃ i ná»™p tuáº§n nÃ y trá»« Ä‘i sá»‘ Ä‘Ã£ nháº­n xÃ©t (náº¿u dá»¯ liá»‡u thá»i gian khÃ´ng Ä‘á»§, há»‡ thá»‘ng sáº½ hiá»ƒn thá»‹ theo tá»•ng).
          </div>
        </div>

        <!-- ===== GHI CHÃš NHANH ===== -->
        <div class="dcard noteBox">
          <h3 class="miniTitle">ğŸ“ Ghi chÃº nhanh</h3>
          <div class="muted">LÆ°u theo tá»«ng lá»›p (chá»‰ lÆ°u trÃªn mÃ¡y cá»§a giÃ¡o viÃªn)</div>

          <div class="mt">
            <label>Ná»™i dung</label>
            <textarea id="noteText" placeholder="VÃ­ dá»¥: Nháº¯c HS ná»™p bÃ i trÆ°á»›c thá»© 6 â€¢ Danh sÃ¡ch HS cáº§n há»— trá»£â€¦"></textarea>
          </div>

          <div class="actions mt">
            <button class="btn" id="btnSaveNote" type="button">LÆ°u ghi chÃº</button>
            <button class="btn ghost" id="btnClearNote" type="button">XoÃ¡</button>
          </div>

          <div class="noteMeta">
            <span id="noteKeyHint">Lá»›p: â€”</span>
            <span id="noteSavedAt">ChÆ°a lÆ°u</span>
          </div>
        </div>

      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <script src="../../assets/config.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/teacher.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"â€”";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }
    function esc(s){return String(s||"").replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));}

    // ===== Session =====
    const session = requireRole("TEACHER");
    const token = session?.token || "";

    // âœ… Chip tÃªn GV (khÃ´ng kÃ¨m lá»›p)
    document.getElementById("meName").textContent = (session.displayName || "GiÃ¡o viÃªn").trim();

    function getSelectedClass_(){ return getTeacherClassId(session.classId || ""); }
    function setSelectedClass_(cid){ setTeacherClassId(cid); }

    // ===== Helpers: time =====
    function fmtTime_(d){
      const pad=n=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())} - ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function setLastUpdate_(){
      document.getElementById("lastUpdate").textContent = "Cáº­p nháº­t láº§n cuá»‘i: " + fmtTime_(new Date());
    }

    // ===== Helpers: submissions time parsing =====
    function toDate_(x){
      if(!x) return null;
      if(x instanceof Date) return x;
      // number timestamp
      if(typeof x === "number") {
        const d = new Date(x);
        return isNaN(d.getTime()) ? null : d;
      }
      // string
      const s = String(x).trim();
      if(!s) return null;
      const t = Date.parse(s);
      if(!isNaN(t)) return new Date(t);
      // dd/mm/yyyy fallback
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{1,2}))?$/);
      if(m){
        const dd=+m[1], mm=+m[2]-1, yy=+m[3];
        const hh=+(m[4]||0), mi=+(m[5]||0);
        const d = new Date(yy,mm,dd,hh,mi,0,0);
        return isNaN(d.getTime()) ? null : d;
      }
      return null;
    }
    function startOfWeekMonday_(d){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
      const day = x.getDay(); // 0=Sun
      const diff = (day === 0 ? -6 : 1 - day);
      x.setDate(x.getDate() + diff);
      return x;
    }

    // ===== Notes (localStorage by class) =====
    function noteKey_(classId){
      return "hedu_teacher_note_" + String(classId||"").trim().toUpperCase();
    }
    function loadNote_(classId){
      const key = noteKey_(classId);
      document.getElementById("noteKeyHint").textContent = "Lá»›p: " + (classId || "â€”");
      try{
        const raw = localStorage.getItem(key) || "";
        document.getElementById("noteText").value = raw;
        const tkey = key + "_at";
        const at = localStorage.getItem(tkey);
        document.getElementById("noteSavedAt").textContent = at ? ("ÄÃ£ lÆ°u: " + at) : "ChÆ°a lÆ°u";
      }catch(e){}
    }
    function saveNote_(classId){
      const key = noteKey_(classId);
      const tkey = key + "_at";
      const val = document.getElementById("noteText").value || "";
      try{
        localStorage.setItem(key, val);
        const when = fmtTime_(new Date());
        localStorage.setItem(tkey, when);
        document.getElementById("noteSavedAt").textContent = "ÄÃ£ lÆ°u: " + when;
        toast("ÄÃ£ lÆ°u ghi chÃº âœ…");
      }catch(e){
        toast("KhÃ´ng lÆ°u Ä‘Æ°á»£c ghi chÃº");
      }
    }
    function clearNote_(classId){
      const key = noteKey_(classId);
      const tkey = key + "_at";
      try{
        localStorage.removeItem(key);
        localStorage.removeItem(tkey);
        document.getElementById("noteText").value = "";
        document.getElementById("noteSavedAt").textContent = "ChÆ°a lÆ°u";
        toast("ÄÃ£ xoÃ¡ ghi chÃº âœ…");
      }catch(e){
        toast("KhÃ´ng xoÃ¡ Ä‘Æ°á»£c ghi chÃº");
      }
    }

    async function loadClasses(){
      const sel=document.getElementById("classId");
      try{
        const r=await api("listClassesForTeacher",{token});
        const items=r.classes||[];
        sel.innerHTML = items.map(c=>{
          const name = c.className && c.className !== c.classId
            ? `${c.classId} â€¢ ${c.className}`
            : c.classId;
          return `<option value="${esc(c.classId)}">${esc(name)}</option>`;
        }).join("") || `<option value="5A1">5A1</option>`;
      }catch(e){
        const fallback = getSelectedClass_() || "5A1";
        sel.innerHTML = `<option value="${esc(fallback)}">${esc(fallback)}</option>`;
      }

      // set default
      const current = getSelectedClass_() || sel.value || "5A1";
      sel.value = current;

      // âœ… class chip (hiá»‡n Ä‘Ãºng lá»›p Ä‘ang chá»n)
      document.getElementById("classNow").textContent = current || "â€”";
      loadNote_(current);

      sel.onchange = async ()=>{
        const cid = sel.value || "5A1";
        setSelectedClass_(cid);
        document.getElementById("classNow").textContent = cid;
        loadNote_(cid);
        toast("ÄÃ£ chá»n lá»›p âœ…");
        await refresh();
      };
    }

    function renderKpi_(k){
      const box=document.getElementById("dash");
      box.innerHTML="";
      const cards=[
        {t:"ğŸ‘¨â€ğŸ“ Há»c sinh", v:k.students||0},
        {t:"ğŸ“š BÃ i Ä‘Ã£ giao", v:k.tasks||0},
        {t:"ğŸ“¨ BÃ i ná»™p", v:k.submissions||0},
        {t:"ğŸ“ ÄÃ£ nháº­n xÃ©t", v:k.feedbacks||0},
      ];
      cards.forEach(c=>{
        const d=document.createElement("div");
        d.className="dcard";
        d.innerHTML=`<div class="muted" style="font-weight:900">${esc(c.t)}</div>
                     <div style="font-size:28px;font-weight:900;margin-top:6px">${esc(c.v)}</div>`;
        box.appendChild(d);
      });
    }

    function renderWeek_(subsList, gradebookRows){
      // default
      const elSubs = document.getElementById("wk_subs");
      const elGr = document.getElementById("wk_graded");
      const elPend = document.getElementById("wk_pending");

      const now = new Date();
      const start = startOfWeekMonday_(now).getTime();

      // count subs in week (if have timestamps)
      let weekSubs = 0;
      let hasTime = false;

      (subsList || []).forEach(x=>{
        const dt =
          toDate_(x.submittedAt) ||
          toDate_(x.createdAt) ||
          toDate_(x.time) ||
          toDate_(x.ts) ||
          toDate_(x.at) ||
          null;
        if(dt){
          hasTime = true;
          if(dt.getTime() >= start) weekSubs++;
        }
      });

      // graded total (from gradebook rows) â€” some systems only have totals, no time
      const totalGraded = (gradebookRows||[]).reduce((a,x)=>a+(Number(x.graded)||0),0);

      // if no time, fallback to total submissions
      if(!hasTime){
        weekSubs = (subsList || []).length;
      }

      // pending estimate
      const pending = Math.max(0, weekSubs - totalGraded);

      elSubs.textContent = weekSubs;
      elGr.textContent = totalGraded;
      elPend.textContent = pending;
    }

    async function refresh(){
      try{
        const classId=getSelectedClass_() || document.getElementById("classId").value || "5A1";

        const students = await api("listStudents",{token,classId});
        const tasks = await api("listTasks",{token,classId,status:"PUBLISHED"});
        const subs = await api("listSubmissions",{token,classId});
        const gb = await api("getGradebook",{token,classId});

        // dÃ²ng mÃ´ táº£ lá»›p
        const sys = (students && students.system) ? students.system : {};
        const grade = sys.grade ? `Khá»‘i ${sys.grade}` : "";
        const subject = sys.subject ? `${sys.subject}` : "";
        const textbook = sys.textbook ? `${sys.textbook}` : "";

        const line = [grade, subject, textbook].filter(Boolean).join(" â€¢ ");
        document.getElementById("sub").textContent = line || "â€”";

        const graded = (gb.rows||[]).reduce((a,x)=>a+(Number(x.graded)||0),0);

        renderKpi_({
          students:(students.students||[]).length,
          tasks:(tasks.tasks||[]).length,
          submissions:(subs.submissions||[]).length,
          feedbacks:graded
        });

        // weekly summary
        renderWeek_(subs.submissions||[], gb.rows||[]);

        setLastUpdate_();
        toast("ÄÃ£ táº£i dá»¯ liá»‡u âœ…");
      }catch(e){
        toast("KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u");
      }
    }

    // Notes buttons
    document.getElementById("btnSaveNote").addEventListener("click", ()=>{
      const cid = getSelectedClass_() || document.getElementById("classId").value || "";
      saveNote_(cid);
    });
    document.getElementById("btnClearNote").addEventListener("click", ()=>{
      const cid = getSelectedClass_() || document.getElementById("classId").value || "";
      clearNote_(cid);
    });

    document.getElementById("btnRefresh").addEventListener("click", refresh);

    (async ()=>{
      // topbar (logo + menu) váº«n do teacher.js render, khÃ´ng Ä‘á»¥ng logic
      renderTeacherTopbar("dashboard");
      await loadClasses();
      await refresh();
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HEDU ‚Ä¢ Tasks & Assign</title>
  <link rel="stylesheet" href="../../assets/styles.css">
  <meta name="theme-color" content="#1a73e8"/>
  <style>
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:900;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}
    .dcard{padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .split{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;align-items:start}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    .list{display:grid;gap:10px}
    .tiny{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    textarea{min-height:140px}
  </style>
</head>
<body data-active="tasks">
  <div id="topbar"></div>

  <main class="container">
    <section class="card" style="padding:16px">
      <div class="row">
        <div>
          <h1 style="margin:0">Th∆∞ vi·ªán b√†i & Giao b√†i üìö</h1>
          <div class="muted" style="margin-top:4px">ƒê·ªß t√≠nh nƒÉng: Task Library + Assign + AI + ƒëa m√¥n/ƒëa kh·ªëi</div>
        </div>
        <div class="pill" id="me">‚Äî</div>
      </div>

      <div class="split mt">
        <!-- LEFT: editor -->
        <div class="dcard">
          <div class="row" style="margin-bottom:8px">
            <div style="font-weight:900">üß© So·∫°n b√†i / Ch·ªânh s·ª≠a</div>
            <div class="tiny" id="ctx">‚Äî</div>
          </div>

          <div class="grid2">
            <div>
              <label>L·ªõp</label>
              <input id="classId" readonly>
            </div>
            <div>
              <label>Task ID</label>
              <input id="taskId" class="mono" placeholder="T.... (t·ª± t·∫°o)" readonly>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Kh·ªëi</label>
              <select id="grade">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option>
              </select>
            </div>
            <div>
              <label>M√¥n</label>
              <input id="subject" placeholder="VD: Ti·∫øng Vi·ªát / To√°n / TNXH...">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Domain</label>
              <select id="domain">
                <option value="READING">READING</option>
                <option value="WRITING">WRITING</option>
                <option value="MATH">MATH</option>
                <option value="SCIENCE">SCIENCE</option>
                <option value="GENERAL">GENERAL</option>
              </select>
            </div>
            <div>
              <label>K·ªπ nƒÉng</label>
              <input id="skill" placeholder="VD: ƒë·ªçc hi·ªÉu, ch√≠nh t·∫£, gi·∫£i to√°n c√≥ l·ªùi vƒÉn...">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Ch·ªß ƒë·ªÅ (topic)</label>
              <input id="topic" placeholder="VD: X√°c ƒë·ªãnh √Ω ch√≠nh">
            </div>
            <div>
              <label>M·ª©c ƒë·ªô</label>
              <select id="level">
                <option value="nhan_biet">Nh·∫≠n bi·∫øt</option>
                <option value="thong_hieu">Th√¥ng hi·ªÉu</option>
                <option value="van_dung">V·∫≠n d·ª•ng</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>B√†i/Tu·∫ßn (unit)</label>
              <input id="unit" placeholder="VD: Tu·∫ßn 7 ‚Äì B√†i 2">
            </div>
            <div>
              <label>H·∫°n n·ªôp (tu·ª≥ ch·ªçn)</label>
              <input id="dueAt" type="datetime-local">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Tr·∫°ng th√°i</label>
              <select id="status">
                <option value="DRAFT">DRAFT</option>
                <option value="PUBLISHED">PUBLISHED</option>
                <option value="ARCHIVED">ARCHIVED</option>
              </select>
            </div>
            <div>
              <label>Tags</label>
              <input id="tags" placeholder="VD: √¥n t·∫≠p, gi·ªØa k·ª≥, luy·ªán vi·∫øt...">
            </div>
          </div>

          <label>N·ªôi dung b√†i</label>
          <textarea id="body" placeholder="N·ªôi dung b√†i..."></textarea>

          <label>Rubric (ch·∫•m / nh·∫≠n x√©t)</label>
          <textarea id="rubric" placeholder="Rubric..."></textarea>

          <div class="grid2">
            <div>
              <label>G·ª£i √Ω AI</label>
              <input id="constraints" placeholder="VD: ng·∫Øn g·ªçn, ph√π h·ª£p l·ªõp 4...">
            </div>
            <div>
              <label>S√°ch (textbook)</label>
              <input id="textbook" placeholder="VD: K·∫øt n·ªëi tri th·ª©c">
            </div>
          </div>

          <div class="actions mt">
            <button class="btn ghost" id="btnNew" type="button">‚ûï T·∫°o b√†i m·ªõi</button>
            <button class="btn" id="btnSave" type="button">üíæ L∆∞u DRAFT</button>
            <button class="btn ghost" id="btnPublish" type="button">üöÄ Publish</button>
          </div>

          <div class="divider"></div>

          <div class="actions">
            <button class="btn" id="btnAI" type="button">ü§ñ AI t·∫°o n·ªôi dung</button>
            <button class="btn ghost" id="btnRubricAI" type="button">üß† AI t·∫°o rubric</button>
          </div>

          <div class="muted mt" id="hint">‚Äî</div>
        </div>

        <!-- RIGHT: library -->
        <div class="dcard">
          <div style="font-weight:900">üì¶ Th∆∞ vi·ªán b√†i</div>
          <div class="tiny mt">L·ªçc / ch·ªçn b√†i ƒë·ªÉ s·ª≠a / duplicate / archive</div>

          <div class="grid2 mt">
            <div>
              <label>L·ªçc status</label>
              <select id="fStatus">
                <option value="">(T·∫•t c·∫£)</option>
                <option value="DRAFT">DRAFT</option>
                <option value="PUBLISHED">PUBLISHED</option>
                <option value="ARCHIVED">ARCHIVED</option>
              </select>
            </div>
            <div>
              <label>T√¨m nhanh</label>
              <input id="q" placeholder="taskId / topic / tag...">
            </div>
          </div>

          <div class="actions mt">
            <button class="btn" id="btnReload" type="button">T·∫£i danh s√°ch</button>
          </div>

          <div class="divider"></div>
          <div class="list" id="list"></div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <script src="../../assets/config.js"></script>
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/teacher-snippet.js"></script>
  
  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      t.hidden=false;t.textContent=msg||"‚Äî";t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show");t.hidden=true;},2400);
    }
    function esc(s){return String(s||"").replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));}
    function isoFromLocal_(v){ return v ? new Date(v).toISOString() : ""; }
    function localFromIso_(iso){
      if(!iso) return "";
      const d=new Date(iso);
      if(isNaN(d)) return "";
      const pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    const session=requireRole("TEACHER");
    const token=session?.token||"";
    const classId=localStorage.getItem("hedu_teacher_classId") || session.classId || "5A1";
    document.getElementById("classId").value=classId;
    document.getElementById("me").textContent=`${session.displayName||"Gi√°o vi√™n"} ‚Ä¢ ${classId}`;

    function newTaskId_(){ return "T"+Date.now().toString().slice(-10); }

    function setForm_(t){
      taskId.value = t.taskId || newTaskId_();
      grade.value = String(t.grade || getConfig().DEFAULT_GRADE || "5");
      subject.value = t.subject || getConfig().DEFAULT_SUBJECT || "Ti·∫øng Vi·ªát";
      textbook.value = t.textbook || getConfig().DEFAULT_BOOK || "K·∫øt n·ªëi tri th·ª©c";
      domain.value = t.domain || "GENERAL";
      skill.value = t.skill || "";
      topic.value = t.topic || "";
      level.value = t.level || "nhan_biet";
      unit.value = t.unit || "";
      dueAt.value = localFromIso_(t.dueAt || "");
      status.value = (t.status || "DRAFT").toUpperCase();
      tags.value = t.tags || "";
      body.value = t.body || "";
      rubric.value = t.rubric || "";
    }

    function getForm_(){
      return {
        taskId: taskId.value || newTaskId_(),
        grade: grade.value,
        subject: subject.value.trim(),
        textbook: textbook.value.trim(),
        domain: domain.value,
        skill: skill.value.trim(),
        topic: topic.value.trim(),
        level: level.value,
        unit: unit.value.trim(),
        dueAt: isoFromLocal_(dueAt.value),
        status: status.value,
        tags: tags.value.trim(),
        body: body.value.trim(),
        rubric: rubric.value.trim(),
        createdAt: new Date().toISOString()
      };
    }

    async function reloadList(){
      try{
        const st = fStatus.value || "";
        const qv = q.value || "";
        const r = await api("listTasks", { token, classId, status: st, q: qv });
        ctx.textContent = `Pilot ${r.system.classId} ‚Ä¢ Kh·ªëi ${r.system.grade} ‚Ä¢ ${r.system.subject} ‚Ä¢ ${r.system.textbook}`;
        const items = r.tasks || [];
        const box = document.getElementById("list");
        box.innerHTML = items.length ? "" : `<div class="muted">Ch∆∞a c√≥ task.</div>`;

        items.forEach(t=>{
          const div=document.createElement("div");
          div.className="dcard";
          div.innerHTML=`
            <div class="row">
              <div>
                <div style="font-weight:900">${esc(t.taskId)} ‚Ä¢ ${esc(t.topic||"(ch∆∞a c√≥ topic)")}</div>
                <div class="tiny">${esc(t.domain||"")} ‚Ä¢ Kh·ªëi ${esc(t.grade||"")} ‚Ä¢ ${esc(t.subject||"")} ‚Ä¢ ${esc((t.status||"").toUpperCase())}</div>
              </div>
            </div>
            <div class="actions mt">
              <button class="btn ghost" data-act="open">M·ªü</button>
              <button class="btn ghost" data-act="dup">Duplicate</button>
              <button class="btn ghost" data-act="arch">Archive</button>
            </div>
          `;
          div.querySelector('[data-act="open"]').onclick=()=>{ setForm_(t); toast("ƒê√£ m·ªü task ‚úÖ"); };
          div.querySelector('[data-act="dup"]').onclick=async ()=>{
            try{ await api("duplicateTask",{token,classId,taskId:t.taskId}); toast("ƒê√£ duplicate ‚úÖ"); await reloadList(); }
            catch(e){ toast(e.message||"Duplicate l·ªói"); }
          };
          div.querySelector('[data-act="arch"]').onclick=async ()=>{
            try{ await api("archiveTask",{token,classId,taskId:t.taskId}); toast("ƒê√£ archive ‚úÖ"); await reloadList(); }
            catch(e){ toast(e.message||"Archive l·ªói"); }
          };
          box.appendChild(div);
        });

        hint.textContent = `T·ªïng: ${items.length} task.`;
      }catch(e){
        toast(e.message||"Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch task.");
      }
    }

    btnNew.onclick=()=>{
      setForm_({ taskId:newTaskId_(), status:"DRAFT" });
      toast("T·∫°o task m·ªõi ‚úÖ");
    };

    btnSave.onclick=async ()=>{
      try{
        const t=getForm_();
        if(!t.topic) return toast("Thi·∫øu topic.");
        if(!t.body) return toast("Thi·∫øu body.");
        t.status="DRAFT";
        await api("upsertTask",{token,classId,task:t});
        toast("ƒê√£ l∆∞u DRAFT ‚úÖ");
        await reloadList();
      }catch(e){ toast(e.message||"L∆∞u l·ªói"); }
    };

    btnPublish.onclick=async ()=>{
      try{
        const t=getForm_();
        if(!t.topic) return toast("Thi·∫øu topic.");
        if(!t.body) return toast("Thi·∫øu body.");
        t.status="PUBLISHED";
        await api("upsertTask",{token,classId,task:t});
        await api("publishTask",{token,classId,taskId:t.taskId,dueAt:t.dueAt});
        toast("ƒê√£ Publish ‚úÖ");
        await reloadList();
      }catch(e){ toast(e.message||"Publish l·ªói"); }
    };

    btnAI.onclick=async ()=>{
      try{
        if(!topic.value.trim()) return toast("Nh·∫≠p topic tr∆∞·ªõc üòÑ");
        const r = await api("aiGenerateTask",{
          token,
          grade: grade.value,
          subject: subject.value.trim() || getConfig().DEFAULT_SUBJECT,
          textbook: textbook.value.trim() || getConfig().DEFAULT_BOOK,
          topic: topic.value.trim(),
          level: level.value,
          domain: domain.value,
          skill: skill.value.trim(),
          constraints: constraints.value.trim()
        });
        body.value = (r.taskText || "").trim();
        toast("AI ƒë√£ t·∫°o n·ªôi dung ‚úÖ (GV xem & ch·ªânh)");
      }catch(e){ toast(e.message||"G·ªçi AI l·ªói"); }
    };

    btnRubricAI.onclick=async ()=>{
      try{
        if(!topic.value.trim()) return toast("Nh·∫≠p topic tr∆∞·ªõc üòÑ");
        const r = await api("aiGenerateRubric",{
          token,
          grade: grade.value,
          subject: subject.value.trim() || getConfig().DEFAULT_SUBJECT,
          textbook: textbook.value.trim() || getConfig().DEFAULT_BOOK,
          topic: topic.value.trim(),
          level: level.value,
          domain: domain.value
        });
        rubric.value = (r.rubricText || "").trim();
        toast("AI ƒë√£ t·∫°o rubric ‚úÖ");
      }catch(e){ toast(e.message||"AI rubric l·ªói"); }
    };

    btnReload.onclick=reloadList;

    (async ()=>{
      renderTeacherTopbar("assignRead"); // d√πng chip "Giao b√†i" s·∫µn c√≥ trong core.js
      // init defaults
      setForm_({
        taskId:newTaskId_(),
        grade:getConfig().DEFAULT_GRADE||"5",
        subject:getConfig().DEFAULT_SUBJECT||"Ti·∫øng Vi·ªát",
        textbook:getConfig().DEFAULT_BOOK||"K·∫øt n·ªëi tri th·ª©c",
        status:"DRAFT",
        domain:"READING"
      });
      await reloadList();
    })();
  </script>
</body>
</html>

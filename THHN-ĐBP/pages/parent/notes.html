<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ph·ª• huynh ‚Ä¢ Nh·∫≠n x√©t</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <script src="../../assets/config.js"></script>

  <style>
    .container{ max-width:1100px; }

    .heroHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:2px 0 12px;border-bottom:1px dashed rgba(148,163,184,.6);margin-bottom:12px
    }
    .heroTitle{margin:0;font-size:32px;letter-spacing:-.02em}
    .heroSub{margin-top:6px;color:var(--muted)}
    .heroRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chipLite{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border:1px solid var(--line);
      border-radius:999px;background:#fff;
      font-weight:900;font-size:13px;white-space:nowrap;
      box-shadow:0 8px 22px rgba(15,23,42,.04)
    }
    .lastUpdate{font-size:12px;color:var(--muted);font-weight:800;text-align:right;white-space:nowrap}
    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}
  </style>
</head>

<body data-active="notes">
  <!-- ‚úÖ TOPBAR SSOT Parent -->
  <div id="topbar"></div>

  <main class="container">
    <section class="card" style="padding:18px;margin-top:14px">

      <div class="heroHead">
        <div>
          <h1 class="heroTitle">Nh·∫≠n x√©t c·ªßa gi√°o vi√™n</h1>
          <div class="heroSub">T·ªïng h·ª£p √Ω ki·∫øn ƒë√°nh gi√°, g√≥p √Ω trong qu√° tr√¨nh h·ªçc t·∫≠p c·ªßa h·ªçc sinh.</div>
        </div>

        <div class="heroRight">
          <div class="chips">
            <span class="chipLite">üë®‚Äçüë©‚Äçüëß Ph·ª• huynh</span>
            <span class="chipLite">üßí <strong id="studentName">‚Äî</strong></span>
            <span class="chipLite">üè∑Ô∏è <strong id="studentClass">‚Äî</strong></span>
          </div>
          <div class="lastUpdate" id="lastUpdate">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ‚Äî</div>
        </div>
      </div>

      <div class="dcard">
        <div style="font-weight:900">üì¨ Danh s√°ch nh·∫≠n x√©t</div>
        <div class="muted" style="margin-top:6px">
          Nh·∫≠n x√©t do gi√°o vi√™n g·ª≠i, gi√∫p ph·ª• huynh theo d√µi s√°t qu√° tr√¨nh h·ªçc t·∫≠p c·ªßa con.
        </div>

        <div class="divider"></div>

        <table class="table">
          <thead>
            <tr><th style="width:180px">Th·ªùi gian</th><th>N·ªôi dung nh·∫≠n x√©t</th></tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="2" style="color:var(--muted)">Ch∆∞a c√≥ d·ªØ li·ªáu‚Ä¶</td></tr>
          </tbody>
        </table>

        <div class="muted" style="margin-top:10px;font-size:12px;font-weight:800">
          ‚ÑπÔ∏è Ghi ch√∫: Nh·∫≠n x√©t ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr·ª±c ti·∫øp t·ª´ gi√°o vi√™n gi·∫£ng d·∫°y.
        </div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <!-- ‚úÖ ƒê√öNG TH·ª® T·ª∞ SSOT -->
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>

  <!-- ‚úÖ File chung Parent Topbar -->
  <script src="../../assets/parent-ui.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      if(!t) return;
      t.hidden = false;
      t.textContent = msg || "‚Äî";
      t.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>{ t.classList.remove("show"); t.hidden = true; }, 2400);
    }

    function fmt(dt){
      try{ return new Date(dt).toLocaleString('vi-VN'); }
      catch(e){ return dt || "‚Äî"; }
    }
    function fmtTime_(d){
      const pad=n=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())} - ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }

    function readSession_(){
      try{
        if(typeof getSession==="function"){
          const s = getSession();
          if(s) return s;
        }
      }catch(_){}
      try{
        const raw = localStorage.getItem("hedu_session");
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(_){ return null; }
    }

    // an to√†n: n·∫øu core.js c√≥ stripMd th√¨ d√πng, kh√¥ng c√≥ th√¨ fallback nh·∫π
    function stripMdSafe_(s){
      try{ if(typeof stripMd === "function") return stripMd(s); }catch(_){}
      return String(s||"").replace(/[*_`>#-]/g,"").trim();
    }

    (async ()=>{
      // ‚úÖ render topbar tr∆∞·ªõc ƒë·ªÉ kh√¥ng ‚Äúm·∫•t menu/logo‚Äù
      try{ window.renderParentTopbar && window.renderParentTopbar("notes"); }catch(_){}

      const s = readSession_();
      const role = String(s?.role || s?.userRole || "").toUpperCase();

      // ‚úÖ Kh√¥ng redirect c·ª©ng ‚Äì ch·ªâ b√°o nh·∫π
      if(role !== "PARENT"){
        toast("Vui l√≤ng ƒëƒÉng nh·∫≠p Ph·ª• huynh ƒë·ªÉ xem nh·∫≠n x√©t.");
        return;
      }

      const token = s.sessionId || s.token || "";
      const classId = s.classId || "";
      const studentId = s.studentId || "";

      $("studentName").textContent = s.studentName || studentId || "‚Äî";
      $("studentClass").textContent = classId || "‚Äî";
      $("lastUpdate").textContent = "C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: " + fmtTime_(new Date());

      // ‚úÖ B·ªé KH·ªêI C·∫¢NH B√ÅO (khung ƒë·ªè). N·∫øu thi·∫øu info -> ch·ªâ toast v√† gi·ªØ b·∫£ng tr·ªëng.
      if(!token || !classId || !studentId){
        toast("Thi·∫øu th√¥ng tin (l·ªõp / m√£ HS). Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i n·∫øu c·∫ßn.");
        return;
      }

      try{
        const r = await apiPost("getParentHistory", {
          token,
          classId,
          studentId,
          limit: 500
        });

        const fbs = (r.feedbacks || [])
          .filter(x => String(x.feedbackPH||"").trim())
          .sort((a,b)=> String(b.createdAt||"").localeCompare(String(a.createdAt||"")));

        const tb = $("rows");
        if(!fbs.length){
          tb.innerHTML = `<tr><td colspan="2" style="color:var(--muted)">Ch∆∞a c√≥ nh·∫≠n x√©t‚Ä¶</td></tr>`;
          return;
        }

        tb.innerHTML = fbs.slice(0,200).map(x=>`
          <tr>
            <td>${fmt(x.createdAt)}</td>
            <td style="white-space:pre-wrap;line-height:1.6">${stripMdSafe_(x.feedbackPH||"")}</td>
          </tr>
        `).join("");

      }catch(e){
        toast(e?.message || "Kh√¥ng t·∫£i ƒë∆∞·ª£c nh·∫≠n x√©t.");
      }
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HEDU â€¢ Phá»¥ huynh â€¢ Tuáº§n nÃ y</title>

  <link rel="stylesheet" href="../../assets/styles.css">
  <script src="../../assets/config.js"></script>

  <style>
    .container{max-width:1100px}

    /* HERO giá»‘ng Admin/Teacher */
    .heroHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:2px 0 12px;border-bottom:1px dashed rgba(148,163,184,.6);margin-bottom:12px
    }
    .heroTitle{margin:0;font-size:32px;letter-spacing:-.02em}
    .heroSub{margin-top:6px;color:var(--muted)}
    .heroRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chipLite{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border:1px solid var(--line);
      border-radius:999px;background:#fff;
      font-weight:900;font-size:13px;white-space:nowrap;
      box-shadow:0 8px 22px rgba(15,23,42,.04)
    }
    .lastUpdate{font-size:12px;color:var(--muted);font-weight:800;text-align:right;white-space:nowrap}

    .dcard{padding:16px;border:1px solid var(--line);border-radius:18px;background:#fff}

    /* KPI gá»n Ä‘áº¹p */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:820px){ .kpis{grid-template-columns:1fr} }
    .kpiBox{
      padding:14px 12px;border:1px solid var(--line);border-radius:14px;background:#fff;text-align:center;
    }
    .kpiBox .t{color:var(--muted);font-size:12px;font-weight:900;white-space:nowrap}
    .kpiBox .v{font-size:22px;font-weight:1000;margin-top:6px}

    /* cáº£nh bÃ¡o nhá» gá»n (khÃ´ng â€œÄ‘á» chÃ³iâ€) */
    .miniAlert{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.12);
      color:#92400e;
      font-weight:900;
      font-size:13px;
    }
    .miniAlert.show{display:block}
    .miniAlert .muted{font-weight:800;font-size:12px;margin-top:4px;color:#92400e}
  </style>
</head>

<body data-active="week">
  <!-- TOPBAR chung -->
  <div id="topbar"></div>

  <main class="container">
    <section class="card" style="padding:18px;margin-top:14px">

      <div class="heroHead">
        <div>
          <h1 class="heroTitle">Sá»• liÃªn láº¡c Ä‘iá»‡n tá»­ â€¢ 7 ngÃ y gáº§n nháº¥t</h1>
          <div class="heroSub">Tá»± tá»•ng há»£p tá»« lá»‹ch sá»­ ná»™p bÃ i vÃ  nháº­n xÃ©t Ä‘á»ƒ phá»¥ huynh theo dÃµi nhanh.</div>
        </div>

        <div class="heroRight">
          <div class="chips">
            <span class="chipLite">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Phá»¥ huynh</span>
            <span class="chipLite">ğŸ§’ <strong id="studentName">â€”</strong></span>
            <span class="chipLite">ğŸ·ï¸ <strong id="studentClass">â€”</strong></span>
          </div>
          <div class="lastUpdate" id="lastUpdate">Cáº­p nháº­t láº§n cuá»‘i: â€”</div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpiBox"><div class="t">Khoáº£ng thá»i gian</div><div class="v" id="k_week">â€”</div></div>
        <div class="kpiBox"><div class="t">BÃ i Ä‘Ã£ ná»™p</div><div class="v" id="k_sub">â€”</div></div>
        <div class="kpiBox"><div class="t">Nháº­n xÃ©t</div><div class="v" id="k_notes">â€”</div></div>
      </div>

      <div class="miniAlert" id="miniAlert">
        âš ï¸ Thiáº¿u thÃ´ng tin phiÃªn Ä‘Äƒng nháº­p
        <div class="muted">Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i tá»« Trang chá»§ Ä‘á»ƒ xem dá»¯ liá»‡u.</div>
      </div>

      <div class="dcard" style="margin-top:14px">
        <div style="font-weight:1000;font-size:16px">ğŸ“ Nháº­n xÃ©t gáº§n nháº¥t (PH)</div>

        <div class="divider"></div>

        <div class="card" style="padding:12px;background:#f8fafc;border-color:#e2e8f0">
          <div style="white-space:pre-wrap;line-height:1.6" id="teacherNote">â€”</div>
        </div>

        <div style="height:12px"></div>

        <div style="font-weight:1000;font-size:16px">ğŸ“Œ BÃ i ná»™p trong 7 ngÃ y</div>
        <div class="muted" style="margin-top:6px;font-weight:800;font-size:12px">
          Tráº¡ng thÃ¡i â€œÄÃ£ nháº­n xÃ©t/Chá» nháº­n xÃ©tâ€ Ä‘Æ°á»£c suy ra tá»« dá»¯ liá»‡u pháº£n há»“i.
        </div>

        <div class="divider"></div>

        <table class="table">
          <thead>
            <tr><th>BÃ i</th><th>Tráº¡ng thÃ¡i</th><th>Ghi chÃº</th></tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="3" style="color:var(--muted)">ChÆ°a cÃ³ dá»¯ liá»‡uâ€¦</td></tr>
          </tbody>
        </table>

        <div style="height:12px"></div>

        <div class="actions">
          <button class="btn secondary" id="btnConfirm" type="button">TÃ´i Ä‘Ã£ Ä‘á»c</button>
        </div>
        <div class="footerNote">NÃºt â€œTÃ´i Ä‘Ã£ Ä‘á»câ€ giÃºp giÃ¡o viÃªn biáº¿t phá»¥ huynh Ä‘Ã£ xem thÃ´ng tin.</div>
      </div>
    </section>

    <div class="toast" id="toast" hidden></div>
  </main>

  <!-- âœ… SSOT scripts -->
  <script src="../../assets/core.js"></script>
  <script src="../../assets/api.js"></script>
  <script src="../../assets/parent-ui.js"></script>

  <script>
    function toast(msg){
      const t=document.getElementById("toast");
      if(!t) return;
      t.hidden=false; t.textContent=msg||"â€”"; t.classList.add("show");
      clearTimeout(window.__t);
      window.__t=setTimeout(()=>{t.classList.remove("show"); t.hidden=true;},2400);
    }
    function fmt(dt){ try{return new Date(dt).toLocaleString('vi-VN');}catch(e){return dt||"â€”";} }

    function stripMdSafe_(s){
      try{ if(typeof stripMd==="function") return stripMd(s); }catch(_){}
      return String(s||"").replace(/[*_`>#-]/g,"").trim();
    }

    (async ()=>{
      // Guard Ä‘Ãºng role
      let s = null;
      try{ s = requireRole(["PARENT"]); }catch(_){}
      if(!s){
        document.getElementById("miniAlert").classList.add("show");
        toast("Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.");
        return;
      }

      // Topbar chuáº©n
      renderParentTopbar("week", s.classId || "");
      window.__PAR__ = s;

      document.getElementById("studentName").textContent = s.studentName || s.studentId || "â€”";
      document.getElementById("studentClass").textContent = s.classId || "â€”";
      document.getElementById("lastUpdate").textContent = "Cáº­p nháº­t láº§n cuá»‘i: " + fmtTimeHedu(new Date());

      const token = s.sessionId || s.token || "";
      if(!token || !s.classId || !s.studentId){
        document.getElementById("miniAlert").classList.add("show");
        return;
      }

      try{
        const rHist = await apiPost("getParentHistory", {
          token,
          classId: s.classId,
          studentId: s.studentId,
          limit: 400
        });

        const subs = rHist.submissions || [];
        const fbs  = rHist.feedbacks || [];

        const now = new Date();
        const since = new Date(now.getTime() - 7*24*3600*1000);

        const subs7 = subs.filter(x=>{
          const d = new Date(x.createdAt);
          return !isNaN(d) && d >= since;
        });

        const fbs7 = fbs.filter(x=>{
          const d = new Date(x.createdAt);
          return !isNaN(d) && d >= since;
        });

        document.getElementById("k_week").textContent = "7 ngÃ y";
        document.getElementById("k_sub").textContent = subs7.length;
        document.getElementById("k_notes").textContent = fbs7.length;

        // latest PH feedback
        const latestPH = [...fbs]
          .filter(x => String(x.feedbackPH||"").trim())
          .sort((a,b)=> String(b.createdAt||"").localeCompare(String(a.createdAt||"")))[0];

        document.getElementById("teacherNote").textContent =
          stripMdSafe_(latestPH ? latestPH.feedbackPH : "ChÆ°a cÃ³ nháº­n xÃ©t dÃ nh cho phá»¥ huynh.");

        // Table 7 ngÃ y + tráº¡ng thÃ¡i theo feedback
        const byTaskHasFeedback = new Set(
          fbs.map(x => String(x.taskId||"").trim()).filter(Boolean)
        );

        const tb = document.getElementById("rows");
        if(!subs7.length){
          tb.innerHTML = `<tr><td colspan="3" style="color:var(--muted)">7 ngÃ y gáº§n nháº¥t chÆ°a cÃ³ bÃ i ná»™pâ€¦</td></tr>`;
        }else{
          tb.innerHTML = subs7
            .sort((a,b)=> String(b.createdAt||"").localeCompare(String(a.createdAt||"")))
            .slice(0, 30)
            .map(x=>{
              const tid = String(x.taskId||"").trim();
              const hasFb = byTaskHasFeedback.has(tid);
              const badge = hasFb ? "ok" : "warn";
              const label = hasFb ? "ÄÃ£ nháº­n xÃ©t" : "Chá» nháº­n xÃ©t";
              return `<tr>
                <td>${tid || "â€”"}</td>
                <td><span class="badge ${badge}">${label}</span></td>
                <td>${fmt(x.createdAt)}</td>
              </tr>`;
            }).join("");
        }

      }catch(e){
        toast(e.message || "KhÃ´ng táº£i Ä‘Æ°á»£c bÃ¡o cÃ¡o tuáº§n.");
      }
    })();

    document.getElementById("btnConfirm").onclick = async ()=>{
      toast("ÄÃ£ ghi nháº­n âœ…");
    };
  </script>
</body>
</html>
